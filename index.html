<!doctype html>
<html lang="pt-BR" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>Cash Control - GestÃ£o Financeira Familiar</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#10b981">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Cash Control">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%2310b981' width='180' height='180'/><text x='90' y='110' font-size='90' font-weight='bold' fill='white' text-anchor='middle'>ğŸ’°</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Plus Jakarta Sans', sans-serif;
      -webkit-text-size-adjust: 100%;
      -webkit-tap-highlight-color: transparent;
    }
    .gradient-bg {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
    }
    .card-glass {
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(71, 85, 105, 0.3);
    }
    .btn-primary {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
    }
    .input-dark {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(71, 85, 105, 0.5);
    }
    .input-dark:focus {
      border-color: #10b981;
      outline: none;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
    }
    .tab-active {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background: rgba(30, 41, 59, 0.5);
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: #475569;
      border-radius: 3px;
    }
    .animate-fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .progress-ring {
      transform: rotate(-90deg);
    }
    
    /* Global improvements */
    body {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Better button sizing for touch */
    button {
      min-height: 44px;
      padding: 0.75rem;
    }
    
    /* Better input sizing */
    input, select, textarea {
      min-height: 44px;
      padding: 0.75rem;
    }
    
    /* Modal improvements */
    .fixed.inset-0 {
      overflow: auto;
    }
    
    /* BotÃ£o voltar ao topo */
    #back-to-top {
      position: fixed;
      bottom: 80px;
      right: 20px;
      z-index: 100;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s, transform 0.3s;
    }
    #back-to-top.visible {
      opacity: 1;
      transform: translateY(0);
    }
    /* Melhorias para mobile */
    @media (max-width: 640px) {
      * {
        box-sizing: border-box;
      }
      
      html, body {
        width: 100vw !important;
        overflow-x: hidden !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      
      #app, #main-screen, main {
        width: 100% !important;
        overflow-x: hidden !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      
      header {
        padding: 0.75rem 0.5rem !important;
        gap: 0.5rem !important;
      }
      
      header .max-w-7xl {
        width: 100% !important;
        max-width: 100% !important;
        padding: 0 !important;
      }
      
      header .flex {
        gap: 0.5rem !important;
        flex-wrap: wrap !important;
        align-items: center !important;
      }
      
      nav {
        padding: 0.5rem !important;
        overflow-x: auto !important;
      }
      
      main {
        padding: 0.5rem !important;
      }
      
      .max-w-7xl {
        width: 100% !important;
        max-width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
      }
      
      .card-glass {
        padding: 1rem !important;
        margin-bottom: 0.75rem !important;
        overflow: hidden !important;
        width: 100% !important;
      }
      
      .grid, [class*="grid-cols"] {
        width: 100% !important;
        grid-template-columns: 1fr !important;
        gap: 0.75rem !important;
      }
      
      .md\:grid-cols-2, .md\:grid-cols-3, .lg\:grid-cols-2, .lg\:grid-cols-3 {
        grid-template-columns: 1fr !important;
      }
      
      .text-3xl {
        font-size: 1.5rem !important;
        line-height: 1.2 !important;
      }
      
      .text-2xl {
        font-size: 1.25rem !important;
        line-height: 1.3 !important;
      }
      
      .text-xl {
        font-size: 1.1rem !important;
      }
      
      .text-lg {
        font-size: 1rem !important;
      }
      
      .p-8 {
        padding: 1rem !important;
      }
      
      .p-6 {
        padding: 0.75rem !important;
      }
      
      .p-5 {
        padding: 0.75rem !important;
      }
      
      .p-4 {
        padding: 0.75rem !important;
      }
      
      .px-4, .px-6 {
        padding-left: 0.75rem !important;
        padding-right: 0.75rem !important;
      }
      
      .py-3, .py-4 {
        padding-top: 0.75rem !important;
        padding-bottom: 0.75rem !important;
      }
      
      .gap-4 {
        gap: 0.75rem !important;
      }
      
      .gap-3 {
        gap: 0.5rem !important;
      }
      
      .gap-2 {
        gap: 0.5rem !important;
      }
      
      .flex {
        flex-wrap: wrap !important;
      }
      
      .flex-col {
        flex-direction: column !important;
      }
      
      .flex-row {
        flex-direction: row !important;
      }
      
      .mb-6, .mb-4 {
        margin-bottom: 0.75rem !important;
      }
      
      .mt-4, .mt-6 {
        margin-top: 0.75rem !important;
      }
      
      input, select, textarea {
        font-size: 16px !important;
        width: 100% !important;
        box-sizing: border-box !important;
        padding: 0.75rem !important;
        display: block !important;
        margin-bottom: 0.5rem !important;
      }
      
      button {
        width: 100% !important;
        box-sizing: border-box !important;
        padding: 0.75rem !important;
        font-size: 0.95rem !important;
        min-height: 44px !important;
        display: block !important;
      }
      
      .whitespace-nowrap {
        white-space: normal !important;
        word-break: break-word !important;
      }
      
      .truncate {
        white-space: normal !important;
        overflow: visible !important;
        text-overflow: clip !important;
      }
      
      h1, h2, h3, h4, h5 {
        word-break: break-word !important;
        overflow-wrap: break-word !important;
      }
      
      .flex-1 {
        min-width: 100% !important;
        width: 100% !important;
      }
      
      .sm\:flex-row {
        flex-direction: column !important;
      }
      
      .sm\:w-auto {
        width: 100% !important;
      }
      
      .inline-flex {
        display: flex !important;
        flex-wrap: wrap !important;
        width: 100% !important;
      }
      
      .hidden-mobile {
        display: none !important;
      }
      
      .max-h-96, .max-h-80, .max-h-64, .max-h-48 {
        max-height: none !important;
      }
      
      /* Header adjustments */
      header .max-w-7xl {
        padding: 0 !important;
        width: 100% !important;
      }
      
      header button {
        min-width: auto !important;
        padding: 0.5rem !important;
        width: auto !important;
      }
      
      header h1, header p {
        margin: 0 !important;
        overflow: visible !important;
        white-space: normal !important;
      }
      
      header div:first-child {
        flex: 1 !important;
        min-width: 0 !important;
      }
      
      /* Tabs */
      .tab-btn {
        flex-shrink: 0 !important;
        padding: 0.5rem 0.75rem !important;
        font-size: 0.85rem !important;
      }
      
      nav div {
        gap: 0.25rem !important;
      }
      
      /* Dashboard buttons */
      .dashboard-view-btn, .finance-view-btn {
        flex: 1 !important;
        padding: 0.75rem !important;
        font-size: 0.9rem !important;
        min-height: 40px !important;
      }
      
      /* Form elements spacing */
      label {
        display: block !important;
        margin-bottom: 0.25rem !important;
        font-size: 0.9rem !important;
      }
      
      /* Cards spacing */
      .space-y-3 > *, .space-y-4 > * {
        margin-bottom: 0.75rem !important;
      }
      
      .space-y-2 > * {
        margin-bottom: 0.5rem !important;
      }
    
    /* Tabs Navigation Styling */
    #tabs-container {
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }
    
    #tabs-container::-webkit-scrollbar {
      height: 4px;
    }
    
    #tabs-container::-webkit-scrollbar-track {
      background: transparent;
    }
    
    #tabs-container::-webkit-scrollbar-thumb {
      background: rgba(71, 85, 105, 0.3);
      border-radius: 2px;
    }
    
    #tabs-scroll-indicator {
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 0.6;
      }
      50% {
        opacity: 1;
      }
    }
    
    /* GrÃ¡fico de barras para categorias */
    .category-bar {
      height: 36px;
      background: rgba(71, 85, 105, 0.3);
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 12px;
      position: relative;
      display: flex;
      align-items: center;
    }
    .category-bar-fill {
      height: 100%;
      border-radius: 6px;
      background: linear-gradient(90deg, #10b981, #059669);
      transition: width 0.5s ease;
      position: relative;
      min-width: 4%;
      display: flex;
      align-items: center;
      padding: 0 10px;
    }
    .category-bar-fill.alt-color {
      background: linear-gradient(90deg, #3b82f6, #1d4ed8);
    }
    .category-bar-fill.alt-color2 {
      background: linear-gradient(90deg, #8b5cf6, #7c3aed);
    }
    .category-bar-fill.alt-color3 {
      background: linear-gradient(90deg, #f59e0b, #d97706);
    }
    .category-bar-label {
      color: white;
      font-weight: 600;
      font-size: 13px;
      z-index: 2;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .category-bar-value {
      color: white;
      font-weight: 600;
      font-size: 12px;
      z-index: 2;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      margin-left: auto;
      white-space: nowrap;
      padding-left: 8px;
    }
    .category-item {
      margin-bottom: 16px;
      padding: 0 4px;
    }
    .category-legend {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .category-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    @media (max-width: 640px) {
      .category-bar {
        height: 32px;
        margin-bottom: 10px;
      }
      .category-bar-label {
        font-size: 11px;
        gap: 4px;
      }
      .category-bar-value {
        font-size: 11px;
      }
      .category-item {
        margin-bottom: 12px;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full gradient-bg text-slate-100 overflow-auto">
  <div id="app" class="min-h-full"><!-- Login Screen -->
   <div id="login-screen" class="min-h-full flex items-center justify-center p-4">
    <div class="card-glass rounded-2xl p-8 w-full max-w-md animate-fade-in">
     <div class="text-center mb-8">
      <div class="w-20 h-20 mx-auto mb-4 rounded-2xl btn-primary flex items-center justify-center">
       <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
       </svg>
      </div>
      <h1 id="app-title" class="text-3xl font-bold text-white mb-2">Cash Control</h1>
      <p class="text-slate-400">GestÃ£o Financeira Familiar</p>
     </div>
     <div id="login-form">
      <div class="mb-4"><label class="block text-sm font-medium text-slate-300 mb-2">Email</label> <input type="email" id="login-email" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="seu@email.com">
      </div>
      <div class="mb-6"><label class="block text-sm font-medium text-slate-300 mb-2">Senha</label> <input type="password" id="login-password" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </div><button onclick="handleLogin()" class="btn-primary w-full py-3 rounded-xl font-semibold text-white mb-4 transition-all hover:shadow-lg hover:shadow-emerald-500/20"> Entrar </button> <button onclick="showRegister()" class="w-full py-3 rounded-xl font-semibold text-slate-300 border border-slate-600 hover:border-emerald-500 hover:text-emerald-400 transition-all"> Criar Conta </button>
      <div id="login-error" class="mt-4 text-red-400 text-sm text-center hidden"></div>
     </div>
     <div id="register-form" class="hidden">
      <div class="mb-4"><label class="block text-sm font-medium text-slate-300 mb-2">Nome Completo</label> <input type="text" id="register-name" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="Seu nome">
      </div>
      <div class="mb-4"><label class="block text-sm font-medium text-slate-300 mb-2">Email</label> <input type="email" id="register-email" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="seu@email.com">
      </div>
      <div class="mb-6"><label class="block text-sm font-medium text-slate-300 mb-2">Senha</label> <input type="password" id="register-password" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="MÃ­nimo 6 caracteres">
      </div><button onclick="handleRegister()" class="btn-primary w-full py-3 rounded-xl font-semibold text-white mb-4 transition-all hover:shadow-lg hover:shadow-emerald-500/20"> Criar Conta </button> <button onclick="showLogin()" class="w-full py-3 rounded-xl font-semibold text-slate-300 border border-slate-600 hover:border-emerald-500 hover:text-emerald-400 transition-all"> JÃ¡ tenho conta </button>
      <div id="register-error" class="mt-4 text-red-400 text-sm text-center hidden"></div>
     </div>
    </div>
   </div><!-- Family Selection Screen -->
   <div id="family-screen" class="min-h-full p-4 hidden">
    <div class="max-w-2xl mx-auto">
     <div class="card-glass rounded-2xl p-8 animate-fade-in">
      <div class="flex items-center justify-between mb-8">
       <div>
        <h2 class="text-2xl font-bold text-white">Suas FamÃ­lias</h2>
        <p class="text-slate-400 mt-1">Selecione ou crie uma famÃ­lia</p>
       </div><button onclick="handleLogout()" class="text-slate-400 hover:text-red-400 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg></button>
      </div>
      <div id="family-list" class="space-y-3 mb-6 max-h-80 overflow-y-auto scrollbar-thin"><!-- Families will be loaded here -->
      </div>
      <div class="border-t border-slate-700 pt-6">
       <h3 class="text-lg font-semibold text-white mb-4">Criar Nova FamÃ­lia</h3>
       <div class="flex gap-3 flex-col sm:flex-row"><input type="text" id="new-family-name" class="input-dark flex-1 px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="Nome da famÃ­lia (ex: Fonseca)"> <button onclick="createFamily()" class="btn-primary px-6 py-3 rounded-xl font-semibold text-white transition-all hover:shadow-lg hover:shadow-emerald-500/20 whitespace-nowrap"> Criar </button>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Main App Screen -->
   <div id="main-screen" class="min-h-full flex flex-col hidden"><!-- Header -->
    <header class="card-glass border-b border-slate-700/50 px-4 py-3 sticky top-0 z-50">
     <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3"><button onclick="goToFamilySelection()" class="text-slate-400 hover:text-emerald-400 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg></button>
       <div>
        <h1 class="text-xl font-bold text-white truncate max-w-[150px] sm:max-w-none" id="current-family-name">Cash Control</h1>
        <p class="text-xs text-slate-400 truncate max-w-[150px] sm:max-w-none" id="current-user-name">UsuÃ¡rio</p>
       </div>
      </div><button onclick="openSettings()" class="text-slate-400 hover:text-emerald-400 transition-colors p-2">
       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
       </svg></button>
     </div>
    </header><!-- Tab Navigation -->
    <nav class="card-glass border-b border-slate-700/50 px-4 py-2 sticky top-14 z-40">
     <div class="relative flex items-center">
      <div id="tabs-scroll-indicator-left" class="hidden absolute left-0 top-0 bottom-0 bg-gradient-to-r from-slate-900 via-slate-900 to-transparent w-12 flex items-center justify-center pointer-events-none">
       <span class="text-emerald-400 font-bold text-lg">â€¹</span>
      </div>
      <div class="max-w-7xl mx-auto flex-1 overflow-x-auto scrollbar-thin pb-1" id="tabs-container"><button onclick="switchTab('dashboard')" class="tab-btn tab-active px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all" data-tab="dashboard">ğŸ“Š Dashboard</button> <button onclick="switchTab('finances')" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap text-slate-400 hover:text-white transition-all" data-tab="finances">ğŸ’° FinanÃ§as</button> <button onclick="switchTab('commitments')" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap text-slate-400 hover:text-white transition-all" data-tab="commitments">ğŸ“‹ Compromissos</button> <button onclick="switchTab('projections')" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap text-slate-400 hover:text-white transition-all" data-tab="projections">ğŸ“ˆ ProjeÃ§Ãµes</button>
      </div>
      <div id="tabs-scroll-indicator-right" class="hidden absolute right-0 top-0 bottom-0 bg-gradient-to-l from-slate-900 via-slate-900 to-transparent w-12 flex items-center justify-center pointer-events-none">
       <span class="text-emerald-400 font-bold text-lg">â€º</span>
      </div>
     </div>
    </nav><!-- Content Area -->
    <main class="flex-1 p-4 overflow-y-auto">
     <div class="max-w-7xl mx-auto"><!-- Dashboard Tab -->
      <div id="tab-dashboard" class="tab-content animate-fade-in">
       <div class="flex gap-2 mb-6 flex-wrap"><button onclick="setDashboardView('individual')" class="dashboard-view-btn px-4 py-2 rounded-lg text-sm font-medium bg-emerald-600 text-white" data-view="individual"> ğŸ‘¤ Individual </button> <button onclick="setDashboardView('family')" class="dashboard-view-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-400 hover:text-white transition-all" data-view="family"> ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Familiar </button>
       </div>
       <div id="dashboard-content"><!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
         <div class="card-glass rounded-xl p-5">
          <div class="flex items-center justify-between mb-3"><span class="text-slate-400 text-sm">Total de Entradas</span> <span class="text-2xl">ğŸ’µ</span>
          </div>
          <p class="text-2xl font-bold text-emerald-400" id="dash-total-income">R$ 0,00</p>
          <p class="text-xs text-slate-500 mt-1">Este mÃªs</p>
         </div>
         <div class="card-glass rounded-xl p-5">
          <div class="flex items-center justify-between mb-3"><span class="text-slate-400 text-sm">Total de Despesas</span> <span class="text-2xl">ğŸ’¸</span>
          </div>
          <p class="text-2xl font-bold text-red-400" id="dash-total-expenses">R$ 0,00</p>
          <p class="text-xs text-slate-500 mt-1">Este mÃªs</p>
         </div>
         <div class="card-glass rounded-xl p-5">
          <div class="flex items-center justify-between mb-3"><span class="text-slate-400 text-sm">Saldo</span> <span class="text-2xl">ğŸ’°</span>
          </div>
          <p class="text-2xl font-bold text-blue-400" id="dash-balance">R$ 0,00</p>
          <p class="text-xs text-slate-500 mt-1">DisponÃ­vel</p>
         </div>
        </div><!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
         <div class="card-glass rounded-xl p-5">
          <h3 class="text-lg font-semibold text-white mb-4">DistribuiÃ§Ã£o por Categoria</h3>
          <div id="category-chart" class="min-h-48">
           <p class="text-slate-500 text-center py-4">Adicione despesas para ver o grÃ¡fico</p>
          </div>
         </div>
         <div class="card-glass rounded-xl p-5">
          <h3 class="text-lg font-semibold text-white mb-4">SatisfaÃ§Ã£o com SalÃ¡rio</h3>
          <div id="satisfaction-chart" class="h-48 flex items-center justify-center">
           <div class="text-center">
            <div class="relative w-32 h-32 mx-auto">
             <svg class="w-32 h-32 progress-ring"><circle cx="64" cy="64" r="56" stroke="#1e293b" stroke-width="12" fill="none" /> <circle id="satisfaction-ring" cx="64" cy="64" r="56" stroke="#10b981" stroke-width="12" fill="none" stroke-linecap="round" stroke-dasharray="351.86" stroke-dashoffset="351.86" />
             </svg>
             <div class="absolute inset-0 flex items-center justify-center"><span id="satisfaction-value" class="text-2xl font-bold text-white">0%</span>
             </div>
            </div>
            <p class="text-slate-400 mt-2 text-sm">NÃ­vel de satisfaÃ§Ã£o</p>
           </div>
          </div>
         </div>
        </div><!-- Recent Transactions -->
        <div class="card-glass rounded-xl p-5">
         <h3 class="text-lg font-semibold text-white mb-4">TransaÃ§Ãµes Recentes</h3>
         <div id="recent-transactions" class="space-y-3 max-h-64 overflow-y-auto scrollbar-thin">
          <p class="text-slate-500 text-center py-4">Nenhuma transaÃ§Ã£o registrada</p>
         </div>
        </div>
        <!-- container para divisÃµes custom aparecendo na Ã¡rea principal -->
        <div id="custom-commitments-main" class="space-y-4 mt-3">
          <!-- custom commitments serÃ£o renderizadas aqui -->
        </div>
       </div>
      </div><!-- Finances Tab -->
      <div id="tab-finances" class="tab-content hidden">
       <div class="flex gap-2 mb-6 flex-wrap"><button onclick="setFinanceView('income')" class="finance-view-btn px-4 py-2 rounded-lg text-sm font-medium bg-emerald-600 text-white" data-view="income"> ğŸ“¥ Entradas </button> <button onclick="setFinanceView('expenses')" class="finance-view-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-400 hover:text-white transition-all" data-view="expenses"> ğŸ“¤ Despesas </button> <button onclick="setFinanceView('report')" class="finance-view-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-400 hover:text-white transition-all" data-view="report"> ğŸ“Š RelatÃ³rio </button>
       </div><!-- Income View -->
       <div id="finance-income" class="finance-content animate-fade-in">
        <div class="card-glass rounded-xl p-5 mb-6">
         <div class="flex items-center justify-between mb-4 flex-col sm:flex-row gap-3">
          <h3 class="text-lg font-semibold text-white">Meus SalÃ¡rios</h3>
          <button onclick="openAddSalaryModal()" class="btn-primary px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap">
            â• Novo SalÃ¡rio
          </button>
         </div>
         <div id="salaries-list" class="space-y-3 max-h-96 overflow-y-auto scrollbar-thin">
           <!-- Salaries will be loaded here -->
         </div>
        </div>
        <div class="card-glass rounded-xl p-5 mb-6">
         <h3 class="text-lg font-semibold text-white mb-4">SatisfaÃ§Ã£o Geral</h3>
         <div class="flex items-center gap-4">
          <input type="range" id="salary-satisfaction" min="0" max="100" value="50" class="flex-1 accent-emerald-500">
          <span id="satisfaction-display" class="text-emerald-400 text-lg font-semibold whitespace-nowrap">50%</span>
         </div>
         <p class="text-slate-400 text-sm mt-2">Qual Ã© seu nÃ­vel de satisfaÃ§Ã£o com seus ganhos?</p>
         <button onclick="saveSatisfaction()" class="btn-primary mt-4 px-6 py-3 rounded-xl font-semibold text-white w-full sm:w-auto">
           Salvar SatisfaÃ§Ã£o
         </button>
        </div>
        <div class="card-glass rounded-xl p-5 mb-6">
         <h3 class="text-lg font-semibold text-white mb-4">Adicionar Ganho Extra</h3>
         <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="md:col-span-3"><label class="block text-sm font-medium text-slate-300 mb-2">DescriÃ§Ã£o</label> <input type="text" id="extra-income-desc" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="Ex: Freelance">
          </div>
          <div><label class="block text-sm font-medium text-slate-300 mb-2">Valor</label> <input type="number" id="extra-income-amount" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="0,00">
          </div>
          <div><label class="block text-sm font-medium text-slate-300 mb-2">Data</label> <input type="date" id="extra-income-date" class="input-dark w-full px-4 py-3 rounded-xl text-white">
          </div>
          <div class="md:col-span-3"><button onclick="addExtraIncome()" class="btn-primary mt-4 px-6 py-3 rounded-xl font-semibold text-white transition-all hover:shadow-lg hover:shadow-emerald-500/20 w-full"> Adicionar </button>
          </div>
         </div>
        </div>
        <div class="card-glass rounded-xl p-5">
         <h3 class="text-lg font-semibold text-white mb-4">HistÃ³rico de Entradas</h3>
         <div id="income-history" class="space-y-3 max-h-64 overflow-y-auto scrollbar-thin">
          <p class="text-slate-500 text-center py-4">Nenhuma entrada registrada</p>
         </div>
        </div>
       </div><!-- Expenses View -->
       <div id="finance-expenses" class="finance-content hidden">
        <div class="card-glass rounded-xl p-5 mb-6">
         <h3 class="text-lg font-semibold text-white mb-4">Adicionar Despesa</h3>
         <div class="grid grid-cols-1 gap-4">
          <div><label class="block text-sm font-medium text-slate-300 mb-2">DescriÃ§Ã£o</label> <input type="text" id="expense-desc" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="Ex: Conta de luz">
          </div>
          <div><label class="block text-sm font-medium text-slate-300 mb-2">Valor</label> <input type="number" id="expense-amount" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="0,00">
          </div>
          <div><label class="block text-sm font-medium text-slate-300 mb-2">Categoria</label> <select id="expense-category" class="input-dark w-full px-4 py-3 rounded-xl text-white"> <option value="moradia">ğŸ  Moradia</option> <option value="alimentacao">ğŸ½ï¸ AlimentaÃ§Ã£o</option> <option value="transporte">ğŸš— Transporte</option> <option value="saude">ğŸ¥ SaÃºde</option> <option value="educacao">ğŸ“š EducaÃ§Ã£o</option> <option value="lazer">ğŸ® Lazer</option> <option value="vestuario">ğŸ‘• VestuÃ¡rio</option> <option value="servicos">ğŸ“± ServiÃ§os</option> <option value="outros">ğŸ“¦ Outros</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-slate-300 mb-2">Data</label> <input type="date" id="expense-date" class="input-dark w-full px-4 py-3 rounded-xl text-white">
          </div>
          <div><label class="block text-sm font-medium text-slate-300 mb-2">RecorrÃªncia</label> <select id="expense-recurrence" class="input-dark w-full px-4 py-3 rounded-xl text-white"> <option value="once">Uma Ãºnica vez</option> <option value="weekly">Semanal</option> <option value="biweekly">Quinzenal</option> <option value="monthly">Mensal</option> <option value="yearly">Anual</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-slate-300 mb-2">ObservaÃ§Ãµes</label> <textarea id="expense-notes" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500 resize-none" rows="2" placeholder="Detalhes adicionais..."></textarea>
          </div>
         </div><button onclick="addExpense()" class="btn-primary mt-4 px-6 py-3 rounded-xl font-semibold text-white transition-all hover:shadow-lg hover:shadow-emerald-500/20 w-full"> Adicionar Despesa </button>
        </div>
        <div class="card-glass rounded-xl p-5">
         <div class="flex items-center justify-between mb-4 flex-col sm:flex-row gap-3">
          <h3 class="text-lg font-semibold text-white">HistÃ³rico de Despesas</h3><select id="expense-filter" onchange="filterExpenses()" class="input-dark px-3 py-2 rounded-lg text-sm text-white w-full sm:w-auto"> <option value="all">Todas</option> <option value="moradia">ğŸ  Moradia</option> <option value="alimentacao">ğŸ½ï¸ AlimentaÃ§Ã£o</option> <option value="transporte">ğŸš— Transporte</option> <option value="saude">ğŸ¥ SaÃºde</option> <option value="educacao">ğŸ“š EducaÃ§Ã£o</option> <option value="lazer">ğŸ® Lazer</option> <option value="vestuario">ğŸ‘• VestuÃ¡rio</option> <option value="servicos">ğŸ“± ServiÃ§os</option> <option value="outros">ğŸ“¦ Outros</option> </select>
         </div>
         <div id="expense-history" class="space-y-3 max-h-80 overflow-y-auto scrollbar-thin">
          <p class="text-slate-500 text-center py-4">Nenhuma despesa registrada</p>
         </div>
        </div>
       </div><!-- Report View -->
       <div id="finance-report" class="finance-content hidden">
        <div class="card-glass rounded-xl p-5 mb-6">
         <h3 class="text-lg font-semibold text-white mb-4">Gerar RelatÃ³rio</h3>
         <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div><label class="block text-sm font-medium text-slate-300 mb-2">Data Inicial</label> <input type="date" id="report-start" class="input-dark w-full px-4 py-3 rounded-xl text-white">
          </div>
          <div><label class="block text-sm font-medium text-slate-300 mb-2">Data Final</label> <input type="date" id="report-end" class="input-dark w-full px-4 py-3 rounded-xl text-white">
          </div>
          <div class="flex items-end"><button onclick="generateReport()" class="btn-primary w-full px-6 py-3 rounded-xl font-semibold text-white transition-all hover:shadow-lg hover:shadow-emerald-500/20"> Gerar </button>
          </div>
         </div>
        </div>
        <div id="report-content" class="card-glass rounded-xl p-5">
         <p class="text-slate-500 text-center py-8">Selecione um perÃ­odo e clique em "Gerar" para ver o relatÃ³rio</p>
        </div>
       </div>
      </div><!-- Commitments Tab -->
      <div id="tab-commitments" class="tab-content hidden">
       <div class="card-glass rounded-xl p-5 mb-6">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h3 class="text-lg font-semibold text-white mb-2">DivisÃ£o Percentual</h3>
            <p class="text-slate-400 text-sm">Defina como vocÃª quer dividir sua renda entre seus compromissos. O total deve ser 100%.</p>
          </div>
        </div>
        <div id="commitment-categories" class="space-y-4">
         <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl flex-col sm:flex-row"><span class="text-2xl" id="icon-expenses">ğŸ’³</span>
          <div class="flex-1 w-full sm:w-auto">
            <label class="block text-sm font-medium text-slate-300 mb-1" id="label-expenses">Gastos Gerais</label>
            <input type="number" id="commit-expenses" class="input-dark w-full px-3 py-2 rounded-lg text-white text-sm" value="70" min="0" max="100">
          </div><span class="text-slate-400">%</span>
         </div>
         <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl flex-col sm:flex-row"><span class="text-2xl" id="icon-invest">ğŸ“ˆ</span>
          <div class="flex-1 w-full sm:w-auto">
            <label class="block text-sm font-medium text-slate-300 mb-1" id="label-invest">Investimentos</label>
            <input type="number" id="commit-invest" class="input-dark w-full px-3 py-2 rounded-lg text-white text-sm" value="20" min="0" max="100">
          </div><span class="text-slate-400">%</span>
         </div>
         <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl flex-col sm:flex-row"><span class="text-2xl" id="icon-tithe">â›ª</span>
          <div class="flex-1 w-full sm:w-auto">
            <label class="block text-sm font-medium text-slate-300 mb-1" id="label-tithe">DÃ­zimo/DoaÃ§Ãµes</label>
            <input type="number" id="commit-tithe" class="input-dark w-full px-3 py-2 rounded-lg text-white text-sm" value="10" min="0" max="100">
          </div><span class="text-slate-400">%</span>
         </div>
         <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl flex-col sm:flex-row"><span class="text-2xl" id="icon-emergency">ğŸ¯</span>
          <div class="flex-1 w-full sm:w-auto">
            <label class="block text-sm font-medium text-slate-300 mb-1" id="label-emergency">Reserva de EmergÃªncia</label>
            <input type="number" id="commit-emergency" class="input-dark w-full px-3 py-2 rounded-lg text-white text-sm" value="0" min="0" max="100">
          </div><span class="text-slate-400">%</span>
         </div>
        </div>
        <div class="mt-4 p-3 bg-slate-900/50 rounded-xl">
         <div class="flex justify-between items-center"><span class="text-slate-300">Total:</span> <span id="commit-total" class="text-xl font-bold text-emerald-400">100%</span>
         </div>
        </div><button onclick="saveCommitments()" class="btn-primary mt-4 px-6 py-3 rounded-xl font-semibold text-white transition-all hover:shadow-lg hover:shadow-emerald-500/20 w-full"> Salvar DivisÃ£o </button>
       </div>
       <div class="card-glass rounded-xl p-5">
        <h3 class="text-lg font-semibold text-white mb-4">Valores Calculados</h3>
        <p class="text-slate-400 text-sm mb-4">Baseado na sua renda mensal total</p>
        <div id="commitment-values" class="grid grid-cols-1 md:grid-cols-2 gap-4">
         <div class="p-4 bg-slate-800/50 rounded-xl">
          <div class="flex items-center gap-3 mb-2"><span class="text-2xl">ğŸ’³</span> <span class="text-slate-300">Gastos Gerais</span>
          </div>
          <p class="text-2xl font-bold text-white" id="val-expenses">R$ 0,00</p>
         </div>
         <div class="p-4 bg-slate-800/50 rounded-xl">
          <div class="flex items-center gap-3 mb-2"><span class="text-2xl">ğŸ“ˆ</span> <span class="text-slate-300">Investimentos</span>
          </div>
          <p class="text-2xl font-bold text-emerald-400" id="val-invest">R$ 0,00</p>
         </div>
         <div class="p-4 bg-slate-800/50 rounded-xl">
          <div class="flex items-center gap-3 mb-2"><span class="text-2xl">â›ª</span> <span class="text-slate-300">DÃ­zimo/DoaÃ§Ãµes</span>
          </div>
          <p class="text-2xl font-bold text-purple-400" id="val-tithe">R$ 0,00</p>
         </div>
         <div class="p-4 bg-slate-800/50 rounded-xl">
          <div class="flex items-center gap-3 mb-2"><span class="text-2xl">ğŸ¯</span> <span class="text-slate-300">Reserva de EmergÃªncia</span>
          </div>
          <p class="text-2xl font-bold text-blue-400" id="val-emergency">R$ 0,00</p>
         </div>
        </div>
       </div>
      </div><!-- Projections Tab -->
      <div id="tab-projections" class="tab-content hidden">
       <div class="card-glass rounded-xl p-5 mb-6">
        <div class="flex items-center justify-between mb-4 flex-col sm:flex-row gap-3">
          <h3 class="text-lg font-semibold text-white">Meus Objetivos</h3>
          <button onclick="openAddGoalModal()" class="btn-primary px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap">
            â• Novo Objetivo
          </button>
        </div>
        <div id="goals-list" class="space-y-3">
          <!-- Goals will be loaded here -->
        </div>

        <div id="completed-goals" class="mt-4">
          <h4 class="text-sm font-semibold text-white mb-2">HistÃ³rico de objetivos concluÃ­dos</h4>
          <div id="completed-goals-list" class="space-y-2 text-slate-300">
            <p class="text-slate-500">Nenhum objetivo concluÃ­do</p>
          </div>
        </div>
       </div>
       <div id="projections-content">
<!-- Investment Options -->
        <div class="card-glass rounded-xl p-5">
         <h3 class="text-lg font-semibold text-white mb-4">OpÃ§Ãµes de Investimento</h3>
         <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="investment-options">
          <div class="p-4 bg-slate-800/50 rounded-xl">
           <div class="flex items-center gap-2 mb-2"><span class="w-3 h-3 bg-emerald-500 rounded-full"></span> <span class="font-medium text-white">SELIC</span>
           </div>
           <p class="text-slate-400 text-sm mb-2">Taxa atual: 10,75% a.a.</p>
           <p class="text-xs text-slate-500">Baixo risco, liquidez diÃ¡ria</p>
          </div>
          <div class="p-4 bg-slate-800/50 rounded-xl">
           <div class="flex items-center gap-2 mb-2"><span class="w-3 h-3 bg-blue-500 rounded-full"></span> <span class="font-medium text-white">Tesouro IPCA+</span>
           </div>
           <p class="text-slate-400 text-sm mb-2">IPCA + 5,5% a.a.</p>
           <p class="text-xs text-slate-500">ProteÃ§Ã£o contra inflaÃ§Ã£o</p>
          </div>
          <div class="p-4 bg-slate-800/50 rounded-xl">
           <div class="flex items-center gap-2 mb-2"><span class="w-3 h-3 bg-purple-500 rounded-full"></span> <span class="font-medium text-white">Tesouro Prefixado</span>
           </div>
           <p class="text-slate-400 text-sm mb-2">12,5% a.a.</p>
           <p class="text-xs text-slate-500">Taxa fixa garantida</p>
          </div>
          <div class="p-4 bg-slate-800/50 rounded-xl">
           <div class="flex items-center gap-2 mb-2"><span class="w-3 h-3 bg-yellow-500 rounded-full"></span> <span class="font-medium text-white">CDB</span>
           </div>
           <p class="text-slate-400 text-sm mb-2">110% do CDI (~11,8% a.a.)</p>
           <p class="text-xs text-slate-500">Garantido pelo FGC</p>
          </div>
          <div class="p-4 bg-slate-800/50 rounded-xl">
           <div class="flex items-center gap-2 mb-2"><span class="w-3 h-3 bg-pink-500 rounded-full"></span> <span class="font-medium text-white">LCI/LCA</span>
           </div>
           <p class="text-slate-400 text-sm mb-2">95% do CDI (~10,2% a.a.)</p>
           <p class="text-xs text-slate-500">Isento de IR</p>
          </div>
          <div class="p-4 bg-slate-800/50 rounded-xl">
           <div class="flex items-center gap-2 mb-2"><span class="w-3 h-3 bg-orange-500 rounded-full"></span> <span class="font-medium text-white">Fundos Multimercado</span>
           </div>
           <p class="text-slate-400 text-sm mb-2">CDI + 3% (~13,75% a.a.)</p>
           <p class="text-xs text-slate-500">Maior risco, maior retorno</p>
          </div>
         </div>
        </div>
       </div>
      </div>
    </main>
   </div><!-- Add Salary Modal -->
   <div id="add-salary-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="card-glass rounded-2xl p-6 w-full max-w-md animate-fade-in mx-4">
     <div class="flex items-center justify-between mb-6">
      <h2 class="text-xl font-bold text-white">Adicionar Novo SalÃ¡rio</h2>
      <button onclick="closeAddSalaryModal()" class="text-slate-400 hover:text-white transition-colors">
       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
     </div>
     <div class="space-y-4">
      <div>
       <label class="block text-sm font-medium text-slate-300 mb-2">Nome/DescriÃ§Ã£o do SalÃ¡rio</label>
       <input type="text" id="modal-salary-name" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="Ex: SalÃ¡rio Principal, Freelance">
      </div>
      <div>
       <label class="block text-sm font-medium text-slate-300 mb-2">Valor</label>
       <input type="number" id="modal-salary-amount" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="0,00" step="0.01">
      </div>
      <div>
       <label class="block text-sm font-medium text-slate-300 mb-2">FrequÃªncia</label>
       <select id="modal-salary-frequency" class="input-dark w-full px-4 py-3 rounded-xl text-white">
        <option value="monthly">Mensal</option>
        <option value="biweekly">Quinzenal</option>
        <option value="weekly">Semanal</option>
       </select>
      </div>
      <div>
       <label class="block text-sm font-medium text-slate-300 mb-2">Data de InÃ­cio</label>
       <input type="date" id="modal-salary-start" class="input-dark w-full px-4 py-3 rounded-xl text-white">
      </div>
      <div>
       <label class="block text-sm font-medium text-slate-300 mb-2">Data de TÃ©rmino (opcional)</label>
       <input type="date" id="modal-salary-end" class="input-dark w-full px-4 py-3 rounded-xl text-white">
      </div>
      <div>
       <label class="block text-sm font-medium text-slate-300 mb-2">ProjeÃ§Ã£o de Aumento (%/ano)</label>
       <input type="number" id="modal-salary-projection" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="0" step="0.1">
      </div>
      <div class="flex gap-3 pt-4 flex-col sm:flex-row">
       <button onclick="closeAddSalaryModal()" class="flex-1 py-3 rounded-xl font-semibold text-slate-300 border border-slate-600 hover:border-slate-500 transition-all">
        Cancelar
       </button>
       <button onclick="addNewSalary()" class="flex-1 py-3 rounded-xl font-semibold text-white btn-primary transition-all hover:shadow-lg hover:shadow-emerald-500/20">
        Adicionar
       </button>
      </div>
    </div>
   </div><!-- Add Goal Modal -->
   <div id="add-goal-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="card-glass rounded-2xl p-6 w-full max-w-md animate-fade-in mx-4">
     <div class="flex items-center justify-between mb-6">
      <h2 class="text-xl font-bold text-white">Adicionar Novo Objetivo</h2>
      <button onclick="closeAddGoalModal()" class="text-slate-400 hover:text-white transition-colors">
       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
     </div>
     <div class="space-y-4">
      <div>
       <label class="block text-sm font-medium text-slate-300 mb-2">Nome do Objetivo</label>
       <input type="text" id="modal-goal-name" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="Ex: Comprar um carro">
      </div>
      <div>
       <label class="block text-sm font-medium text-slate-300 mb-2">Valor Alvo (R$)</label>
       <input type="number" id="modal-goal-amount" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="100000" step="0.01">
      </div>
      <div>
       <label class="block text-sm font-medium text-slate-300 mb-2">Data de InÃ­cio (opcional)</label>
       <input type="date" id="modal-goal-start" class="input-dark w-full px-4 py-3 rounded-xl text-white">
      </div>
      <div>
       <label class="block text-sm font-medium text-slate-300 mb-2">Data Limite (opcional)</label>
       <input type="date" id="modal-goal-deadline" class="input-dark w-full px-4 py-3 rounded-xl text-white">
      </div>
      <div>
       <label class="block text-sm font-medium text-slate-300 mb-2">DescriÃ§Ã£o (opcional)</label>
       <textarea id="modal-goal-description" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500 resize-none" rows="2" placeholder="Detalhes sobre o objetivo..."></textarea>
      </div>
      <div class="flex gap-3 pt-4 flex-col sm:flex-row">
       <button onclick="closeAddGoalModal()" class="flex-1 py-3 rounded-xl font-semibold text-slate-300 border border-slate-600 hover:border-slate-500 transition-all">
        Cancelar
       </button>
       <button onclick="addNewGoal()" class="flex-1 py-3 rounded-xl font-semibold text-white btn-primary transition-all hover:shadow-lg hover:shadow-emerald-500/20">
        Adicionar
       </button>
      </div>
     </div>
    </div>
   </div><!-- Settings Modal -->
   <div id="settings-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="card-glass rounded-2xl p-6 w-full max-w-lg max-h-[90%] overflow-y-auto animate-fade-in mx-4">
     <div class="flex items-center justify-between mb-6">
      <h2 class="text-xl font-bold text-white">ConfiguraÃ§Ãµes da FamÃ­lia</h2><button onclick="closeSettings()" class="text-slate-400 hover:text-white transition-colors">
       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
       </svg></button>
     </div>
     <div id="settings-owner-section">
      <div class="mb-6">
       <h3 class="text-lg font-semibold text-white mb-3">Membros da FamÃ­lia</h3>
       <div id="family-members" class="space-y-2 mb-4 max-h-40 overflow-y-auto scrollbar-thin"><!-- Members will be loaded here -->
       </div>
      </div>
      <div class="mb-6">
       <h3 class="text-lg font-semibold text-white mb-3">Adicionar Membro</h3>
       <div class="flex gap-2 flex-col sm:flex-row"><input type="email" id="add-member-email" class="input-dark flex-1 px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="email@exemplo.com"> <button onclick="addFamilyMember()" class="btn-primary px-4 py-3 rounded-xl font-semibold text-white whitespace-nowrap"> Adicionar </button>
       </div>
       <p class="text-slate-500 text-xs mt-2">O usuÃ¡rio precisa ter uma conta no Cash Control</p>
      </div>
      <div class="mb-6">
       <h3 class="text-lg font-semibold text-white mb-3">Validar Acesso de Membro</h3>
       <div class="flex gap-2 flex-col sm:flex-row"><input type="email" id="validate-member-email" class="input-dark flex-1 px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="email@membro.com"> <button onclick="validateMemberLogin()" class="btn-primary px-4 py-3 rounded-xl font-semibold text-white whitespace-nowrap"> Validar </button>
       </div>
       <p class="text-slate-500 text-xs mt-2">Confirme se um membro tem acesso Ã  famÃ­lia</p>
      </div>
      <div class="border-t border-slate-700 pt-6">
       <h3 class="text-lg font-semibold text-red-400 mb-3">Zona de Perigo</h3><button onclick="confirmDeleteFamily()" class="w-full py-3 rounded-xl font-semibold text-red-400 border border-red-500/50 hover:bg-red-500/10 transition-all"> Excluir FamÃ­lia </button>
      </div>
     </div>
     <div id="settings-member-section" class="hidden">
      <p class="text-slate-400 text-center py-4">Apenas o chefe da famÃ­lia pode gerenciar os membros.</p><button onclick="leaveFamily()" class="w-full py-3 rounded-xl font-semibold text-red-400 border border-red-500/50 hover:bg-red-500/10 transition-all mt-4"> Sair da FamÃ­lia </button>
     </div>
    </div>
   </div><!-- Delete Confirmation Modal -->
   <div id="delete-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="card-glass rounded-2xl p-6 w-full max-w-md animate-fade-in mx-4">
     <div class="text-center mb-6">
      <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500/20 flex items-center justify-center">
       <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
       </svg>
      </div>
      <h3 class="text-xl font-bold text-white mb-2">Confirmar ExclusÃ£o</h3>
      <p class="text-slate-400" id="delete-message">Tem certeza que deseja excluir?</p>
     </div>
     <div class="flex gap-3 flex-col sm:flex-row"><button onclick="closeDeleteModal()" class="flex-1 py-3 rounded-xl font-semibold text-slate-300 border border-slate-600 hover:border-slate-500 transition-all"> Cancelar </button> <button onclick="confirmDelete()" class="flex-1 py-3 rounded-xl font-semibold text-white bg-red-600 hover:bg-red-700 transition-all"> Excluir </button>
     </div>
    </div>
   </div><!-- Toast Notification -->
   <div id="toast" class="fixed bottom-4 right-4 z-50 hidden">
    <div class="card-glass rounded-xl px-4 py-3 flex items-center gap-3 animate-fade-in"><span id="toast-icon" class="text-xl">âœ…</span> <span id="toast-message" class="text-white">OperaÃ§Ã£o realizada com sucesso!</span>
    </div>
   </div><!-- BotÃ£o Voltar ao Topo -->
   <button id="back-to-top" class="card-glass rounded-full p-3 text-emerald-400 hover:text-white hover:bg-emerald-500/20 transition-all shadow-lg">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
    </svg>
   </button>
  </div>
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCsuSqpgmrch50wSSuvXe9v52R4Ztd1wkQ",
      authDomain: "cash-control-ef893.firebaseapp.com",
      projectId: "cash-control-ef893",
      storageBucket: "cash-control-ef893.firebasestorage.app",
      messagingSenderId: "417040011479",
      appId: "1:417040011479:web:173351e135d28ab1f9e092",
      measurementId: "G-S27QHKQ6C0"
    };
    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // App State
    let currentUser = null;
    let currentFamily = null;
    let currentFamilyData = null;
    let dashboardView = 'individual';
    let deleteCallback = null;
    
    // Default Config
    const defaultConfig = {
      app_title: 'Cash Control'
    };
    
    let config = { ...defaultConfig };
    
    // Element SDK Integration
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (newConfig) => {
          config = { ...defaultConfig, ...newConfig };
          document.getElementById('app-title').textContent = config.app_title;
        },
        mapToCapabilities: (cfg) => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (cfg) => new Map([
          ['app_title', cfg.app_title || defaultConfig.app_title]
        ])
      });
    }
    
    // Auth State Observer
    auth.onAuthStateChanged((user) => {
      if (user) {
        currentUser = user;
        showFamilySelection();
      } else {
        currentUser = null;
        showLogin();
      }
    });
    
    // UI Navigation Functions
    function showLogin() {
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('family-screen').classList.add('hidden');
      document.getElementById('main-screen').classList.add('hidden');
      document.getElementById('login-form').classList.remove('hidden');
      document.getElementById('register-form').classList.add('hidden');
      hideBackToTop();
    }
    
    function showRegister() {
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('register-form').classList.remove('hidden');
      hideBackToTop();
    }
    
    function showFamilySelection() {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('family-screen').classList.remove('hidden');
      document.getElementById('main-screen').classList.add('hidden');
      loadUserFamilies();
      hideBackToTop();
    }
    
    function showMainApp() {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('family-screen').classList.add('hidden');
      document.getElementById('main-screen').classList.remove('hidden');
      loadFamilyData();
      initBackToTop();
      initTabsScrollIndicator();
    }
    
    function goToFamilySelection() {
      currentFamily = null;
      currentFamilyData = null;
      showFamilySelection();
    }
    
    // Auth Functions
    async function handleLogin() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const errorEl = document.getElementById('login-error');
      
      try {
        errorEl.classList.add('hidden');
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        
        // Validate user credentials and access rights
        const isValidUser = await validateUserCredentials(userCredential.user);
        
        if (isValidUser) {
          showToast('âœ…', 'Login realizado com sucesso!');
        } else {
          console.warn('User logged in but credentials validation failed');
          showToast('âš ï¸', 'Login bem-sucedido. Aguarde validaÃ§Ã£o das credenciais.');
        }
      } catch (error) {
        errorEl.textContent = getErrorMessage(error.code);
        errorEl.classList.remove('hidden');
      }
    }
    
    // Validate user credentials after login
    async function validateUserCredentials(user) {
      try {
        // Check if user document exists
        const userDoc = await db.collection('users').doc(user.uid).get();
        
        if (!userDoc.exists) {
          console.warn(`User document not found for ${user.email}`);
          return false;
        }
        
        const userData = userDoc.data();
        
        // Verify email matches
        if (userData.email !== user.email) {
          console.warn('Email mismatch for user:', user.uid);
          return false;
        }
        
        // Log successful validation
        console.log(`User ${user.email} credentials validated successfully`);
        return true;
      } catch (error) {
        console.error('Error validating user credentials:', error);
        return false;
      }
    }
    
    // Validate member login - helper function for family owners
    async function validateMemberLogin() {
      if (!currentFamily || !currentFamilyData) {
        showToast('âš ï¸', 'Selecione uma famÃ­lia primeiro');
        return;
      }
      
      if (currentFamilyData.ownerId !== currentUser.uid) {
        showToast('âš ï¸', 'Apenas o chefe pode validar membros');
        return;
      }
      
      const memberEmail = document.getElementById('validate-member-email').value.trim();
      if (!memberEmail) {
        showToast('âš ï¸', 'Digite o email do membro');
        return;
      }
      
      try {
        // Check if member exists in the family
        const familyDoc = await db.collection('families').doc(currentFamily).get();
        if (!familyDoc.exists) {
          showToast('âŒ', 'FamÃ­lia nÃ£o encontrada');
          return;
        }
        
        const familyData = familyDoc.data();
        const members = familyData.members || [];
        
        if (!members.includes(memberEmail)) {
          showToast('âŒ', `${memberEmail} nÃ£o Ã© membro da famÃ­lia`);
          return;
        }
        
        // Check if user exists
        const userQuery = await db.collection('users').where('email', '==', memberEmail).get();
        if (userQuery.empty) {
          showToast('âŒ', `UsuÃ¡rio com email ${memberEmail} nÃ£o encontrado`);
          return;
        }
        
        const userData = userQuery.docs[0].data();
        
        // Verify access
        const hasValidAccess = await validateMemberAccess(currentFamily, userQuery.docs[0].id, memberEmail);
        
        if (hasValidAccess) {
          showToast('âœ…', `${userData.name || memberEmail} tem acesso Ã  famÃ­lia!`);
        } else {
          showToast('âš ï¸', `${userData.name || memberEmail} foi adicionado mas pode precisar fazer login novamente`);
        }
        
        document.getElementById('validate-member-email').value = '';
      } catch (error) {
        console.error('Error validating member:', error);
        showToast('âŒ', 'Erro ao validar membro');
      }
    }
    
    async function handleRegister() {
      const name = document.getElementById('register-name').value;
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;
      const errorEl = document.getElementById('register-error');
      
      if (!name || !email || !password) {
        errorEl.textContent = 'Preencha todos os campos';
        errorEl.classList.remove('hidden');
        return;
      }
      
      try {
        errorEl.classList.add('hidden');
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        await userCredential.user.updateProfile({ displayName: name });
        
        // Create user document
        await db.collection('users').doc(userCredential.user.uid).set({
          name: name,
          email: email,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showToast('âœ…', 'Conta criada com sucesso!');
      } catch (error) {
        errorEl.textContent = getErrorMessage(error.code);
        errorEl.classList.remove('hidden');
      }
    }
    
    function handleLogout() {
      auth.signOut();
      showToast('ğŸ‘‹', 'AtÃ© logo!');
    }

    // UI Navigation: Dashboard View
    function setDashboardView(view) {
      window.dashboardView = view;
      document.querySelectorAll('.dashboard-view-btn').forEach(b => b.classList.remove('bg-emerald-600', 'text-white'));
      const btn = document.querySelector(`.dashboard-view-btn[data-view="${view}"]`);
      if (btn) btn.classList.add('bg-emerald-600', 'text-white');
      if (typeof updateDashboard === 'function') updateDashboard();
    }

    // UI Navigation: Finance View
    function setFinanceView(view) {
      document.querySelectorAll('.finance-content').forEach(el => el.classList.add('hidden'));
      const target = document.getElementById(`finance-${view}`);
      if (target) target.classList.remove('hidden');
      
      document.querySelectorAll('.finance-view-btn').forEach(b => b.classList.remove('bg-emerald-600', 'text-white'));
      const btn = document.querySelector(`.finance-view-btn[data-view="${view}"]`);
      if (btn) btn.classList.add('bg-emerald-600', 'text-white');

      if (view === 'income' && typeof loadSalariesList === 'function') loadSalariesList();
      else if (view === 'expenses') {
        // load expenses if needed
      }
    }

    // Commitment Edit Toggle
    // Commitment Edit Toggle removed

    // Income/Expense/Commitment loaders
    async function loadIncomeHistory() {
      if (!currentFamily || !currentUser) return;
      try {
        const query = db.collection('transactions')
          .where('familyId', '==', currentFamily)
          .where('type', '==', 'income')
          .where('userId', '==', currentUser.uid)
          .orderBy('date', 'desc')
          .limit(50);
        const snap = await query.get();
        const container = document.getElementById('income-history');
        if (!container) return;
        
        if (snap.empty) {
          container.innerHTML = '<p class="text-slate-500 text-center py-4">Nenhum ganho extra registrado</p>';
          return;
        }
        
        container.innerHTML = snap.docs.map(doc => {
          const inc = doc.data();
          return `
            <div class="flex justify-between items-center p-3 bg-slate-800/30 rounded-lg" data-income-id="${doc.id}">
              <div class="min-w-0 flex-1 mr-2">
                <p class="text-white font-medium truncate">${inc.description}</p>
                <p class="text-slate-400 text-xs">${inc.date || ''}</p>
              </div>
              <div class="flex items-center gap-2 flex-shrink-0">
                <p class="font-semibold text-green-400 whitespace-nowrap">+ ${(typeof formatCurrency === 'function') ? formatCurrency(inc.amount) : 'R$ '+inc.amount.toFixed(2)}</p>
                <button onclick="deleteTransaction('${doc.id}')" class="text-red-400 hover:text-red-300 font-semibold text-sm">ğŸ—‘ï¸</button>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading income history:', error);
      }
    }

    async function loadExpenseHistory() {
      if (!currentFamily || !currentUser) return;
      try {
        const query = db.collection('transactions')
          .where('familyId', '==', currentFamily)
          .where('type', '==', 'expense')
          .where('userId', '==', currentUser.uid)
          .orderBy('date', 'desc')
          .limit(50);
        const snap = await query.get();
        const container = document.getElementById('expense-history');
        if (!container) return;
        
        if (snap.empty) {
          container.innerHTML = '<p class="text-slate-500 text-center py-4">Nenhuma despesa registrada</p>';
          return;
        }
        
        container.innerHTML = snap.docs.map(doc => {
          const exp = doc.data();
          return `
            <div class="flex justify-between items-center p-3 bg-slate-800/30 rounded-lg" data-category="${exp.category || 'outros'}">
              <div class="min-w-0 flex-1 mr-2">
                <p class="text-white font-medium truncate">${exp.description}</p>
                <p class="text-slate-400 text-xs">${exp.date || ''}</p>
              </div>
              <div class="flex items-center gap-2 flex-shrink-0">
                <p class="font-semibold text-red-400 whitespace-nowrap">- ${(typeof formatCurrency === 'function') ? formatCurrency(exp.amount) : 'R$ '+exp.amount.toFixed(2)}</p>
                <button onclick="deleteTransaction('${doc.id}')" class="text-red-400 hover:text-red-300 font-semibold text-sm">ğŸ—‘ï¸</button>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading expense history:', error);
      }
    }

    // Delete transaction (income or expense)
    async function deleteTransaction(docId) {
      if (!confirm('Deseja remover esta transaÃ§Ã£o?')) return;
      try {
        await db.collection('transactions').doc(docId).delete();
        if (typeof showToast === 'function') showToast('âœ…', 'TransaÃ§Ã£o removida');
        if (typeof loadIncomeHistory === 'function') await loadIncomeHistory();
        if (typeof loadExpenseHistory === 'function') await loadExpenseHistory();
        if (typeof updateDashboard === 'function') updateDashboard();
      } catch (error) {
        console.error('Error deleting transaction:', error);
        if (typeof showToast === 'function') showToast('âŒ', 'Erro ao remover');
      }
    }

    // Filter expenses by category
    function filterExpenses() {
      const filter = document.getElementById('expense-filter').value;
      const container = document.getElementById('expense-history');
      if (!container) return;
      
      const items = container.querySelectorAll('[data-category]');
      items.forEach(item => {
        if (filter === 'all' || item.getAttribute('data-category') === filter) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    }

    // loadCommitmentNames removed - function no longer needed

    async function loadGoalsList() {
      if (!currentFamily || !currentUser) return;
      try {
        const query = db.collection('goals')
          .where('familyId', '==', currentFamily)
          .where('userId', '==', currentUser.uid);
        const snap = await query.get();
        const goalsContainer = document.getElementById('goals-list');
        // cache goals for client calculations
        window._goalsCache = window._goalsCache || {};

        if (goalsContainer) {
          if (snap.empty) {
            goalsContainer.innerHTML = '<p class="text-slate-500 text-center py-4">Nenhuma meta cadastrada</p>';
          } else {
            const html = [];
            snap.forEach(doc => {
              const g = doc.data();
              // skip goals already concluded (filter on client side to avoid index creation)
              if (g.completed) return;
              const id = doc.id;
              window._goalsCache[id] = { progress: Number(g.progress || 0), target: Number(g.targetAmount || 0) };
              const progress = ((g.progress || 0) / (g.targetAmount || 1)) * 100;

              html.push(`
                <div class="p-4 bg-slate-800/40 rounded-lg" id="goal-${id}">
                  <div class="flex items-center justify-between mb-2">
                    <strong class="text-white truncate">${g.name}</strong>
                    <span class="text-xs text-slate-400 whitespace-nowrap">${Math.min(progress, 100).toFixed(0)}%</span>
                  </div>
                  <div class="w-full bg-slate-700 rounded-full h-2 mb-2">
                    <div class="bg-emerald-500 h-2 rounded-full" style="width: ${Math.min(progress, 100)}%"></div>
                  </div>
                  <p class="text-sm text-slate-300">${(typeof formatCurrency === 'function') ? formatCurrency(g.progress || 0) : 'R$ '+(g.progress || 0).toFixed(2)} / ${(typeof formatCurrency === 'function') ? formatCurrency(g.targetAmount) : 'R$ '+(g.targetAmount || 0).toFixed(2)}</p>
                  ${g.deadline ? `<p class="text-xs text-slate-500 mt-1">AtÃ© ${g.deadline}</p>` : ''}

                  <div class="mt-3 p-3 bg-slate-800/30 rounded-lg">
                    <h5 class="text-sm font-semibold text-slate-200 mb-2">Estimativa com Aportes Mensais</h5>
                    <div class="flex flex-col sm:flex-row gap-2 mb-2 items-start sm:items-center">
                      <input type="number" min="0" step="0.01" id="goal-monthly-${id}" class="input-dark px-3 py-2 rounded-lg text-white text-sm w-full sm:w-44 goal-monthly" placeholder="Aporte mensal (R$)">
                      <button onclick="computeEstimatesForGoal('${id}')" class="px-3 py-2 rounded-lg text-sm bg-emerald-600 text-white w-full sm:w-auto">Calcular</button>
                      <button onclick="useAllInvestmentForGoal('${id}')" class="px-3 py-2 rounded-lg text-sm bg-slate-600 text-white w-full sm:w-auto">Usar todo investimento</button>
                    </div>
                    <div id="goal-estimates-${id}" class="space-y-2 text-sm text-slate-300">
                      <!-- estimates will render here -->
                      <p class="text-slate-500">Insira um aporte mensal e clique em Calcular</p>
                    </div>
                  </div>

                  <div class="mt-3 flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                    <input type="number" min="0" step="0.01" id="goal-add-${id}" class="input-dark px-3 py-2 rounded-lg text-white text-sm w-full sm:w-44" placeholder="Adicionar valor"/>
                    <button onclick="addToGoalProgress('${id}')" class="px-3 py-2 rounded-lg text-sm bg-emerald-600 text-white w-full sm:w-auto">Adicionar</button>
                  </div>

                  <div class="mt-3 flex gap-2 flex-col sm:flex-row">
                    <button onclick="completeGoal('${id}')" class="px-3 py-2 rounded-lg text-sm bg-blue-600 text-white w-full sm:w-auto">Concluir</button>
                    <button onclick="deleteGoal('${id}')" class="px-3 py-2 rounded-lg text-sm bg-red-600 text-white w-full sm:w-auto">Excluir</button>
                  </div>
                </div>
              `);
            });

            goalsContainer.innerHTML = html.join('');

            // attach listeners to monthly inputs (enter key also triggers)
            document.querySelectorAll('.goal-monthly').forEach(input => {
              input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                  const id = input.id.replace('goal-monthly-', '');
                  computeEstimatesForGoal(id);
                }
              });
              // mark user-edited so automatic distribution won't overwrite
              input.addEventListener('input', () => {
                input.dataset.userEdited = '1';
                const id = input.id.replace('goal-monthly-', '');
                // live update estimates while typing
                computeEstimatesForGoal(id);
              });
            });

            // load concluded goals history (if any)
            if (typeof loadCompletedGoals === 'function') loadCompletedGoals();
          }
        }
      } catch (error) {
        console.error('Error loading goals:', error);
      }
    }

    // Income Functions
    async function saveSatisfaction() {
      if (!currentFamily || !currentUser) {
        if (typeof showToast === 'function') showToast('âš ï¸', 'Selecione uma famÃ­lia');
        return;
      }
      const satisfaction = document.getElementById('salary-satisfaction').value || 50;
      try {
        await db.collection('finances').doc(`${currentFamily}_satisfaction_${currentUser.uid}`).set({
          familyId: currentFamily,
          userId: currentUser.uid,
          satisfaction: Number(satisfaction),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        if (typeof showToast === 'function') showToast('âœ…', 'SatisfaÃ§Ã£o salva!');
      } catch (error) {
        console.error('Error saving satisfaction:', error);
        if (typeof showToast === 'function') showToast('âŒ', 'Erro ao salvar');
      }
    }

    async function addExtraIncome() {
      if (!currentFamily || !currentUser) {
        if (typeof showToast === 'function') showToast('âš ï¸', 'Selecione uma famÃ­lia');
        return;
      }
      const desc = document.getElementById('extra-income-desc').value.trim();
      const amount = Number(document.getElementById('extra-income-amount').value) || 0;
      const date = document.getElementById('extra-income-date').value;

      if (!desc || amount <= 0 || !date) {
        if (typeof showToast === 'function') showToast('âš ï¸', 'Preencha todos os campos');
        return;
      }

      try {
        await db.collection('transactions').add({
          familyId: currentFamily,
          userId: currentUser.uid,
          userName: currentUser.displayName || currentUser.email,
          type: 'income',
          description: desc,
          amount: amount,
          date: date,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('extra-income-desc').value = '';
        document.getElementById('extra-income-amount').value = '';
        document.getElementById('extra-income-date').value = '';
        if (typeof showToast === 'function') showToast('âœ…', 'Ganho extra adicionado!');
        if (typeof loadIncomeHistory === 'function') await loadIncomeHistory();
        if (typeof updateDashboard === 'function') updateDashboard();
      } catch (error) {
        console.error('Error adding extra income:', error);
        if (typeof showToast === 'function') showToast('âŒ', 'Erro ao adicionar');
      }
    }

    // Expense Functions
    async function addExpense() {
      if (!currentFamily || !currentUser) {
        if (typeof showToast === 'function') showToast('âš ï¸', 'Selecione uma famÃ­lia');
        return;
      }
      const desc = document.getElementById('expense-desc').value.trim();
      const category = document.getElementById('expense-category').value;
      const amount = Number(document.getElementById('expense-amount').value) || 0;
      const date = document.getElementById('expense-date').value;

      if (!desc || !category || amount <= 0 || !date) {
        if (typeof showToast === 'function') showToast('âš ï¸', 'Preencha todos os campos');
        return;
      }

      try {
        await db.collection('transactions').add({
          familyId: currentFamily,
          userId: currentUser.uid,
          userName: currentUser.displayName || currentUser.email,
          type: 'expense',
          description: desc,
          category: category,
          amount: amount,
          date: date,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('expense-desc').value = '';
        document.getElementById('expense-category').value = '';
        document.getElementById('expense-amount').value = '';
        document.getElementById('expense-date').value = '';
        if (typeof showToast === 'function') showToast('âœ…', 'Despesa adicionada!');
        if (typeof loadExpenseHistory === 'function') await loadExpenseHistory();
        if (typeof updateDashboard === 'function') updateDashboard();
      } catch (error) {
        console.error('Error adding expense:', error);
        if (typeof showToast === 'function') showToast('âŒ', 'Erro ao adicionar');
      }
    }

    // Commitment Names Edit
    // saveCommitmentNames removed - function no longer needed

    // Goal Modal & Functions
    function openAddGoalModal() {
      const modal = document.getElementById('add-goal-modal');
      if (!modal) return;

      // If modal is inside a hidden container, move it to body so it's always visible
      if (modal.parentNode !== document.body) document.body.appendChild(modal);

      // ensure salary modal is fully hidden (inline style to avoid stacking issues)
      const salaryModal = document.getElementById('add-salary-modal');
      if (salaryModal) {
        salaryModal.style.display = 'none';
        salaryModal.classList.add('hidden');
      }

      // reset fields
      const nameInput = document.getElementById('modal-goal-name');
      if (nameInput) nameInput.value = '';
      const amountInput = document.getElementById('modal-goal-amount');
      if (amountInput) amountInput.value = '';
      const deadlineInput = document.getElementById('modal-goal-deadline');
      if (deadlineInput) deadlineInput.value = '';

      // show modal with inline styles to ensure visibility
      modal.style.display = 'flex';
      modal.classList.remove('hidden');
      modal.style.zIndex = 10000;
      modal.style.pointerEvents = 'auto';

      // focus first input for accessibility
      setTimeout(() => { try { nameInput && nameInput.focus(); } catch (e) {} }, 50);
    }

    function closeAddGoalModal() {
      const modal = document.getElementById('add-goal-modal');
      if (modal) {
        modal.style.display = 'none';
        modal.classList.add('hidden');
      }
    }

    async function addNewGoal() {
      if (!currentFamily || !currentUser) {
        if (typeof showToast === 'function') showToast('âš ï¸', 'Selecione uma famÃ­lia');
        return;
      }
      const name = document.getElementById('modal-goal-name').value.trim();
      const amount = Number(document.getElementById('modal-goal-amount').value) || 0;
      const start = document.getElementById('modal-goal-start').value;
      const deadline = document.getElementById('modal-goal-deadline').value;

      if (!name || amount <= 0) {
        if (typeof showToast === 'function') showToast('âš ï¸', 'Preencha nome e valor');
        return;
      }

      try {
        await db.collection('goals').add({
          familyId: currentFamily,
          userId: currentUser.uid,
          userName: currentUser.displayName || currentUser.email,
          name: name,
          targetAmount: amount,
          startDate: start || null,
          deadline: deadline || null,
          progress: 0,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        closeAddGoalModal();
        if (typeof showToast === 'function') showToast('âœ…', 'Meta adicionada!');
        if (typeof loadGoalsList === 'function') await loadGoalsList();
      } catch (error) {
        console.error('Error adding goal:', error);
        if (typeof showToast === 'function') showToast('âŒ', 'Erro ao adicionar meta');
      }
    }

    // Settings & Family Management
    async function openSettings() {
      try {
        const modal = document.getElementById('settings-modal');
        if (!modal) {
          console.error('Settings modal not found');
          showToast('âŒ', 'Erro: Modal nÃ£o encontrado');
          return;
        }
        
        // Mostrar o modal imediatamente
        modal.classList.remove('hidden');
        
        // Carregar dados em paralelo se disponÃ­vel
        if (currentFamily && currentFamilyData && db) {
          try {
            await loadFamilyMembersForSettings();
          } catch (error) {
            console.warn('Could not load family members:', error);
            // Continua mesmo se falhar ao carregar membros
          }
        }
      } catch (error) {
        console.error('Error opening settings:', error);
        showToast('âŒ', 'Erro ao abrir configuraÃ§Ãµes');
      }
    }

    function closeSettings() {
      const modal = document.getElementById('settings-modal');
      if (modal) {
        modal.classList.add('hidden');
      }
    }

    async function loadFamilyMembersForSettings() {
      if (!currentFamily || !currentFamilyData) {
        console.warn('Family data not available');
        return;
      }
      
      try {
        const familyDoc = await db.collection('families').doc(currentFamily).get();
        if (!familyDoc.exists) {
          console.warn('Family document not found');
          return;
        }
        
        const data = familyDoc.data();
        const isOwner = data.ownerId === currentUser.uid;
        
        // Update UI based on role
        const ownerSection = document.getElementById('settings-owner-section');
        const memberSection = document.getElementById('settings-member-section');
        
        if (isOwner) {
          if (ownerSection) ownerSection.classList.remove('hidden');
          if (memberSection) memberSection.classList.add('hidden');
          
          // Load member list
          await loadFamilyMembersList(data.members || []);
        } else {
          if (ownerSection) ownerSection.classList.add('hidden');
          if (memberSection) memberSection.classList.remove('hidden');
        }
      } catch (error) {
        console.error('Error loading family members:', error);
      }
    }
    
    async function loadFamilyMembersList(memberEmails) {
      const membersContainer = document.getElementById('family-members');
      if (!membersContainer) return;
      
      try {
        membersContainer.innerHTML = '<p class="text-slate-500 text-center py-4">Carregando membros...</p>';
        
        if (memberEmails.length === 0) {
          membersContainer.innerHTML = '<p class="text-slate-500 text-center py-4">Nenhum membro adicional</p>';
          return;
        }
        
        const membersList = [];
        for (const memberEmail of memberEmails) {
          try {
            // Query user by email
            const userQuery = await db.collection('users').where('email', '==', memberEmail).get();
            if (!userQuery.empty) {
              const userDoc = userQuery.docs[0];
              membersList.push({
                id: userDoc.id,
                email: memberEmail,
                ...userDoc.data()
              });
            }
          } catch (e) {
            console.error('Error loading member:', e);
          }
        }
        
        if (membersList.length === 0) {
          membersContainer.innerHTML = '<p class="text-slate-500 text-center py-4">Nenhum membro adicional</p>';
          return;
        }
        
        membersContainer.innerHTML = membersList.map(member => `
          <div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg">
            <div>
              <p class="text-white font-medium">${member.name || 'UsuÃ¡rio'}</p>
              <p class="text-slate-400 text-sm">${member.email}</p>
            </div>
            <button onclick="removeFamilyMember('${member.email}')" class="text-red-400 hover:text-red-300 transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          </div>
        `).join('');
      } catch (error) {
        membersContainer.innerHTML = '<p class="text-red-400 text-center py-4">Erro ao carregar membros</p>';
        console.error('Error loading members list:', error);
      }
    }
    
    async function removeFamilyMember(memberEmail) {
      if (!currentFamily || currentFamilyData.ownerId !== currentUser.uid) {
        showToast('âš ï¸', 'Apenas o chefe pode remover membros');
        return;
      }
      
      if (!confirm('Deseja remover este membro da famÃ­lia?')) return;
      
      try {
        await db.collection('families').doc(currentFamily).update({
          members: firebase.firestore.FieldValue.arrayRemove(memberEmail)
        });
        showToast('âœ…', 'Membro removido com sucesso');
        loadFamilyMembersForSettings();
      } catch (error) {
        showToast('âŒ', 'Erro ao remover membro');
        console.error('Error removing member:', error);
      }
    }

    async function addFamilyMember() {
      if (!currentFamily || !currentFamilyData) {
        if (typeof showToast === 'function') showToast('âš ï¸', 'Selecione uma famÃ­lia');
        return;
      }
      if (currentFamilyData.ownerId !== currentUser.uid) {
        if (typeof showToast === 'function') showToast('âš ï¸', 'Apenas o chefe pode adicionar membros');
        return;
      }
      const email = document.getElementById('add-member-email').value.trim();
      if (!email) {
        if (typeof showToast === 'function') showToast('âš ï¸', 'Digite um email');
        return;
      }
      try {
        const usersQuery = await db.collection('users').where('email', '==', email).get();
        if (usersQuery.empty) {
          if (typeof showToast === 'function') showToast('âš ï¸', 'UsuÃ¡rio nÃ£o encontrado');
          return;
        }
        const userId = usersQuery.docs[0].id;
        const userData = usersQuery.docs[0].data();
        const userEmail = userData.email;
        
        const familyRef = db.collection('families').doc(currentFamily);
        
        // Validate and add member with both userId and email for access verification
        await validateAndAddMember(familyRef, userId, userEmail, currentFamily);
        
        document.getElementById('add-member-email').value = '';
        if (typeof showToast === 'function') showToast('âœ…', 'Membro adicionado com sucesso!');
        loadFamilyMembersForSettings();
      } catch (error) {
        console.error('Error adding member:', error);
        if (typeof showToast === 'function') showToast('âŒ', 'Erro ao adicionar membro');
      }
    }

    // Validate and add member with credentials verification
    async function validateAndAddMember(familyRef, userId, userEmail, familyId) {
      try {
        // Verify that user exists and has valid credentials
        const userDoc = await db.collection('users').doc(userId).get();
        if (!userDoc.exists) {
          throw new Error('UsuÃ¡rio nÃ£o encontrado na base de dados');
        }
        
        const userData = userDoc.data();
        
        // Add member using email for compatibility with existing queries
        await familyRef.update({
          members: firebase.firestore.FieldValue.arrayUnion(userEmail)
        });
        
        // Also store member info for validation purposes
        const memberData = {
          familyId: familyId,
          userId: userId,
          userEmail: userEmail,
          userName: userData.name || 'UsuÃ¡rio',
          addedAt: firebase.firestore.FieldValue.serverTimestamp(),
          status: 'active',
          validated: true
        };
        
        // Create a member access log for audit purposes
        await db.collection('family_members').add(memberData);
        
        console.log(`Member ${userEmail} validated and added to family ${familyId}`);
      } catch (error) {
        console.error('Error validating member:', error);
        throw error;
      }
    }

    function confirmDeleteFamily() {
      if (currentFamilyData && currentFamilyData.ownerId !== currentUser.uid) {
        if (typeof showToast === 'function') showToast('âš ï¸', 'Apenas o chefe pode excluir');
        return;
      }
      const modal = document.getElementById('delete-modal');
      if (modal) modal.classList.remove('hidden');
    }

    function leaveFamily() {
      if (!currentFamily) return;
      if (confirm('Tem certeza que deseja sair desta famÃ­lia?')) {
        db.collection('families').doc(currentFamily).update({
          members: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
        }).then(() => {
          if (typeof showToast === 'function') showToast('âœ…', 'VocÃª saiu da famÃ­lia');
          goToFamilySelection();
        }).catch(error => {
          console.error('Error leaving family:', error);
          if (typeof showToast === 'function') showToast('âŒ', 'Erro ao sair');
        });
      }
    }

    function closeDeleteModal() {
      const modal = document.getElementById('delete-modal');
      if (modal) modal.classList.add('hidden');
    }

    async function confirmDelete() {
      if (!currentFamily || !currentFamilyData) {
        if (typeof showToast === 'function') showToast('âš ï¸', 'Nenhuma famÃ­lia selecionada');
        return;
      }
      if (currentFamilyData.ownerId !== currentUser.uid) {
        if (typeof showToast === 'function') showToast('âš ï¸', 'Apenas o chefe pode excluir');
        return;
      }
      try {
        await db.collection('families').doc(currentFamily).delete();
        closeDeleteModal();
        if (typeof showToast === 'function') showToast('âœ…', 'FamÃ­lia excluÃ­da!');
        goToFamilySelection();
      } catch (error) {
        console.error('Error deleting family:', error);
        if (typeof showToast === 'function') showToast('âŒ', 'Erro ao excluir');
      }
    }

    // Report Export (placeholder)
    function exportReportToCSV(startDate, endDate) {
      if (typeof showToast === 'function') showToast('â„¹ï¸', 'ExportaÃ§Ã£o em desenvolvimento');
      console.log('Export report:', startDate, endDate);
    }

    function getErrorMessage(code) {
      const messages = {
        'auth/invalid-email': 'Email invÃ¡lido',
        'auth/user-disabled': 'UsuÃ¡rio desativado',
        'auth/user-not-found': 'UsuÃ¡rio nÃ£o encontrado',
        'auth/wrong-password': 'Senha incorreta',
        'auth/email-already-in-use': 'Email jÃ¡ estÃ¡ em uso',
        'auth/weak-password': 'Senha muito fraca (mÃ­nimo 6 caracteres)',
        'auth/invalid-credential': 'Credenciais invÃ¡lidas'
      };
      return messages[code] || 'Erro ao processar. Tente novamente.';
    }
    
    // Family Functions
    async function loadUserFamilies() {
      if (!currentUser) return;
      
      const familyList = document.getElementById('family-list');
      familyList.innerHTML = '<p class="text-slate-500 text-center py-4">Carregando...</p>';
      
      try {
        // Get families where user is owner
        const ownedFamilies = await db.collection('families')
          .where('ownerId', '==', currentUser.uid)
          .get();
        
        // Get families where user is member (using email for compatibility)
        const memberFamilies = await db.collection('families')
          .where('members', 'array-contains', currentUser.email)
          .get();
        
        // Validate credentials for member access
        const validatedFamilies = [];
        
        // Validate owned families
        for (const doc of ownedFamilies.docs) {
          validatedFamilies.push({ id: doc.id, ...doc.data(), isOwner: true, validated: true });
        }
        
        // Validate member access through credentials
        for (const doc of memberFamilies.docs) {
          // Skip if already added as owner
          if (!validatedFamilies.find(f => f.id === doc.id)) {
            // Verify member access is valid
            const isValidMember = await validateMemberAccess(doc.id, currentUser.uid, currentUser.email);
            if (isValidMember) {
              validatedFamilies.push({ id: doc.id, ...doc.data(), isOwner: false, validated: true });
            }
          }
        }
        
        const families = validatedFamilies;
        
        if (families.length === 0) {
          familyList.innerHTML = '<p class="text-slate-500 text-center py-4">VocÃª ainda nÃ£o tem famÃ­lias. Crie uma abaixo!</p>';
          return;
        }
        
        familyList.innerHTML = families.map(family => `
          <button onclick="selectFamily('${family.id}')" class="w-full p-4 bg-slate-800/50 hover:bg-slate-700/50 rounded-xl flex items-center justify-between transition-all group">
            <div class="flex items-center gap-3">
              <span class="text-2xl">${family.isOwner ? 'ğŸ‘‘' : 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦'}</span>
              <div class="text-left min-w-0">
                <p class="font-medium text-white group-hover:text-emerald-400 transition-colors truncate">${family.name}</p>
                <p class="text-xs text-slate-500">${family.isOwner ? 'VocÃª Ã© o chefe' : 'Membro'}</p>
              </div>
            </div>
            <svg class="w-5 h-5 text-slate-500 group-hover:text-emerald-400 transition-colors flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </button>
        `).join('');
      } catch (error) {
        familyList.innerHTML = '<p class="text-red-400 text-center py-4">Erro ao carregar famÃ­lias</p>';
        console.error('Error loading families:', error);
      }
    }
    
    // Validate member access credentials
    async function validateMemberAccess(familyId, userId, userEmail) {
      try {
        // Check if member is in the family's members array
        const familyDoc = await db.collection('families').doc(familyId).get();
        if (!familyDoc.exists) {
          console.warn(`Family ${familyId} not found`);
          return false;
        }
        
        const members = familyDoc.data().members || [];
        
        // Check if user email is in members array
        if (members.includes(userEmail)) {
          // Additional validation: check if member record exists and is validated
          const memberRecords = await db.collection('family_members')
            .where('familyId', '==', familyId)
            .where('userEmail', '==', userEmail)
            .where('status', '==', 'active')
            .get();
          
          if (!memberRecords.empty) {
            return true;
          }
          
          // If no member record but email is in array, consider it valid for backward compatibility
          console.log(`Member ${userEmail} in family ${familyId} without validation record (legacy)`);
          return true;
        }
        
        return false;
      } catch (error) {
        console.error('Error validating member access:', error);
        return false;
      }
    }
    
    async function createFamily() {
      const nameInput = document.getElementById('new-family-name');
      const name = nameInput.value.trim();
      
      if (!name) {
        showToast('âš ï¸', 'Digite o nome da famÃ­lia');
        return;
      }
      
      const collectionName = `Cash Control_${name.toLowerCase().replace(/\s+/g, '_')}`;
      
      try {
        await db.collection('families').add({
          name: name,
          collectionName: collectionName,
          ownerId: currentUser.uid,
          ownerEmail: currentUser.email,
          ownerName: currentUser.displayName || 'UsuÃ¡rio',
          members: [],
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        nameInput.value = '';
        showToast('âœ…', `FamÃ­lia "${name}" criada!`);
        loadUserFamilies();
      } catch (error) {
        showToast('âŒ', 'Erro ao criar famÃ­lia');
        console.error('Error creating family:', error);
      }
    }
    
    async function selectFamily(familyId) {
      currentFamily = familyId;
      
      try {
        const doc = await db.collection('families').doc(familyId).get();
        if (doc.exists) {
          currentFamilyData = { id: doc.id, ...doc.data() };
          document.getElementById('current-family-name').textContent = currentFamilyData.name;
          document.getElementById('current-user-name').textContent = currentUser.displayName || currentUser.email;
          showMainApp();
        }
      } catch (error) {
        showToast('âŒ', 'Erro ao selecionar famÃ­lia');
        console.error('Error selecting family:', error);
      }
    }
    
    // Toast Notification
    function showToast(icon, message) {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-4 right-4 bg-slate-900 border border-slate-700 rounded-lg px-6 py-3 text-white max-w-sm animate-fade-in z-50';
      toast.textContent = `${icon} ${message}`;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'fadeOut 0.3s ease-out forwards';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Dashboard Update com grÃ¡fico de barras
    async function updateDashboard() {
      if (!currentFamily || !currentUser) return;
      try {
        const isFamily = (window.dashboardView === 'family');
        let incomeQuery, expenseQuery;
        
        if (isFamily) {
          incomeQuery = db.collection('transactions')
            .where('familyId', '==', currentFamily)
            .where('type', 'in', ['income', 'salary']);
          expenseQuery = db.collection('transactions')
            .where('familyId', '==', currentFamily)
            .where('type', '==', 'expense');
        } else {
          incomeQuery = db.collection('transactions')
            .where('familyId', '==', currentFamily)
            .where('type', 'in', ['income', 'salary'])
            .where('userId', '==', currentUser.uid);
          expenseQuery = db.collection('transactions')
            .where('familyId', '==', currentFamily)
            .where('type', '==', 'expense')
            .where('userId', '==', currentUser.uid);
        }

        const incomeSnap = await incomeQuery.get();
        const expenseSnap = await expenseQuery.get();
        
        // Load satisfaction
        let satisfaction = 50;
        if (!isFamily) {
          const satSnap = await db.collection('finances')
            .doc(`${currentFamily}_satisfaction_${currentUser.uid}`).get();
          if (satSnap.exists && satSnap.data().satisfaction !== undefined) {
            satisfaction = satSnap.data().satisfaction;
          }
        }
        
        let totalIncome = 0, totalExpenses = 0;
        const txList = [];

        incomeSnap.forEach(doc => {
          const data = doc.data();
          totalIncome += Number(data.amount || 0);
          txList.push({ ...data, id: doc.id });
        });

        expenseSnap.forEach(doc => {
          const data = doc.data();
          totalExpenses += Number(data.amount || 0);
          txList.push({ ...data, id: doc.id });
        });

        const balance = totalIncome - totalExpenses;

        // Update summary cards
        const incomeEl = document.getElementById('dash-total-income');
        const expenseEl = document.getElementById('dash-total-expenses');
        const balanceEl = document.getElementById('dash-balance');

        if (incomeEl) incomeEl.textContent = (typeof formatCurrency === 'function') ? formatCurrency(totalIncome) : 'R$ '+totalIncome.toFixed(2);
        if (expenseEl) expenseEl.textContent = (typeof formatCurrency === 'function') ? formatCurrency(totalExpenses) : 'R$ '+totalExpenses.toFixed(2);
        if (balanceEl) {
          balanceEl.textContent = (typeof formatCurrency === 'function') ? formatCurrency(balance) : 'R$ '+balance.toFixed(2);
          balanceEl.className = 'text-2xl font-bold ' + (balance >= 0 ? 'text-blue-400' : 'text-red-400');
        }

        // Update recent transactions
        const txContainer = document.getElementById('recent-transactions');
        if (txContainer) {
          if (txList.length === 0) {
            txContainer.innerHTML = '<p class="text-slate-500 text-center py-4">Nenhuma transaÃ§Ã£o</p>';
          } else {
            txContainer.innerHTML = txList.sort((a, b) => (b.date || '').localeCompare(a.date || '')).slice(0, 5).map(tx => `
              <div class="flex justify-between items-center p-3 bg-slate-800/30 rounded-lg">
                <div class="min-w-0 flex-1 mr-2">
                  <p class="text-white font-medium truncate">${tx.description || tx.type}</p>
                  <p class="text-slate-400 text-xs">${tx.date || ''}</p>
                </div>
                <p class="font-semibold ${tx.type === 'expense' ? 'text-red-400' : 'text-emerald-400'} whitespace-nowrap">
                  ${tx.type === 'expense' ? '- ' : '+ '}${(typeof formatCurrency === 'function') ? formatCurrency(tx.amount) : 'R$ '+tx.amount.toFixed(2)}
                </p>
              </div>
            `).join('');
          }
        }
        
        // Update category chart with bars
        const categoryChart = document.getElementById('category-chart');
        if (categoryChart) {
          const categoryTotals = {};

          // helper to parse currency text from elements like 'R$ 1.234,56'
          function parseCurrencyText(id) {
            const el = document.getElementById(id);
            if (!el) return 0;
            const txt = (el.textContent || '').trim();
            // remove currency symbols and spaces, replace comma with dot
            const numeric = txt.replace(/[R$\s\.]/g, '').replace(',', '.');
            const v = Number(numeric) || 0;
            return v;
          }

          // Primary: read values from commitments summary
          const mainItems = [
            {key: 'despesas', label: 'Despesas', icon: 'ğŸ’³', value: parseCurrencyText('val-expenses'), colorClass: ''},
            {key: 'investimentos', label: 'Investimentos', icon: 'ğŸ“ˆ', value: parseCurrencyText('val-invest'), colorClass: 'alt-color'},
            {key: 'dizimo', label: 'DÃ­zimo/DoaÃ§Ãµes', icon: 'â›ª', value: parseCurrencyText('val-tithe'), colorClass: 'alt-color2'},
            {key: 'emergencia', label: 'Reserva de EmergÃªncia', icon: 'ğŸ¯', value: parseCurrencyText('val-emergency'), colorClass: 'alt-color3'}
          ];

          mainItems.forEach(it => { 
            if (it.value > 0) categoryTotals[it.key] = { 
              label: it.label, 
              icon: it.icon, 
              value: it.value,
              colorClass: it.colorClass
            }; 
          });

          // include custom commitments (rendered as elements with id starting with val-custom-)
          document.querySelectorAll('[id^="val-custom-"]').forEach(el => {
            try {
              const key = el.id.replace('val-custom-', '');
              const value = parseCurrencyText(el.id);
              const parent = el.closest('[data-custom-name]');
              const name = parent ? parent.getAttribute('data-custom-name') : key;
              const icon = parent ? parent.querySelector('.text-2xl')?.textContent || 'ğŸ“¦' : 'ğŸ“¦';
              if (value > 0) categoryTotals[key] = { 
                label: name, 
                icon: icon, 
                value,
                colorClass: ''
              };
            } catch (e) {}
          });

          // If no commitments values found, fallback to expense transactions distribution
          const totalFromCommitments = Object.values(categoryTotals).reduce((s, c) => s + Number(c.value || 0), 0);
          if (totalFromCommitments === 0 && expenseSnap) {
            expenseSnap.forEach(doc => {
              const data = doc.data();
              const category = data.category || 'outros';
              if (!categoryTotals[category]) {
                categoryTotals[category] = { 
                  label: getCategoryLabel(category), 
                  icon: getCategoryIcon(category), 
                  value: 0,
                  colorClass: ''
                };
              }
              categoryTotals[category].value += Number(data.amount || 0);
            });
          }

          if (Object.keys(categoryTotals).length === 0) {
            categoryChart.innerHTML = '<p class="text-slate-500 text-center py-8">Nenhuma despesa registrada</p>';
          } else {
            // convert to array and sort
            const arr = Object.keys(categoryTotals).map(k => {
              const v = categoryTotals[k];
              if (typeof v === 'number') return { 
                key: k, 
                label: getCategoryLabel(k), 
                icon: getCategoryIcon(k), 
                value: v,
                colorClass: ''
              };
              return { 
                key: k, 
                label: v.label || k, 
                icon: v.icon || getCategoryIcon(k), 
                value: v.value || 0,
                colorClass: v.colorClass || ''
              };
            }).sort((a, b) => b.value - a.value);

            const total = arr.reduce((s, it) => s + Number(it.value || 0), 0);

            // Create bar chart
            categoryChart.innerHTML = arr.map((it, index) => {
              const percentage = total > 0 ? Math.round((it.value/total)*1000)/10 : 0;
              const width = total > 0 ? Math.max(4, (it.value/total)*100) : 0;
              
              return `
                <div class="category-item">
                  <div class="category-legend">
                    <span class="text-lg">${it.icon}</span>
                    <span class="text-slate-300 text-sm font-medium">${it.label}</span>
                    <span class="text-slate-400 text-sm ml-auto">${percentage}%</span>
                  </div>
                  <div class="category-bar">
                    <div class="category-bar-fill ${it.colorClass}" style="width: ${width}%">
                      <span class="category-bar-label">${it.icon} ${it.label}</span>
                      <span class="category-bar-value">${formatCurrency(it.value)}</span>
                    </div>
                  </div>
                </div>
              `;
            }).join('');
          }
        }

        function getCategoryLabel(cat) {
          const labels = {
            'moradia': 'Moradia',
            'alimentacao': 'AlimentaÃ§Ã£o',
            'transporte': 'Transporte',
            'saude': 'SaÃºde',
            'educacao': 'EducaÃ§Ã£o',
            'lazer': 'Lazer',
            'vestuario': 'VestuÃ¡rio',
            'servicos': 'ServiÃ§os',
            'outros': 'Outros'
          };
          return labels[cat] || cat;
        }

        function getCategoryIcon(cat) {
          const icons = {
            'moradia': 'ğŸ ',
            'alimentacao': 'ğŸ½ï¸',
            'transporte': 'ğŸš—',
            'saude': 'ğŸ¥',
            'educacao': 'ğŸ“š',
            'lazer': 'ğŸ®',
            'vestuario': 'ğŸ‘•',
            'servicos': 'ğŸ“±',
            'outros': 'ğŸ“¦'
          };
          return icons[cat] || 'ğŸ“¦';
        }
        
        // Update satisfaction display
        const satisfactionEl = document.getElementById('satisfaction-value');
        const satisfactionRing = document.getElementById('satisfaction-ring');
        if (satisfactionEl) satisfactionEl.textContent = satisfaction + '%';
        if (satisfactionRing) {
          const circumference = 2 * Math.PI * 56;
          const offset = circumference - (satisfaction / 100) * circumference;
          satisfactionRing.style.strokeDashoffset = offset;
        }
        
        // Also update the slider if visible
        const slider = document.getElementById('salary-satisfaction');
        if (slider) slider.value = satisfaction;
        const display = document.getElementById('satisfaction-display');
        if (display) display.textContent = satisfaction + '%';
      } catch (error) {
        console.error('Error updating dashboard:', error);
      }
    }
    
    // Data Loading
    async function loadFamilyData() {
      if (!currentFamily || !currentFamilyData) return;
      
      try {
        // Load commitments
        const commitDoc = await db.collection('finances')
          .doc(`${currentFamily}_commitments_${currentUser.uid}`).get();
        if (commitDoc.exists) {
          const data = commitDoc.data();
          document.getElementById('commit-expenses').value = data.expenses || 70;
          document.getElementById('commit-invest').value = data.invest || 20;
          document.getElementById('commit-tithe').value = data.tithe || 10;
          document.getElementById('commit-emergency').value = data.emergency || 0;
        }
        
        // Load and display data
        await loadSalariesList();
        await loadIncomeHistory();
        await loadExpenseHistory();
        await loadCustomCommitments();
        await loadGoalsList();
        updateDashboard();
        updateCommitmentValues();
      } catch (error) {
        console.error('Error loading family data:', error);
      }
    }
    
    // Salary satisfaction slider
    document.getElementById('salary-satisfaction').addEventListener('input', function() {
      document.getElementById('satisfaction-display').textContent = this.value + '%';
    });
    
    // Commitment total calculator
    ['commit-expenses', 'commit-invest', 'commit-tithe', 'commit-emergency'].forEach(id => {
      document.getElementById(id).addEventListener('input', updateCommitmentTotal);
      document.getElementById(id).addEventListener('input', updateCommitmentValues); // ADD THIS
    });

    // helper para gerar ids seguros
function sanitizeKey(name) {
  return name.replace(/\s+/g, '-').replace(/[^a-z0-9\-]/gi, '').toLowerCase();
}

// UI: trocar abas (tab navigation)
function switchTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
  const target = document.getElementById(`tab-${tabName}`);
  if (target) target.classList.remove('hidden');

  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
  const btn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
  if (btn) btn.classList.add('tab-active');

  // carregar dados especÃ­ficos da aba quando necessÃ¡rio
  if (tabName === 'finances') {
    if (typeof loadSalariesList === 'function') loadSalariesList();
    if (typeof loadIncomeHistory === 'function') loadIncomeHistory();
    if (typeof loadExpenseHistory === 'function') loadExpenseHistory();
  } else if (tabName === 'dashboard') {
    if (typeof updateDashboard === 'function') updateDashboard();
  }
}

// Estado para ediÃ§Ã£o de salÃ¡rio
let _editingSalaryId = null;

// Lista de salÃ¡rios: busca e renderiza na Ã¡rea `#salaries-list`
async function loadSalariesList() {
  const el = document.getElementById('salaries-list');
  if (!el) return;
  if (!currentFamily) {
    el.innerHTML = '<p class="text-slate-500 text-center py-4">Selecione uma famÃ­lia</p>';
    return;
  }

  el.innerHTML = '<p class="text-slate-500 text-center py-4">Carregando salÃ¡rios...</p>';

  try {
    const query = db.collection('transactions')
      .where('familyId', '==', currentFamily)
      .where('type', '==', 'salary');

    const snap = await query.get();
    if (snap.empty) {
      el.innerHTML = '<p class="text-slate-500 text-center py-4">Nenhum salÃ¡rio cadastrado</p>';
      return;
    }

    const html = [];
    snap.forEach(doc => {
      const s = doc.data();
      const monthly = (typeof calculateMonthlySalary === 'function') ? calculateMonthlySalary(s.amount, s.frequency) : (Number(s.amount) || 0);
      html.push(`
        <div class="flex items-center justify-between p-3 bg-slate-800/40 rounded-lg flex-col sm:flex-row gap-2">
          <div class="w-full sm:w-auto">
            <div class="flex items-center gap-2"><strong class="text-white">${s.description || 'SalÃ¡rio'}</strong> <span class="text-slate-400 text-sm">(${s.frequency || 'mensal'})</span></div>
            <div class="text-slate-400 text-sm">${s.startDate || ''}${s.endDate ? ' â†’ '+s.endDate : ''}</div>
          </div>
          <div class="text-right w-full sm:w-auto">
            <div class="font-semibold text-white">${(typeof formatCurrency === 'function') ? formatCurrency(monthly) : 'R$ '+monthly.toFixed(2)}</div>
            <div class="text-slate-400 text-sm mt-1"><button onclick="editSalary('${doc.id}')" class="text-emerald-400 mr-2">Editar</button><button onclick="deleteSalary('${doc.id}')" class="text-red-400">Remover</button></div>
          </div>
        </div>
      `);
    });

    el.innerHTML = html.join('');
  } catch (error) {
    console.error('Error loading salaries list:', error);
    el.innerHTML = '<p class="text-red-400 text-center py-4">Erro ao carregar salÃ¡rios</p>';
  }
}

function openAddSalaryModal() {
  _editingSalaryId = null;

  // ensure goal modal is fully hidden to avoid stacking issues
  const goalModal = document.getElementById('add-goal-modal');
  if (goalModal) {
    goalModal.style.display = 'none';
    goalModal.classList.add('hidden');
  }

  // reset salary fields
  document.getElementById('modal-salary-name').value = '';
  document.getElementById('modal-salary-amount').value = '';
  document.getElementById('modal-salary-frequency').value = 'monthly';
  document.getElementById('modal-salary-start').value = '';
  document.getElementById('modal-salary-end').value = '';
  document.getElementById('modal-salary-projection').value = '';

  // show salary modal (inline style ensures it's on top)
  const salaryModal = document.getElementById('add-salary-modal');
  salaryModal.style.display = 'flex';
  salaryModal.classList.remove('hidden');
  salaryModal.style.zIndex = 10000;

  setTimeout(() => { try { document.getElementById('modal-salary-name').focus(); } catch (e) {} }, 50);
}

function closeAddSalaryModal() {
  const modal = document.getElementById('add-salary-modal');
  if (modal) {
    modal.style.display = 'none';
    modal.classList.add('hidden');
  }
  _editingSalaryId = null;
}

async function addNewSalary() {
  if (!currentFamily || !currentUser) {
    if (typeof showToast === 'function') showToast('âš ï¸', 'Selecione uma famÃ­lia e faÃ§a login');
    return;
  }

  const description = document.getElementById('modal-salary-name').value.trim();
  const amount = Number(document.getElementById('modal-salary-amount').value) || 0;
  const frequency = document.getElementById('modal-salary-frequency').value;
  const startDate = document.getElementById('modal-salary-start').value || '';
  const endDate = document.getElementById('modal-salary-end').value || '';
  const projection = Number(document.getElementById('modal-salary-projection').value) || 0;

  if (!description || amount <= 0) {
    if (typeof showToast === 'function') showToast('âš ï¸', 'Preencha nome e valor');
    return;
  }

  const payload = {
    familyId: currentFamily,
    userId: currentUser.uid,
    userName: currentUser.displayName || currentUser.email,
    type: 'salary',
    description,
    amount,
    frequency,
    startDate,
    endDate: endDate || null,
    projection,
    isActive: true,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  try {
    if (_editingSalaryId) {
      await db.collection('transactions').doc(_editingSalaryId).set({ ...payload, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
      if (typeof showToast === 'function') showToast('âœ…', 'SalÃ¡rio atualizado');
    } else {
      await db.collection('transactions').add(payload);
      if (typeof showToast === 'function') showToast('âœ…', 'SalÃ¡rio adicionado');
    }
    closeAddSalaryModal();
    await loadSalariesList();
    if (typeof updateCommitmentValues === 'function') updateCommitmentValues();
  } catch (error) {
    console.error('Error saving salary:', error);
    if (typeof showToast === 'function') showToast('âŒ', 'Erro ao salvar salÃ¡rio');
  }
}

async function editSalary(id) {
  try {
    const doc = await db.collection('transactions').doc(id).get();
    if (!doc.exists) return;
    const s = doc.data();
    _editingSalaryId = id;
    document.getElementById('modal-salary-name').value = s.description || '';
    document.getElementById('modal-salary-amount').value = s.amount || '';
    document.getElementById('modal-salary-frequency').value = s.frequency || 'monthly';
    document.getElementById('modal-salary-start').value = s.startDate || '';
    document.getElementById('modal-salary-end').value = s.endDate || '';
    document.getElementById('modal-salary-projection').value = s.projection || '';
    document.getElementById('add-salary-modal').classList.remove('hidden');
  } catch (error) {
    console.error('Error editing salary:', error);
  }
}

async function deleteSalary(id) {
  if (!confirm('Deseja remover este salÃ¡rio?')) return;
  try {
    await db.collection('transactions').doc(id).delete();
    if (typeof showToast === 'function') showToast('âœ…', 'SalÃ¡rio removido');
    await loadSalariesList();
    if (typeof updateCommitmentValues === 'function') updateCommitmentValues();
  } catch (error) {
    console.error('Error deleting salary:', error);
    if (typeof showToast === 'function') showToast('âŒ', 'Erro ao remover salÃ¡rio');
  }
}

// Fallback helpers (somente se nÃ£o existirem)
if (typeof calculateMonthlySalary !== 'function') {
  function calculateMonthlySalary(amount, frequency) {
    const a = Number(amount) || 0;
    switch ((frequency || '').toLowerCase()) {
      case 'weekly': return a * 52 / 12;
      case 'biweekly': return a * 26 / 12;
      case 'monthly':
      default: return a;
    }
  }
}

if (typeof formatCurrency !== 'function') {
  function formatCurrency(value) {
    const n = Number(value) || 0;
    return n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }
}

if (typeof formatDate !== 'function') {
  function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr + 'T00:00:00');
    return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
  }
}

// Somar percentuais incluindo extras com classe .commit-custom-percent
function updateCommitmentTotal() {
  const expenses = parseFloat(document.getElementById('commit-expenses').value) || 0;
  const invest = parseFloat(document.getElementById('commit-invest').value) || 0;
  const tithe = parseFloat(document.getElementById('commit-tithe').value) || 0;
  const emergency = parseFloat(document.getElementById('commit-emergency').value) || 0;

  // incluir custom percent inputs
  let customSum = 0;
  document.querySelectorAll('.commit-custom-percent').forEach(el => {
    customSum += parseFloat(el.value) || 0;
  });

  const total = expenses + invest + tithe + emergency + customSum;

  const totalEl = document.getElementById('commit-total');
  totalEl.textContent = total + '%';
  totalEl.className = total === 100 ? 'text-xl font-bold text-emerald-400' : 'text-xl font-bold text-red-400';
}

// Investment options used for goal projections
const investmentOptions = [
  { key: 'selic', label: 'SELIC', rate: 0.1075 },
  { key: 'ipca', label: 'Tesouro IPCA+', rate: 0.055 },
  { key: 'prefixado', label: 'Tesouro Prefixado', rate: 0.125 },
  { key: 'cdb', label: 'CDB', rate: 0.118 },
  { key: 'lci', label: 'LCI/LCA', rate: 0.102 },
  { key: 'fundos', label: 'Fundos Multimercado', rate: 0.1375 }
];

// calcula meses necessÃ¡rios por simulaÃ§Ã£o mensal com aporte e juros compostos
function estimateMonthsToTarget(current, monthly, annualRate, target, maxMonths = 1200) {
  current = Number(current) || 0;
  monthly = Number(monthly) || 0;
  target = Number(target) || 0;
  if (current >= target) return 0;
  if (monthly <= 0 && (!annualRate || annualRate === 0)) return null; // impossÃ­vel

  const r = Math.pow(1 + annualRate, 1 / 12) - 1; // monthly rate

  if (r === 0) {
    const months = Math.ceil((target - current) / monthly);
    return months > maxMonths ? null : months;
  }

  let balance = current;
  for (let m = 1; m <= maxMonths; m++) {
    // apply interest
    balance = balance * (1 + r);
    // add monthly contribution at end of period
    balance += monthly;
    if (balance >= target) return m;
  }
  return null; // didn't reach within maxMonths
}

function formatMonths(m) {
  if (m === 0) return 'JÃ¡ alcanÃ§ado';
  if (m === null) return 'N/A';
  const years = Math.floor(m / 12);
  const months = m % 12;
  let parts = [];
  if (years > 0) parts.push(years + (years === 1 ? ' ano' : ' anos'));
  if (months > 0) parts.push(months + (months === 1 ? ' mÃªs' : ' meses'));
  return parts.join(' e ');
}

// Calcula e atualiza estimativas na UI para um objetivo
function computeEstimatesForGoal(id) {
  const monthlyEl = document.getElementById(`goal-monthly-${id}`);
  const container = document.getElementById(`goal-estimates-${id}`);
  if (!container || !window._goalsCache || !window._goalsCache[id]) return;
  const monthly = Number(monthlyEl?.value) || 0;
  const { progress, target } = window._goalsCache[id];

  const rows = investmentOptions.map(opt => {
    const months = estimateMonthsToTarget(progress, monthly, opt.rate, target);
    return `
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2"><span class="text-sm">${opt.label}</span></div>
        <div class="text-right"><div class="font-semibold">${formatMonths(months)}</div><div class="text-xs text-slate-500">${months ? months + ' meses' : ''}</div></div>
      </div>
    `;
  }).join('');

  container.innerHTML = rows;
}

// adiciona um valor ao progresso do objetivo
async function addToGoalProgress(id) {
  if (!currentFamily || !currentUser) return;
  const input = document.getElementById(`goal-add-${id}`);
  if (!input) return;
  const amount = Number(input.value) || 0;
  if (amount <= 0) {
    if (typeof showToast === 'function') showToast('âš ï¸', 'Digite um valor vÃ¡lido');
    return;
  }

  try {
    await db.collection('goals').doc(id).update({
      progress: firebase.firestore.FieldValue.increment(amount)
    });
    input.value = '';
    if (typeof showToast === 'function') showToast('âœ…', 'Valor adicionado Ã  meta');
    await loadGoalsList();
  } catch (error) {
    console.error('Error adding to goal progress:', error);
    if (typeof showToast === 'function') showToast('âŒ', 'Erro ao atualizar meta');
  }
}

// Apaga uma meta
async function deleteGoal(id) {
  if (!id || !currentFamily || !currentUser) return;
  if (!confirm('Deseja realmente excluir essa meta? Esta aÃ§Ã£o nÃ£o pode ser desfeita.')) return;
  try {
    await db.collection('goals').doc(id).delete();
    if (typeof showToast === 'function') showToast('âœ…', 'Meta excluÃ­da');
    await loadGoalsList();
    if (typeof loadCompletedGoals === 'function') loadCompletedGoals();
  } catch (error) {
    console.error('Error deleting goal:', error);
    if (typeof showToast === 'function') showToast('âŒ', 'Erro ao excluir meta');
  }
}

// Concluir uma meta: cria entrada em goals_history e marca meta como concluÃ­da
async function completeGoal(id) {
  if (!id || !currentFamily || !currentUser) return;
  if (!confirm('Marcar meta como concluÃ­da?')) return;
  try {
    const doc = await db.collection('goals').doc(id).get();
    if (!doc.exists) {
      if (typeof showToast === 'function') showToast('âš ï¸', 'Meta nÃ£o encontrada');
      return;
    }
    const data = doc.data();
    const completedAt = new Date().toISOString();
    // create history record
    await db.collection('goals_history').add({
      goalId: id,
      familyId: data.familyId || currentFamily,
      userId: data.userId || currentUser.uid,
      name: data.name || '',
      startDate: data.startDate || null,
      progress: Number(data.progress || 0),
      targetAmount: Number(data.targetAmount || 0),
      completedAt
    });
    // mark the original goal as completed
    await db.collection('goals').doc(id).update({ completed: true, completedAt });

    if (typeof showToast === 'function') showToast('âœ…', 'Meta marcada como concluÃ­da');
    await loadGoalsList();
    if (typeof loadCompletedGoals === 'function') loadCompletedGoals();
  } catch (error) {
    console.error('Error completing goal:', error);
    if (typeof showToast === 'function') showToast('âŒ', 'Erro ao concluir meta');
  }
}

// Carrega histÃ³rico de metas concluÃ­das (da coleÃ§Ã£o goals_history e metas jÃ¡ marcadas)
async function loadCompletedGoals() {
  if (!currentFamily || !currentUser) return;
  try {
    const histQuery = db.collection('goals_history')
      .where('familyId', '==', currentFamily)
      .where('userId', '==', currentUser.uid)
      .orderBy('completedAt', 'desc')
      .limit(50);
    const histSnap = await histQuery.get();
    const container = document.getElementById('completed-goals-list');
    const items = [];

    histSnap.forEach(doc => {
      const d = doc.data();
      const startText = d.startDate ? formatDate((d.startDate || '').split('T')[0]) : 'â€”';
      const endText = d.completedAt ? formatDate((d.completedAt || '').split('T')[0]) : 'â€”';
      items.push(`<div class="p-3 bg-slate-800/30 rounded-lg flex items-center justify-between flex-col sm:flex-row gap-2">
        <div class="w-full sm:w-auto">
          <div class="font-medium text-white">${d.name}</div>
          <div class="text-xs text-slate-400">InÃ­cio: ${startText} â€” ConclusÃ£o: ${endText} â€” ${d.progress ? (typeof formatCurrency === 'function' ? formatCurrency(d.progress) : d.progress) : ''} / ${typeof formatCurrency === 'function' ? formatCurrency(d.targetAmount) : d.targetAmount}</div>
        </div>
        <div class="text-right w-full sm:w-auto flex gap-2"><button class="text-xs text-emerald-400" onclick="reopenGoalFromHistory('${doc.id}')">Reabrir</button> <button class="text-xs text-red-400" onclick="deleteCompletedGoal('${doc.id}')">Excluir</button></div>
      </div>`);
    });

    if (items.length === 0) {
      if (container) container.innerHTML = '<p class="text-slate-500">Nenhum objetivo concluÃ­do</p>';
    } else {
      if (container) container.innerHTML = items.join('');
    }
  } catch (error) {
    console.error('Error loading completed goals:', error);
  }
}

// Reabre uma meta a partir do histÃ³rico (restaura a meta original se existir)
async function reopenGoalFromHistory(historyId) {
  if (!historyId) return;
  if (!confirm('Reabrir esta meta? Ela voltarÃ¡ Ã  sua forma ativa.')) return;
  try {
    const hdoc = await db.collection('goals_history').doc(historyId).get();
    if (!hdoc.exists) return;
    const data = hdoc.data();
    // try to find original goal
    if (data.goalId) {
      await db.collection('goals').doc(data.goalId).update({ completed: false, completedAt: firebase.firestore.FieldValue.delete() });
    }
    // remove history entry
    await db.collection('goals_history').doc(historyId).delete();
    if (typeof showToast === 'function') showToast('âœ…', 'Meta reaberta');
    await loadGoalsList();
    if (typeof loadCompletedGoals === 'function') loadCompletedGoals();
  } catch (error) {
    console.error('Error reopening goal from history:', error);
    if (typeof showToast === 'function') showToast('âŒ', 'Erro ao reabrir meta');
  }
}

// Deleta um objetivo do histÃ³rico completamente
async function deleteCompletedGoal(historyId) {
  if (!historyId) return;
  if (!confirm('Deseja remover este objetivo do histÃ³rico? Esta aÃ§Ã£o nÃ£o pode ser desfeita.')) return;
  try {
    await db.collection('goals_history').doc(historyId).delete();
    if (typeof showToast === 'function') showToast('âœ…', 'Objetivo removido do histÃ³rico');
    if (typeof loadCompletedGoals === 'function') loadCompletedGoals();
  } catch (error) {
    console.error('Error deleting completed goal:', error);
    if (typeof showToast === 'function') showToast('âŒ', 'Erro ao remover objetivo');
  }
}

// Allow using the entire investment amount on one goal
function useAllInvestmentForGoal(id) {
  const investAmount = Number(window._lastInvestAmount || 0);
  if (investAmount <= 0) {
    if (typeof showToast === 'function') showToast('âš ï¸', 'Nenhum valor alocado para investimentos');
    return;
  }
  const goalsContainer = document.getElementById('goals-list');
  if (!goalsContainer) return;
  const goalItems = goalsContainer.querySelectorAll('[id^="goal-"]');
  goalItems.forEach(item => {
    const gid = item.id.replace('goal-', '');
    const input = document.getElementById(`goal-monthly-${gid}`);
    if (!input) return;
    if (gid === id) {
      input.value = investAmount.toFixed(2);
      input.dataset.userEdited = '1';
      try { computeEstimatesForGoal(gid); } catch (e) {}
    } else {
      input.value = (0).toFixed(2);
      input.dataset.userEdited = '1';
      try { computeEstimatesForGoal(gid); } catch (e) {}
    }
  });
}

// Atualiza valores, agora tambÃ©m preenche os valores das divisÃµes custom (ids gerados por sanitizeKey)
async function updateCommitmentValues() {
  if (!currentFamily || !currentFamilyData) return;

  try {
    const salariesQuery = db.collection('transactions')
      .where('familyId', '==', currentFamily)
      .where('type', '==', 'salary')
      .where('userId', '==', currentUser.uid)
      .where('isActive', '==', true);

    const salariesSnap = await salariesQuery.get();
    let totalMonthlySalary = 0;

    const today = new Date().toISOString().split('T')[0];

    salariesSnap.forEach(doc => {
      const data = doc.data();
      const startOk = data.startDate <= today;
      const endOk = !data.endDate || data.endDate >= today;

      if (startOk && endOk) {
        totalMonthlySalary += calculateMonthlySalary(data.amount, data.frequency);
      }
    });

    const expenses = parseFloat(document.getElementById('commit-expenses').value) || 0;
    const invest = parseFloat(document.getElementById('commit-invest').value) || 0;
    const tithe = parseFloat(document.getElementById('commit-tithe').value) || 0;
    const emergency = parseFloat(document.getElementById('commit-emergency').value) || 0;

    document.getElementById('val-expenses').textContent = formatCurrency(totalMonthlySalary * expenses / 100);
    const investAmount = totalMonthlySalary * invest / 100;
    // cache last computed invest amount for use by goals
    window._lastInvestAmount = investAmount;
    document.getElementById('val-invest').textContent = formatCurrency(investAmount);
    document.getElementById('val-tithe').textContent = formatCurrency(totalMonthlySalary * tithe / 100);
    document.getElementById('val-emergency').textContent = formatCurrency(totalMonthlySalary * emergency / 100);

    // If goals are rendered, distribute investAmount as default monthly contribution
    const goalsContainer = document.getElementById('goals-list');
    if (goalsContainer) {
      const goalItems = goalsContainer.querySelectorAll('[id^="goal-"]');
      const count = goalItems.length;
      if (count > 0) {
        const perGoal = investAmount / count;
        goalItems.forEach(item => {
          const id = item.id.replace('goal-', '');
          const monthlyInput = document.getElementById(`goal-monthly-${id}`);
          if (monthlyInput) {
            // if there's only one goal, put the whole investAmount as default
            if (count === 1) {
              monthlyInput.value = investAmount.toFixed(2);
              monthlyInput.dataset.userEdited = '';
            } else {
              // only set if user didn't manually edit
              if (!monthlyInput.dataset.userEdited) {
                monthlyInput.value = perGoal.toFixed(2);
              }
            }
            // refresh estimates to reflect new default
            try { computeEstimatesForGoal(id); } catch (e) {}
          }
        });
      }
    }

    // Atualiza valores custom
    const docSnap = await db.collection('finances').doc(`${currentFamily}_custom_commitments`).get();
    let percentages = [];
    if (docSnap.exists && Array.isArray(docSnap.data().percentages)) {
      percentages = docSnap.data().percentages;
    } else {
      // fallback: ler inputs na tela
      document.querySelectorAll('.commit-custom-percent').forEach((el, idx) => {
        percentages[idx] = parseFloat(el.value) || 0;
      });
    }

    const commitMain = document.getElementById('custom-commitments-main');
    if (commitMain) {
      const items = commitMain.querySelectorAll('[data-custom-index]');
      items.forEach(item => {
        const idx = parseInt(item.getAttribute('data-custom-index'), 10);
        const name = item.getAttribute('data-custom-name') || '';
        const key = sanitizeKey(name);
        const valEl = document.getElementById(`val-custom-${key}`);
        const pct = percentages[idx] || 0;
        if (valEl) {
          valEl.textContent = formatCurrency(totalMonthlySalary * pct / 100);
        }
      });
    }

    // notify dashboard to re-render category distribution using latest commitment values
    if (typeof updateDashboard === 'function') updateDashboard();
  } catch (error) {
    console.error('Error updating commitment values:', error);
  }
}

// Carregar divisÃµes extras e renderizar tanto na Ã¡rea de ediÃ§Ã£o quanto na Ã¡rea principal
async function loadCustomCommitments() {
  if (!currentFamily) return;

  try {
    const docRef = db.collection('finances').doc(`${currentFamily}_custom_commitments`);
    const docSnap = await docRef.get();

    const customList = document.getElementById('custom-commitments-list');
    const customMain = document.getElementById('custom-commitments-main');
    // limpar existentes
    customList.innerHTML = '';
    // remover custom values existentes do painel de valores
    document.querySelectorAll('[data-custom-value="true"]').forEach(el => el.remove());
    // remover custom inputs do painel principal
    customMain.querySelectorAll('[data-custom-index]').forEach(el => el.remove());

    let commitments = [];
    let percentages = [];

    if (docSnap.exists) {
      commitments = docSnap.data().commitments || [];
      percentages = docSnap.data().percentages || [];
    }

    // render na Ã¡rea de ediÃ§Ã£o (com botÃ£o remover)
    customList.innerHTML = commitments.map((com, idx) => `
      <div class="flex items-center gap-2 flex-col sm:flex-row">
        <input type="text" value="${com.emoji} ${com.name}" disabled class="input-dark w-full px-2 py-1 rounded text-white text-sm opacity-70">
        <input type="number" min="0" max="100" step="1" class="input-dark px-2 py-1 rounded text-white text-sm commit-custom-percent" data-custom-input-index="${idx}" value="${percentages[idx] || 0}">
        <button onclick="deleteCustomCommitment(${idx})" class="ml-2 px-2 py-1 text-xs text-red-400 hover:bg-red-500/10 rounded w-full sm:w-auto">ğŸ—‘ï¸ Remover</button>
      </div>
    `).join('');

    // render na Ã¡rea principal (percent input + display removed handled above)
    commitments.forEach((com, idx) => {
      const key = sanitizeKey(com.name);
      const pct = percentages[idx] || 0;

      const mainHtml = document.createElement('div');
      mainHtml.className = 'flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl flex-col sm:flex-row';
      mainHtml.setAttribute('data-custom-index', idx);
      mainHtml.setAttribute('data-custom-name', com.name);
      mainHtml.innerHTML = `
        <div class="flex items-center gap-3 flex-1 w-full">
          <span class="text-2xl">${com.emoji}</span>
          <div class="flex-1">
            <div class="flex items-center gap-2 flex-col sm:flex-row">
              <span class="text-slate-300">${com.name}</span>
              <div class="flex items-center ml-0 sm:ml-3">
                <input type="number" min="0" max="100" step="1" value="${pct}" class="input-dark px-2 py-1 rounded commit-custom-percent w-16" data-custom-input-index="${idx}">
                <span class="text-slate-400 ml-1">%</span>
              </div>
            </div>
          </div>
        </div>
        <div class="text-right w-full sm:w-auto">
          <p class="text-2xl font-bold text-slate-400" id="val-custom-${key}" data-custom-value="true">R$ 0,00</p>
        </div>
      `;
      customMain.appendChild(mainHtml);
    });

    // adicionar listeners aos inputs recÃ©m-criados
    document.querySelectorAll('.commit-custom-percent').forEach(input => {
      input.removeEventListener('input', _onCustomPercentInput);
      input.addEventListener('input', _onCustomPercentInput);
    });

    // atualizar valores (chama updateCommitmentValues internamente)
    updateCommitmentTotal();
    updateCommitmentValues();
  } catch (error) {
    console.log('Could not load custom commitments:', error);
  }
}

function _onCustomPercentInput() {
  // salva valores temporariamente na tela e atualiza cÃ¡lculos
  updateCommitmentTotal();
  updateCommitmentValues();
}

// Ao adicionar uma nova divisÃ£o, salvar tambÃ©m porcentagem inicial 0
async function addNewCommitment() {
  if (!currentFamily || !currentFamilyData) return;

  const emoji = document.getElementById('new-commitment-emoji').value.trim();
  const name = document.getElementById('new-commitment-name').value.trim();

  if (!emoji || !name) {
    showToast('âš ï¸', 'Digite o emoji e o nome');
    return;
  }

  try {
    const docRef = db.collection('finances').doc(`${currentFamily}_custom_commitments`);
    const docSnap = await docRef.get();

    let commitments = [];
    let percentages = [];
    if (docSnap.exists) {
      commitments = docSnap.data().commitments || [];
      percentages = docSnap.data().percentages || [];
    }

    commitments.push({ emoji, name });
    percentages.push(0); // default 0%

    await docRef.set({
      familyId: currentFamily,
      commitments: commitments,
      percentages: percentages,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    document.getElementById('new-commitment-emoji').value = '';
    document.getElementById('new-commitment-name').value = '';

    showToast('âœ…', `DivisÃ£o "${emoji} ${name}" adicionada!`);
    await loadCustomCommitments();
  } catch (error) {
    showToast('âŒ', 'Erro ao adicionar divisÃ£o');
    console.error('Error adding custom commitment:', error);
  }
}

// Ao deletar, tambÃ©m atualizar o array de percentages no documento
async function deleteCustomCommitment(index) {
  if (!currentFamily || !currentFamilyData) return;

  try {
    const docRef = db.collection('finances').doc(`${currentFamily}_custom_commitments`);
    const docSnap = await docRef.get();

    if (docSnap.exists && docSnap.data().commitments) {
      const commitments = docSnap.data().commitments;
      const percentages = docSnap.data().percentages || [];
      commitments.splice(index, 1);
      percentages.splice(index, 1);

      await docRef.set({
        familyId: currentFamily,
        commitments: commitments,
        percentages: percentages,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      showToast('âœ…', 'DivisÃ£o removida!');
      await loadCustomCommitments();
      updateCommitmentTotal();
      updateCommitmentValues();
    }
  } catch (error) {
    showToast('âŒ', 'Erro ao remover divisÃ£o');
    console.error('Error deleting custom commitment:', error);
  }
}

// Salvar porcentagens custom quando salvar divisÃ£o principal
async function saveCommitments() {
  if (!currentFamily || !currentFamilyData) return;

  const expenses = parseFloat(document.getElementById('commit-expenses').value) || 0;
  const invest = parseFloat(document.getElementById('commit-invest').value) || 0;
  const tithe = parseFloat(document.getElementById('commit-tithe').value) || 0;
  const emergency = parseFloat(document.getElementById('commit-emergency').value) || 0;

  // coletar custom percentuais atuais da tela (mantÃ©m a ordem)
  const customPercents = [];
  document.querySelectorAll('.commit-custom-percent').forEach(el => {
    customPercents.push(parseFloat(el.value) || 0);
  });

  const total = expenses + invest + tithe + emergency + customPercents.reduce((a, b) => a + b, 0);
  if (Math.round(total) !== 100) {
    showToast('âš ï¸', 'O total deve ser 100%');
    return;
  }

  try {
    await db.collection('finances').doc(`${currentFamily}_commitments_${currentUser.uid}`).set({
      familyId: currentFamily,
      expenses,
      invest,
      tithe,
      emergency,
      userId: currentUser.uid,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // tambÃ©m salva porcentagens custom no prÃ³prio documento de custom commitments
    const customRef = db.collection('finances').doc(`${currentFamily}_custom_commitments`);
    const customDoc = await customRef.get();
    if (customDoc.exists) {
      const data = customDoc.data();
      await customRef.set({
        ...data,
        percentages: customPercents,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    } else if (customPercents.length > 0) {
      // criar doc se houver custom
      await customRef.set({
        familyId: currentFamily,
        commitments: [], // jÃ¡ deve ter sido criado ao adicionar
        percentages: customPercents,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    showToast('âœ…', 'DivisÃ£o salva!');
    await loadCustomCommitments();
    updateCommitmentValues();
  } catch (error) {
    showToast('âŒ', 'Erro ao salvar');
    console.error('Error saving commitments:', error);
  }
}

// Controlar indicador de scroll das abas
function initTabsScrollIndicator() {
  const tabsContainer = document.getElementById('tabs-container');
  const indicatorLeft = document.getElementById('tabs-scroll-indicator-left');
  const indicatorRight = document.getElementById('tabs-scroll-indicator-right');
  
  if (!tabsContainer || !indicatorLeft || !indicatorRight) return;
  
  function updateIndicators() {
    // Verifica se hÃ¡ conteÃºdo para scroll
    const hasScroll = tabsContainer.scrollWidth > tabsContainer.clientWidth;
    const scrollPos = tabsContainer.scrollLeft;
    const maxScroll = tabsContainer.scrollWidth - tabsContainer.clientWidth;
    
    // Mostra indicador esquerdo se hÃ¡ scroll e nÃ£o estamos no inÃ­cio
    if (hasScroll && scrollPos > 10) {
      indicatorLeft.classList.remove('hidden');
    } else {
      indicatorLeft.classList.add('hidden');
    }
    
    // Mostra indicador direito se hÃ¡ scroll e nÃ£o estamos no final
    if (hasScroll && scrollPos < maxScroll - 10) {
      indicatorRight.classList.remove('hidden');
    } else {
      indicatorRight.classList.add('hidden');
    }
  }
  
  // Listener para scroll
  tabsContainer.addEventListener('scroll', updateIndicators);
  
  // Verificar ao carregar e quando redimensionar
  window.addEventListener('resize', updateIndicators);
  
  // VerificaÃ§Ã£o inicial
  setTimeout(updateIndicators, 100);
}

// BotÃ£o Voltar ao Topo
function initBackToTop() {
  const backToTop = document.getElementById('back-to-top');
  if (!backToTop) return;
  
  function toggleBackToTop() {
    if (window.scrollY > 300) {
      backToTop.classList.add('visible');
    } else {
      backToTop.classList.remove('visible');
    }
  }
  
  function scrollToTop() {
    window.scrollTo({
      top: 0,
      behavior: 'smooth'
    });
  }
  
  backToTop.addEventListener('click', scrollToTop);
  window.addEventListener('scroll', toggleBackToTop);
  toggleBackToTop(); // Initial check
}

function hideBackToTop() {
  const backToTop = document.getElementById('back-to-top');
  if (backToTop) {
    backToTop.classList.remove('visible');
  }
}

// RELATÃ“RIO: incluir salÃ¡rios pro rata no perÃ­odo selecionado
function monthsBetweenInclusive(start, end) {
  const s = new Date(start + 'T00:00:00');
  const e = new Date(end + 'T00:00:00');
  let months = (e.getFullYear() - s.getFullYear()) * 12 + (e.getMonth() - s.getMonth()) + 1;
  return months > 0 ? months : 0;
}

async function generateReport() {
  if (!currentFamily || !currentFamilyData) return;

  const startDate = document.getElementById('report-start').value;
  const endDate = document.getElementById('report-end').value;

  if (!startDate || !endDate) {
    showToast('âš ï¸', 'Selecione as datas');
    return;
  }

  const reportEl = document.getElementById('report-content');

  try {
    reportEl.innerHTML = '<p class="text-slate-500 text-center py-8">Gerando relatÃ³rio...</p>';

    // queries de entradas e despesas (como antes)
    let incomeQuery, expenseQuery;

    if (dashboardView === 'individual') {
      incomeQuery = db.collection('transactions')
        .where('familyId', '==', currentFamily)
        .where('type', '==', 'income')
        .where('userId', '==', currentUser.uid);

      expenseQuery = db.collection('transactions')
        .where('familyId', '==', currentFamily)
        .where('type', '==', 'expense')
        .where('userId', '==', currentUser.uid);
    } else {
      incomeQuery = db.collection('transactions')
        .where('familyId', '==', currentFamily)
        .where('type', '==', 'income');
      expenseQuery = db.collection('transactions')
        .where('familyId', '==', currentFamily)
        .where('type', '==', 'expense');
    }

    const [incomeSnap, expenseSnap, salarySnap] = await Promise.all([
      incomeQuery.get(),
      expenseQuery.get(),
      db.collection('transactions').where('familyId', '==', currentFamily).where('type', '==', 'salary').get()
    ]);

    let totalIncome = 0;
    let totalExpenses = 0;
    const incomeItems = [];
    const expenseItems = [];
    const categoryTotals = {};

    // incluir salÃ¡rios como entradas proporcionais ao perÃ­odo
    const months = monthsBetweenInclusive(startDate, endDate);

    salarySnap.forEach(doc => {
      const s = doc.data();
      // verificar se o salÃ¡rio estÃ¡ ativo dentro do perÃ­odo
      const startOk = s.startDate <= endDate;
      const endOk = !s.endDate || s.endDate >= startDate;
      if (startOk && endOk) {
        const monthly = calculateMonthlySalary(s.amount, s.frequency);
        const totalForPeriod = monthly * months;
        totalIncome += totalForPeriod;
        incomeItems.push({
          date: `${startDate} â†’ ${endDate}`,
          description: `SalÃ¡rio: ${s.description} (${months} mÃªs${months>1?'es':''})`,
          amount: totalForPeriod,
          userName: s.userName || s.userId
        });
      }
    });

    incomeSnap.forEach(doc => {
      const data = doc.data();
      if (data.date >= startDate && data.date <= endDate) {
        totalIncome += Number(data.amount);
        incomeItems.push(data);
      }
    });

    expenseSnap.forEach(doc => {
      const data = doc.data();
      if (data.date >= startDate && data.date <= endDate) {
        totalExpenses += Number(data.amount);
        expenseItems.push(data);
        categoryTotals[data.category] = (categoryTotals[data.category] || 0) + Number(data.amount);
      }
    });

    const balance = totalIncome - totalExpenses;

    // Monta HTML do relatÃ³rio (manter exportaÃ§Ã£o separada)
    reportEl.innerHTML = `
      <h3 class="text-lg font-semibold text-white mb-4">RelatÃ³rio: ${formatDate(startDate)} a ${formatDate(endDate)}</h3>
      <button onclick="exportReportToCSV('${startDate}', '${endDate}')" class="btn-primary px-4 py-2 rounded-lg text-sm font-medium mb-4 w-full sm:w-auto">ğŸ“¥ Exportar para CSV</button>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="p-4 bg-emerald-500/10 border border-emerald-500/30 rounded-xl">
          <p class="text-slate-400 text-sm">Total de Entradas</p>
          <p class="text-2xl font-bold text-emerald-400">${formatCurrency(totalIncome)}</p>
          <p class="text-xs text-slate-500">${incomeItems.length} transaÃ§Ãµes</p>
        </div>
        <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-xl">
          <p class="text-slate-400 text-sm">Total de Despesas</p>
          <p class="text-2xl font-bold text-red-400">${formatCurrency(totalExpenses)}</p>
          <p class="text-xs text-slate-500">${expenseItems.length} transaÃ§Ãµes</p>
        </div>
        <div class="p-4 ${balance >= 0 ? 'bg-blue-500/10 border-blue-500/30' : 'bg-red-500/10 border-red-500/30'} border rounded-xl">
          <p class="text-slate-400 text-sm">Saldo do PerÃ­odo</p>
          <p class="text-2xl font-bold ${balance >= 0 ? 'text-blue-400' : 'text-red-400'}">${formatCurrency(balance)}</p>
          <p class="text-xs text-slate-500">${balance >= 0 ? 'Positivo' : 'Negativo'}</p>
        </div>
      </div>

      <h4 class="font-semibold text-white mb-3">Despesas por Categoria</h4>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
        ${Object.entries(categoryTotals).sort((a,b)=>b[1]-a[1]).map(([cat, amount]) => `
          <div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg">
            <span class="text-slate-300">${getCategoryLabel(cat)}</span>
            <span class="font-semibold text-white">${formatCurrency(amount)}</span>
          </div>
        `).join('')}
      </div>

      ${incomeItems.length > 0 ? `
        <h4 class="font-semibold text-white mb-3">Detalhamento de Entradas</h4>
        <div class="space-y-2 mb-6 max-h-48 overflow-y-auto scrollbar-thin">
          ${incomeItems.sort((a,b)=> (new Date(b.date)-new Date(a.date))).map(item => `
            <div class="flex justify-between p-2 bg-slate-800/30 rounded-lg text-sm flex-col sm:flex-row">
              <span class="text-slate-300">${item.description} <span class="text-slate-500">(${item.date})</span></span>
              <span class="text-emerald-400 font-medium">+ ${formatCurrency(item.amount)}</span>
            </div>
          `).join('')}
        </div>
      ` : ''}

      ${expenseItems.length > 0 ? `
        <h4 class="font-semibold text-white mb-3">Detalhamento de Despesas</h4>
        <div class="space-y-2 max-h-48 overflow-y-auto scrollbar-thin">
          ${expenseItems.sort((a,b)=> (new Date(b.date)-new Date(a.date))).map(item => `
            <div class="flex justify-between p-2 bg-slate-800/30 rounded-lg text-sm flex-col sm:flex-row">
              <span class="text-slate-300">${item.description} <span class="text-slate-500">(${item.date})</span></span>
              <span class="text-red-400 font-medium">- ${formatCurrency(item.amount)}</span>
            </div>
          `).join('')}
        </div>
      ` : ''}
    `;

  } catch (error) {
    reportEl.innerHTML = '<p class="text-red-400 text-center py-8">Erro ao gerar relatÃ³rio</p>';
    console.error('Error generating report:', error);
  }
}

  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c6dc2a81525df55',t:'MTc2OTkxMDIzMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>