<!doctype html>
<html lang="pt-BR" class="h-full scroll-smooth">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>Cash Control - Gest√£o Financeira Familiar</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#10b981">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Cash Control">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%2310b981' width='180' height='180'/><text x='90' y='110' font-size='90' font-weight='bold' fill='white' text-anchor='middle'>üí∞</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-primary: #10b981;
      --color-primary-dark: #059669;
      --color-secondary: #6366f1;
      --color-danger: #ef4444;
      --color-success: #10b981;
      --color-warning: #f59e0b;
      --color-bg: #0f172a;
      --color-bg-light: #1e293b;
      --color-bg-lighter: #334155;
      --color-border: #475569;
      --color-text: #f1f5f9;
      --color-text-secondary: #cbd5e1;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Plus Jakarta Sans', sans-serif;
      -webkit-text-size-adjust: 100%;
      -webkit-tap-highlight-color: transparent;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      background: linear-gradient(135deg, var(--color-bg) 0%, #1a2647 50%, var(--color-bg) 100%);
      color: var(--color-text);
      min-height: 100vh;
    }

    /* Componentes Base */
    .gradient-bg {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
    }

    .card {
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(71, 85, 105, 0.2);
      border-radius: 16px;
      transition: var(--transition);
    }

    .card:hover {
      border-color: rgba(16, 185, 129, 0.3);
      box-shadow: 0 8px 32px rgba(16, 185, 129, 0.1);
    }

    .card-glass {
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(71, 85, 105, 0.2);
      border-radius: 16px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: 44px;
      padding: 10px 20px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      gap: 8px;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5);
    }

    .btn-secondary {
      background: rgba(99, 102, 241, 0.1);
      color: #6366f1;
      border: 2px solid #6366f1;
    }

    .btn-secondary:hover {
      background: #6366f1;
      color: white;
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--color-border);
      color: var(--color-text);
    }

    .btn-outline:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }

    .btn-danger {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: 2px solid #ef4444;
    }

    .btn-danger:hover {
      background: #ef4444;
      color: white;
    }

    .input-field {
      background: rgba(15, 23, 42, 0.6);
      border: 1.5px solid rgba(71, 85, 105, 0.3);
      color: white;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 16px;
      transition: var(--transition);
      font-family: inherit;
    }

    .input-field:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
    }

    .input-field::placeholder {
      color: rgba(203, 213, 225, 0.5);
    }

    /* Anima√ß√µes */
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .animate-fade-in {
      animation: fadeIn 0.4s ease-out;
    }

    .animate-slide-up {
      animation: slideInUp 0.4s ease-out;
    }

    /* Header Melhorado */
    header {
      backdrop-filter: blur(20px);
      background: rgba(30, 41, 59, 0.85);
      border-bottom: 1px solid rgba(71, 85, 105, 0.1);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    header .container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      gap: 16px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
      flex: 1;
      min-width: 0;
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }

    .header-brand-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .header-info h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      color: white;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .header-info p {
      margin: 4px 0 0 0;
      font-size: 12px;
      color: #94a3b8;
    }

    /* Tabs Melhoradas */
    nav {
      backdrop-filter: blur(20px);
      background: rgba(30, 41, 59, 0.85);
      border-bottom: 1px solid rgba(71, 85, 105, 0.1);
      position: sticky;
      top: 56px;
      z-index: 40;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    nav::-webkit-scrollbar {
      display: none;
    }

    nav .tabs {
      display: flex;
      gap: 4px;
      padding: 12px 20px;
      min-width: min-content;
    }

    .tab-btn {
      padding: 10px 16px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      background: transparent;
      color: #94a3b8;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
      flex-shrink: 0;
    }

    .tab-btn:hover {
      background: rgba(99, 102, 241, 0.1);
      color: #6366f1;
    }

    .tab-btn.active {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    /* Main Content */
    main {
      padding: 24px 20px;
      padding-bottom: 120px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Grid Layouts */
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .grid-4 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    /* Summary Cards */
    .summary-card {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(99, 102, 241, 0.05) 100%);
      border: 1px solid rgba(16, 185, 129, 0.2);
      border-radius: 16px;
      padding: 24px;
      transition: var(--transition);
    }

    .summary-card:hover {
      transform: translateY(-4px);
      border-color: rgba(16, 185, 129, 0.4);
      box-shadow: 0 12px 24px rgba(16, 185, 129, 0.15);
    }

    .summary-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .summary-card-label {
      font-size: 13px;
      font-weight: 600;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .summary-card-icon {
      font-size: 28px;
    }

    .summary-card-value {
      font-size: 28px;
      font-weight: 800;
      margin: 8px 0;
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .summary-card-subtitle {
      font-size: 12px;
      color: #64748b;
    }

    /* Form Sections */
    .section {
      margin-bottom: 32px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 16px;
      color: white;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-description {
      font-size: 14px;
      color: #94a3b8;
      margin-bottom: 16px;
    }

    /* Form Groups */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #e2e8f0;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }

    /* List Items */
    .list-item {
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(71, 85, 105, 0.2);
      border-radius: 12px;
      padding: 16px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .list-item:hover {
      background: rgba(30, 41, 59, 0.8);
      border-color: rgba(16, 185, 129, 0.3);
    }

    .list-item-content {
      flex: 1;
      min-width: 0;
    }

    .list-item-title {
      font-weight: 600;
      color: white;
      word-break: break-word;
    }

    .list-item-subtitle {
      font-size: 12px;
      color: #94a3b8;
      margin-top: 4px;
    }

    .list-item-value {
      font-size: 16px;
      font-weight: 700;
      flex-shrink: 0;
    }

    .list-item-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .list-item-btn {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: none;
      background: rgba(99, 102, 241, 0.1);
      color: #6366f1;
      cursor: pointer;
      font-size: 16px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .list-item-btn:hover {
      background: #6366f1;
      color: white;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 50;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.3s ease-out;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border: 1px solid rgba(71, 85, 105, 0.3);
      border-radius: 20px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 32px;
      animation: slideInUp 0.4s ease-out;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .modal-title {
      font-size: 24px;
      font-weight: 700;
      color: white;
    }

    .modal-close {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: none;
      background: rgba(99, 102, 241, 0.1);
      color: #6366f1;
      cursor: pointer;
      font-size: 20px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      background: #6366f1;
      color: white;
    }

    /* Login Screen */
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: linear-gradient(135deg, var(--color-bg) 0%, #1a2647 100%);
    }

    .login-card {
      width: 100%;
      max-width: 420px;
      animation: slideInUp 0.6s ease-out;
    }

    .login-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .login-logo {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
    }

    .login-title {
      font-size: 32px;
      font-weight: 800;
      color: white;
      margin: 0;
    }

    .login-subtitle {
      font-size: 16px;
      color: #94a3b8;
      margin-top: 8px;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(30, 41, 59, 0.95);
      border: 1px solid rgba(71, 85, 105, 0.3);
      border-radius: 12px;
      padding: 16px 24px;
      color: white;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideInUp 0.4s ease-out;
      z-index: 100;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    /* Progress Ring */
    .progress-ring {
      transform: rotate(-90deg);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(30, 41, 59, 0.3);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(16, 185, 129, 0.3);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(16, 185, 129, 0.5);
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      main {
        padding: 16px 12px;
        padding-bottom: 100px;
      }

      header .container {
        padding: 12px 16px;
        gap: 12px;
      }

      .header-info h1 {
        font-size: 16px;
        max-width: 150px;
      }

      .header-info p {
        font-size: 11px;
      }

      .modal-content {
        padding: 24px;
        border-radius: 16px;
      }

      .modal-title {
        font-size: 20px;
      }

      .summary-card {
        padding: 20px;
      }

      .section-title {
        font-size: 18px;
      }

      .btn {
        min-height: 40px;
        padding: 8px 16px;
        font-size: 14px;
      }

      .list-item {
        flex-direction: column;
        align-items: flex-start;
      }

      .list-item-actions {
        width: 100%;
        justify-content: flex-end;
      }

      .grid-2, .grid-3, .grid-4 {
        grid-template-columns: 1fr;
      }
    }

    @supports (scrollbar-gutter: stable) {
      html {
        scrollbar-gutter: stable;
      }
    }
  </style>
 </head>
 <body class="gradient-bg text-slate-100">
  <div id="app" class="min-h-full">
    <!-- Login Screen -->
    <div id="login-screen" class="login-container">
      <div class="login-card card-glass">
        <div class="login-header">
          <div class="login-logo">üí∞</div>
          <h1 class="login-title">Cash Control</h1>
          <p class="login-subtitle">Gest√£o Financeira Familiar</p>
        </div>
        
        <div id="login-form">
          <div class="form-group">
            <label>üìß Email</label>
            <input type="email" id="login-email" class="input-field w-full" placeholder="seu@email.com">
          </div>
          
          <div class="form-group">
            <label>üîê Senha</label>
            <input type="password" id="login-password" class="input-field w-full" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>

          <div id="login-error" class="hidden mb-4 p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 text-sm"></div>

          <button onclick="handleLogin()" class="btn btn-primary w-full mb-3">
            <span>üöÄ</span> Entrar
          </button>

          <button onclick="showRegister()" class="btn btn-outline w-full">
            <span>‚ú®</span> Criar Conta
          </button>
        </div>

        <div id="register-form" class="hidden">
          <div class="form-group">
            <label>üë§ Nome Completo</label>
            <input type="text" id="register-name" class="input-field w-full" placeholder="Seu nome">
          </div>

          <div class="form-group">
            <label>üìß Email</label>
            <input type="email" id="register-email" class="input-field w-full" placeholder="seu@email.com">
          </div>

          <div class="form-group">
            <label>üîê Senha</label>
            <input type="password" id="register-password" class="input-field w-full" placeholder="M√≠nimo 6 caracteres">
          </div>

          <div id="register-error" class="hidden mb-4 p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 text-sm"></div>

          <button onclick="handleRegister()" class="btn btn-primary w-full mb-3">
            <span>‚ú®</span> Criar Conta
          </button>

          <button onclick="showLogin()" class="btn btn-outline w-full">
            <span>‚Üê</span> Voltar
          </button>
        </div>
      </div>
    </div>

    <!-- Family Selection Screen -->
    <div id="family-screen" class="hidden min-h-screen">
      <header>
        <div class="container">
          <div class="header-left">
            <div class="header-brand">
              <div class="header-brand-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
              <div>
                <h1>Minhas Fam√≠lias</h1>
                <p>Selecione ou crie uma</p>
              </div>
            </div>
          </div>
          <button onclick="handleLogout()" class="btn btn-danger">
            <span>üëã</span> Sair
          </button>
        </div>
      </header>

      <main>
        <div class="container">
          <div class="section">
            <h2 class="section-title">üìã Suas Fam√≠lias</h2>
            <div id="family-list" class="space-y-3">
              <p class="text-slate-400">Carregando...</p>
            </div>
          </div>

          <div class="section card rounded-2xl p-8">
            <h3 class="section-title">‚ûï Criar Nova Fam√≠lia</h3>
            <p class="section-description">Crie uma fam√≠lia para come√ßar a gerenciar suas finan√ßas juntos</p>
            
            <div class="form-group">
              <label>Nome da Fam√≠lia</label>
              <input type="text" id="new-family-name" class="input-field w-full" placeholder="Ex: Fonseca">
            </div>

            <button onclick="createFamily()" class="btn btn-primary w-full">
              <span>üéØ</span> Criar Fam√≠lia
            </button>
          </div>
        </div>
      </main>
    </div>

    <!-- Main App Screen -->
    <div id="main-screen" class="hidden flex flex-col min-h-screen">
      <!-- Header -->
      <header>
        <div class="container">
          <div class="header-left">
            <button onclick="goToFamilySelection()" class="btn btn-outline !w-11 !h-11 !p-0 flex-shrink-0">‚Üê</button>
            <div class="header-brand">
              <div class="header-brand-icon">üí∞</div>
              <div class="header-info">
                <h1 id="current-family-name">Cash Control</h1>
                <p id="current-user-name">Usu√°rio</p>
              </div>
            </div>
          </div>
          <button onclick="openModal('settings')" class="btn btn-outline !w-11 !h-11 !p-0 flex-shrink-0" title="Configura√ß√µes">‚öôÔ∏è</button>
        </div>
      </header>

      <!-- Navigation Tabs -->
      <nav>
        <div class="container">
          <div class="tabs">
            <button onclick="switchTab('dashboard')" class="tab-btn active" data-tab="dashboard">üìä Dashboard</button>
            <button onclick="switchTab('finances')" class="tab-btn" data-tab="finances">üí∞ Finan√ßas</button>
            <button onclick="switchTab('commitments')" class="tab-btn" data-tab="commitments">üìã Divis√µes</button>
            <button onclick="switchTab('projections')" class="tab-btn" data-tab="projections">üéØ Objetivos</button>
          </div>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="flex-1">
        <div class="container">
          <!-- Dashboard Tab -->
          <div id="tab-dashboard" class="tab-content">
            <div class="section">
              <div class="flex gap-3 mb-6 flex-wrap">
                <button onclick="setDashboardView('individual')" class="btn btn-primary" data-view="individual">üë§ Individual</button>
                <button onclick="setDashboardView('family')" class="btn btn-outline" data-view="family">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familiar</button>
              </div>

              <!-- Summary Cards -->
              <div class="grid-3">
                <div class="summary-card">
                  <div class="summary-card-header">
                    <span class="summary-card-label">Entradas</span>
                    <span class="summary-card-icon">üíµ</span>
                  </div>
                  <p class="summary-card-value" id="dash-total-income">R$ 0,00</p>
                  <p class="summary-card-subtitle">Este m√™s</p>
                </div>

                <div class="summary-card">
                  <div class="summary-card-header">
                    <span class="summary-card-label">Despesas</span>
                    <span class="summary-card-icon">üí∏</span>
                  </div>
                  <p class="summary-card-value" id="dash-total-expenses">R$ 0,00</p>
                  <p class="summary-card-subtitle">Este m√™s</p>
                </div>

                <div class="summary-card">
                  <div class="summary-card-header">
                    <span class="summary-card-label">Saldo</span>
                    <span class="summary-card-icon">üí∞</span>
                  </div>
                  <p class="summary-card-value" id="dash-balance">R$ 0,00</p>
                  <p class="summary-card-subtitle">Dispon√≠vel</p>
                </div>
              </div>
            </div>

            <!-- Charts & Transactions -->
            <div class="section">
              <h2 class="section-title">üìà Distribui√ß√£o por Categoria</h2>
              <div class="card rounded-2xl p-6">
                <div id="category-chart">
                  <p class="text-slate-400 text-center py-8">Adicione despesas para visualizar o gr√°fico</p>
                </div>
              </div>
            </div>

            <div class="section">
              <h2 class="section-title">üòä Satisfa√ß√£o com Renda</h2>
              <div class="card rounded-2xl p-6">
                <div class="flex items-center justify-center mb-6">
                  <div class="relative w-40 h-40">
                    <svg class="w-full h-full progress-ring" viewBox="0 0 128 128">
                      <circle cx="64" cy="64" r="56" stroke="#334155" stroke-width="12" fill="none" />
                      <circle id="satisfaction-ring" cx="64" cy="64" r="56" stroke="#10b981" stroke-width="12" fill="none" stroke-linecap="round" stroke-dasharray="351.86" stroke-dashoffset="351.86" />
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center flex-col">
                      <span id="satisfaction-value" class="text-3xl font-bold text-white">0%</span>
                      <span class="text-xs text-slate-400 mt-1">n√≠vel geral</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="section">
              <h2 class="section-title">üìù Transa√ß√µes Recentes</h2>
              <div class="space-y-2" id="recent-transactions">
                <p class="text-slate-400 text-center py-8">Nenhuma transa√ß√£o</p>
              </div>
            </div>

            <div id="custom-commitments-main" class="section">
              <!-- Custom commitments appear here -->
            </div>
          </div>

          <!-- Finances Tab -->
          <div id="tab-finances" class="tab-content hidden">
            <div class="flex gap-3 mb-6 flex-wrap">
              <button onclick="setFinanceView('income')" class="btn btn-primary" data-view="income">üì• Entradas</button>
              <button onclick="setFinanceView('expenses')" class="btn btn-outline" data-view="expenses">üì§ Despesas</button>
              <button onclick="setFinanceView('report')" class="btn btn-outline" data-view="report">üìä Relat√≥rio</button>
            </div>

            <!-- Income View -->
            <div id="finance-income" class="finance-content">
              <div class="section">
                <div class="flex items-center justify-between mb-4">
                  <h2 class="section-title">üíº Meus Sal√°rios</h2>
                  <button onclick="openModal('salary')" class="btn btn-primary">‚ûï Novo</button>
                </div>
                <div id="salaries-list" class="space-y-3">
                  <p class="text-slate-400 text-center py-8">Nenhum sal√°rio cadastrado</p>
                </div>
              </div>

              <div class="section">
                <h2 class="section-title">üòä Satisfa√ß√£o Geral</h2>
                <div class="card rounded-2xl p-6 space-y-4">
                  <input type="range" id="salary-satisfaction" min="0" max="100" value="50" class="w-full accent-emerald-500 h-2 rounded-lg cursor-pointer">
                  <div class="flex justify-between items-center">
                    <span class="text-slate-400">Qual seu n√≠vel de satisfa√ß√£o?</span>
                    <span id="satisfaction-display" class="text-2xl font-bold text-emerald-400">50%</span>
                  </div>
                  <button onclick="saveSatisfaction()" class="btn btn-primary w-full">üíæ Salvar</button>
                </div>
              </div>

              <div class="section">
                <h2 class="section-title">‚ûï Ganho Extra</h2>
                <div class="card rounded-2xl p-6">
                  <div class="form-row">
                    <input type="text" id="extra-income-desc" class="input-field" placeholder="Descri√ß√£o">
                    <input type="number" id="extra-income-amount" class="input-field" placeholder="Valor">
                    <input type="date" id="extra-income-date" class="input-field">
                  </div>
                  <button onclick="addExtraIncome()" class="btn btn-primary w-full">‚ûï Adicionar</button>
                </div>
              </div>

              <div class="section">
                <h2 class="section-title">üìú Hist√≥rico de Entradas</h2>
                <div id="income-history" class="space-y-3">
                  <p class="text-slate-400 text-center py-8">Nenhuma entrada</p>
                </div>
              </div>
            </div>

            <!-- Expenses View -->
            <div id="finance-expenses" class="finance-content hidden">
              <div class="section">
                <h2 class="section-title">‚ûï Nova Despesa</h2>
                <div class="card rounded-2xl p-6 space-y-4">
                  <input type="text" id="expense-desc" class="input-field w-full" placeholder="Descri√ß√£o">
                  <input type="number" id="expense-amount" class="input-field w-full" placeholder="Valor">
                  
                  <div class="form-row">
                    <select id="expense-category" class="input-field">
                      <option value="moradia">üè† Moradia</option>
                      <option value="alimentacao">üçΩÔ∏è Alimenta√ß√£o</option>
                      <option value="transporte">üöó Transporte</option>
                      <option value="saude">üè• Sa√∫de</option>
                      <option value="educacao">üìö Educa√ß√£o</option>
                      <option value="lazer">üéÆ Lazer</option>
                      <option value="vestuario">üëï Vestu√°rio</option>
                      <option value="servicos">üì± Servi√ßos</option>
                      <option value="outros">üì¶ Outros</option>
                    </select>
                    <button onclick="openModal('newcategory')" class="btn btn-secondary">+ Categoria</button>
                  </div>

                  <input type="date" id="expense-date" class="input-field w-full">
                  <input type="file" id="expense-photo" class="input-field w-full" accept="image/*">
                  <div id="expense-photo-preview" class="text-sm text-slate-400"></div>

                  <select id="expense-recurrence" class="input-field w-full">
                    <option value="once">Uma √∫nica vez</option>
                    <option value="weekly">Semanal</option>
                    <option value="biweekly">Quinzenal</option>
                    <option value="monthly">Mensal</option>
                    <option value="yearly">Anual</option>
                  </select>

                  <textarea id="expense-notes" class="input-field w-full" rows="2" placeholder="Observa√ß√µes..."></textarea>
                  <button onclick="addExpense()" class="btn btn-primary w-full">‚ûï Adicionar Despesa</button>
                </div>
              </div>

              <div class="section">
                <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
                  <h2 class="section-title">üìú Hist√≥rico de Despesas</h2>
                  <select id="expense-filter" onchange="filterExpenses()" class="input-field">
                    <option value="all">Todas</option>
                    <option value="moradia">üè† Moradia</option>
                    <option value="alimentacao">üçΩÔ∏è Alimenta√ß√£o</option>
                    <option value="transporte">üöó Transporte</option>
                    <option value="saude">üè• Sa√∫de</option>
                  </select>
                </div>
                <div id="expense-history" class="space-y-3">
                  <p class="text-slate-400 text-center py-8">Nenhuma despesa</p>
                </div>
              </div>
            </div>

            <!-- Report View -->
            <div id="finance-report" class="finance-content hidden">
              <div class="section">
                <h2 class="section-title">üìä Gerar Relat√≥rio</h2>
                <div class="card rounded-2xl p-6 space-y-4">
                  <div class="form-row">
                    <input type="date" id="report-start" class="input-field">
                    <input type="date" id="report-end" class="input-field">
                  </div>

                  <div>
                    <label class="block text-sm font-600 mb-3">Escopo do Relat√≥rio</label>
                    <div class="flex gap-4">
                      <label class="flex items-center gap-2">
                        <input type="radio" name="report-scope" value="individual" checked class="w-4 h-4">
                        <span>Meu Relat√≥rio</span>
                      </label>
                      <label id="family-scope-option" class="flex items-center gap-2">
                        <input type="radio" name="report-scope" value="family" class="w-4 h-4">
                        <span>Relat√≥rio Familiar</span>
                      </label>
                    </div>
                  </div>

                  <button onclick="generateReport()" class="btn btn-primary w-full">üìä Gerar Relat√≥rio</button>
                </div>
              </div>

              <div id="report-content" class="section card rounded-2xl p-6">
                <p class="text-slate-400 text-center py-8">Selecione datas e clique em "Gerar"</p>
              </div>
            </div>
          </div>

          <!-- Commitments Tab -->
          <div id="tab-commitments" class="tab-content hidden">
            <div class="section">
              <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
                <div>
                  <h2 class="section-title">üìä Divis√£o Percentual</h2>
                  <p class="section-description">Configure como dividir sua renda entre compromissos</p>
                </div>
                <button onclick="openModal('labels')" class="btn btn-secondary">‚úèÔ∏è Editar Nomes</button>
              </div>

              <div class="card rounded-2xl p-6 space-y-4">
                <div id="commitment-categories" class="space-y-4">
                  <div class="flex items-center gap-4 p-4 bg-slate-900/40 rounded-xl flex-col sm:flex-row">
                    <span class="text-3xl">üí≥</span>
                    <div class="flex-1">
                      <label class="block text-sm font-600 mb-2" id="label-expenses">Gastos Gerais</label>
                      <input type="number" id="commit-expenses" class="input-field w-full" value="70" min="0" max="100">
                    </div>
                    <span class="text-slate-400 font-600">%</span>
                  </div>

                  <div class="flex items-center gap-4 p-4 bg-slate-900/40 rounded-xl flex-col sm:flex-row">
                    <span class="text-3xl">üìà</span>
                    <div class="flex-1">
                      <label class="block text-sm font-600 mb-2" id="label-invest">Investimentos</label>
                      <input type="number" id="commit-invest" class="input-field w-full" value="20" min="0" max="100">
                    </div>
                    <span class="text-slate-400 font-600">%</span>
                  </div>

                  <div class="flex items-center gap-4 p-4 bg-slate-900/40 rounded-xl flex-col sm:flex-row">
                    <span class="text-3xl">‚õ™</span>
                    <div class="flex-1">
                      <label class="block text-sm font-600 mb-2" id="label-tithe">D√≠zimo/Doa√ß√µes</label>
                      <input type="number" id="commit-tithe" class="input-field w-full" value="10" min="0" max="100">
                    </div>
                    <span class="text-slate-400 font-600">%</span>
                  </div>

                  <div class="flex items-center gap-4 p-4 bg-slate-900/40 rounded-xl flex-col sm:flex-row">
                    <span class="text-3xl">üéØ</span>
                    <div class="flex-1">
                      <label class="block text-sm font-600 mb-2" id="label-emergency">Reserva de Emerg√™ncia</label>
                      <input type="number" id="commit-emergency" class="input-field w-full" value="0" min="0" max="100">
                    </div>
                    <span class="text-slate-400 font-600">%</span>
                  </div>
                </div>

                <div class="p-4 bg-emerald-500/10 border border-emerald-500/30 rounded-xl flex justify-between items-center">
                  <span class="font-600">Total:</span>
                  <span id="commit-total" class="text-2xl font-bold text-emerald-400">100%</span>
                </div>

                <button onclick="saveCommitments()" class="btn btn-primary w-full">üíæ Salvar Divis√£o</button>
              </div>
            </div>

            <div class="section">
              <h2 class="section-title">üí∞ Valores Calculados</h2>
              <p class="section-description">Baseado na sua renda mensal total</p>
              
              <div class="grid-4">
                <div class="card rounded-xl p-4">
                  <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">üí≥</span>
                    <span class="text-sm text-slate-400" data-commitment-label="expenses">Despesas</span>
                  </div>
                  <p class="text-xl font-bold text-white" id="val-expenses">R$ 0,00</p>
                </div>

                <div class="card rounded-xl p-4">
                  <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">üìà</span>
                    <span class="text-sm text-slate-400" data-commitment-label="invest">Investimentos</span>
                  </div>
                  <p class="text-xl font-bold text-emerald-400" id="val-invest">R$ 0,00</p>
                </div>

                <div class="card rounded-xl p-4">
                  <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">‚õ™</span>
                    <span class="text-sm text-slate-400" data-commitment-label="tithe">D√≠zimo</span>
                  </div>
                  <p class="text-xl font-bold text-purple-400" id="val-tithe">R$ 0,00</p>
                </div>

                <div class="card rounded-xl p-4">
                  <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">üéØ</span>
                    <span class="text-sm text-slate-400" data-commitment-label="emergency">Reserva</span>
                  </div>
                  <p class="text-xl font-bold text-blue-400" id="val-emergency">R$ 0,00</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Projections Tab -->
          <div id="tab-projections" class="tab-content hidden">
            <div class="section">
              <div class="flex items-center justify-between mb-4">
                <h2 class="section-title">üéØ Meus Objetivos</h2>
                <button onclick="openModal('goal')" class="btn btn-primary">‚ûï Novo</button>
              </div>
              <div id="goals-list" class="space-y-3">
                <p class="text-slate-400 text-center py-8">Nenhum objetivo cadastrado</p>
              </div>
            </div>

            <div class="section">
              <h2 class="section-title">üìú Hist√≥rico de Objetivos Conclu√≠dos</h2>
              <div id="completed-goals-list" class="space-y-3">
                <p class="text-slate-400 text-center py-8">Nenhum objetivo conclu√≠do</p>
              </div>
            </div>

            <div class="section">
              <h2 class="section-title">üí° Op√ß√µes de Investimento</h2>
              <div class="grid-3" id="investment-options">
                <div class="card rounded-xl p-4">
                  <div class="flex items-center gap-2 mb-2">
                    <span class="w-3 h-3 bg-emerald-500 rounded-full"></span>
                    <span class="font-6 text-white">SELIC</span>
                  </div>
                  <p class="text-sm text-slate-400 mb-1">Taxa atual: 10,75% a.a.</p>
                  <p class="text-xs text-slate-500">Baixo risco, liquidez di√°ria</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Modal -->
    <div id="generic-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="modal-title">Modal</h2>
          <button onclick="closeModal()" class="modal-close">‚úï</button>
        </div>
        <div id="modal-content" class="space-y-4">
          <!-- Content inserted here -->
        </div>
      </div>
    </div>

    <!-- Delete Modal -->
    <div id="delete-modal" class="modal-overlay">
      <div class="modal-content max-w-sm">
        <div class="text-center">
          <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500/20 flex items-center justify-center text-3xl">‚ö†Ô∏è</div>
          <h3 class="text-xl font-bold text-white mb-2">Confirmar Exclus√£o</h3>
          <p class="text-slate-400 mb-6" id="delete-message">Tem certeza que deseja excluir?</p>
          
          <div class="flex gap-3">
            <button onclick="closeDeleteModal()" class="flex-1 btn btn-outline">Cancelar</button>
            <button onclick="confirmDelete()" class="flex-1 btn btn-danger">Excluir</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Photo Modal -->
    <div id="photo-modal" class="modal-overlay">
      <div class="modal-content max-w-2xl">
        <div class="flex justify-between items-center mb-4">
          <h3 class="modal-title">Foto da Despesa</h3>
          <button onclick="closePhotoModal()" class="modal-close">‚úï</button>
        </div>
        <img id="photo-image" src="" alt="Foto" class="w-full rounded-xl mb-4">
        <button onclick="deleteExpensePhoto()" class="btn btn-danger w-full">üóëÔ∏è Remover Foto</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCsuSqpgmrch50wSSuvXe9v52R4Ztd1wkQ",
      authDomain: "cash-control-ef893.firebaseapp.com",
      projectId: "cash-control-ef893",
      storageBucket: "cash-control-ef893.firebasestorage.app",
      messagingSenderId: "417040011479",
      appId: "1:417040011479:web:173351e135d28ab1f9e092",
      measurementId: "G-S27QHKQ6C0"
    };
    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // App State
    let currentUser = null;
    let currentFamily = null;
    let currentFamilyData = null;
    let dashboardView = 'individual';
    let deleteCallback = null;
    
    // Commitment Labels (customizable names)
    let commitmentLabels = {
      expenses: 'Despesas',
      invest: 'Investimentos',
      tithe: 'D√≠zimo/Doa√ß√µes',
      emergency: 'Reserva de Emerg√™ncia'
    };
    
    // Default Config
    const defaultConfig = {
      app_title: 'Cash Control'
    };
    
    let config = { ...defaultConfig };
    
    // Vari√°vel para rastrear qual foto est√° sendo visualizada
    let currentViewingPhotoDocId = null;
    
    // Fun√ß√£o centralizada para fechar todos os modais
    function closeAllModals() {
      const allModals = [
        'generic-modal',
        'delete-modal',
        'photo-modal'
      ];
      
      allModals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.classList.remove('active');
        }
      });
    }
    
    // Fazer a fun√ß√£o acess√≠vel globalmente
    window.closeAllModals = closeAllModals;
    
    // Sistema de Modal Gen√©rico
    function closeModal() {
      document.getElementById('generic-modal').classList.remove('active');
    }
    
    function openModal(type) {
      closeAllModals();
      const modal = document.getElementById('generic-modal');
      const title = document.getElementById('modal-title');
      const content = document.getElementById('modal-content');
      
      const modals = {
        salary: {
          title: 'Adicionar Novo Sal√°rio',
          html: `
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Nome/Descri√ß√£o</label>
              <input type="text" id="modal-salary-name" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="Ex: Sal√°rio Principal">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Valor</label>
              <input type="number" id="modal-salary-amount" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="0,00" step="0.01">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Frequ√™ncia</label>
              <select id="modal-salary-frequency" class="input-dark w-full px-4 py-3 rounded-xl text-white">
                <option value="monthly">Mensal</option>
                <option value="biweekly">Quinzenal</option>
                <option value="weekly">Semanal</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Data de In√≠cio</label>
              <input type="date" id="modal-salary-start" class="input-dark w-full px-4 py-3 rounded-xl text-white">
            </div>
            <div class="flex gap-3 pt-4">
              <button onclick="closeModal()" class="flex-1 py-3 rounded-xl font-semibold text-slate-300 border border-slate-600 hover:border-slate-500">Cancelar</button>
              <button onclick="saveSalaryModal()" class="flex-1 py-3 rounded-xl font-semibold text-white btn-primary">Adicionar</button>
            </div>
          `
        },
        goal: {
          title: 'Adicionar Novo Objetivo',
          html: `
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Nome do Objetivo</label>
              <input type="text" id="modal-goal-name" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="Ex: Comprar um carro">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Valor Alvo (R$)</label>
              <input type="number" id="modal-goal-target" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="100000" step="0.01">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Data Limite (opcional)</label>
              <input type="date" id="modal-goal-deadline" class="input-dark w-full px-4 py-3 rounded-xl text-white">
            </div>
            <div class="flex gap-3 pt-4">
              <button onclick="closeModal()" class="flex-1 py-3 rounded-xl font-semibold text-slate-300 border border-slate-600 hover:border-slate-500">Cancelar</button>
              <button onclick="saveGoalModal()" class="flex-1 py-3 rounded-xl font-semibold text-white btn-primary">Adicionar</button>
            </div>
          `
        },
        labels: {
          title: 'Editar Nomes dos Compromissos',
          html: `
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">üí≥ Primeiro Compromisso</label>
              <input type="text" id="modal-label-expenses" class="input-dark w-full px-4 py-2 rounded-lg text-white" placeholder="ex: Despesas">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">üìà Segundo Compromisso</label>
              <input type="text" id="modal-label-invest" class="input-dark w-full px-4 py-2 rounded-lg text-white" placeholder="ex: Investimentos">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">‚õ™ Terceiro Compromisso</label>
              <input type="text" id="modal-label-tithe" class="input-dark w-full px-4 py-2 rounded-lg text-white" placeholder="ex: D√≠zimo/Doa√ß√µes">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">üéØ Quarto Compromisso</label>
              <input type="text" id="modal-label-emergency" class="input-dark w-full px-4 py-2 rounded-lg text-white" placeholder="ex: Reserva de Emerg√™ncia">
            </div>
            <div class="flex gap-3 pt-4">
              <button onclick="closeModal()" class="flex-1 py-3 rounded-xl font-semibold text-slate-300 border border-slate-600 hover:border-slate-500">Cancelar</button>
              <button onclick="saveLabelsModal()" class="flex-1 py-3 rounded-xl font-semibold text-white btn-primary">Salvar</button>
            </div>
          `
        },
        settings: {
          title: 'Configura√ß√µes da Fam√≠lia',
          html: `
            <h3 class="text-lg font-semibold text-white mb-3">Adicionar Membro</h3>
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Email do Membro</label>
              <input type="email" id="modal-member-email" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="email@exemplo.com">
              <p class="text-slate-500 text-xs mt-2">O membro precisa ter uma conta no Cash Control</p>
            </div>
            <div class="flex gap-3 pt-4">
              <button onclick="closeModal()" class="flex-1 py-3 rounded-xl font-semibold text-slate-300 border border-slate-600 hover:border-slate-500">Cancelar</button>
              <button onclick="saveMemberModal()" class="flex-1 py-3 rounded-xl font-semibold text-white btn-primary">Adicionar</button>
            </div>
          `
        },
        newcategory: {
          title: 'Nova Categoria de Despesa',
          html: `
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Emoji</label>
              <input type="text" id="modal-category-emoji" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="Ex: üé¨" maxlength="2">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Nome da Categoria</label>
              <input type="text" id="modal-category-name" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="Ex: Cinema">
            </div>
            <div class="flex gap-3 pt-4">
              <button onclick="closeModal()" class="flex-1 py-3 rounded-xl font-semibold text-slate-300 border border-slate-600 hover:border-slate-500">Cancelar</button>
              <button onclick="saveNewCategory()" class="flex-1 py-3 rounded-xl font-semibold text-white btn-primary">Criar</button>
            </div>
          `
        },
        'edit-income': {
          title: 'Editar Entrada',
          html: `
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Descri√ß√£o</label>
              <input type="text" id="edit-inc-desc" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="Ex: Freelance">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Valor</label>
              <input type="number" id="edit-inc-amount" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="0,00" step="0.01">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Data</label>
              <input type="date" id="edit-inc-date" class="input-dark w-full px-4 py-3 rounded-xl text-white">
            </div>
            <div class="flex gap-3 pt-4">
              <button onclick="closeModal()" class="flex-1 py-3 rounded-xl font-semibold text-slate-300 border border-slate-600 hover:border-slate-500">Cancelar</button>
              <button onclick="saveEditedTransaction()" class="flex-1 py-3 rounded-xl font-semibold text-white btn-primary">Salvar</button>
            </div>
          `
        },
        'edit-expense': {
          title: 'Editar Despesa',
          html: `
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Descri√ß√£o</label>
              <input type="text" id="edit-exp-desc" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="Ex: Supermercado">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Valor</label>
              <input type="number" id="edit-exp-amount" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="0,00" step="0.01">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Categoria</label>
              <select id="edit-exp-category" class="input-dark w-full px-4 py-3 rounded-xl text-white">
                <option value="moradia">üè† Moradia</option>
                <option value="alimentacao">üçΩÔ∏è Alimenta√ß√£o</option>
                <option value="transporte">üöó Transporte</option>
                <option value="saude">üè• Sa√∫de</option>
                <option value="educacao">üìö Educa√ß√£o</option>
                <option value="lazer">üéÆ Lazer</option>
                <option value="vestuario">üëï Vestu√°rio</option>
                <option value="servicos">üì± Servi√ßos</option>
                <option value="outros">üì¶ Outros</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Data</label>
              <input type="date" id="edit-exp-date" class="input-dark w-full px-4 py-3 rounded-xl text-white">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">üì∏ Foto da Conta (opcional)</label>
              <input type="file" id="edit-exp-photo" accept="image/*" class="input-dark w-full px-4 py-3 rounded-xl text-white file:bg-emerald-600 file:text-white file:border-0 file:rounded-lg file:cursor-pointer">
              <p class="text-slate-500 text-xs mt-1">JPG, PNG ou WebP (max 5MB)</p>
              <div id="edit-exp-photo-preview" class="mt-2 text-sm text-slate-400"></div>
            </div>
            <div class="flex gap-3 pt-4">
              <button onclick="closeModal()" class="flex-1 py-3 rounded-xl font-semibold text-slate-300 border border-slate-600 hover:border-slate-500">Cancelar</button>
              <button onclick="saveEditedTransaction()" class="flex-1 py-3 rounded-xl font-semibold text-white btn-primary">Salvar</button>
            </div>
          `
        },
        'edit-salary': {
          title: 'Editar Sal√°rio',
          html: `
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Nome/Descri√ß√£o</label>
              <input type="text" id="edit-sal-desc" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="Ex: Sal√°rio Principal">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Valor</label>
              <input type="number" id="edit-sal-amount" class="input-dark w-full px-4 py-3 rounded-xl text-white placeholder-slate-500" placeholder="0,00" step="0.01">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Frequ√™ncia</label>
              <select id="edit-sal-frequency" class="input-dark w-full px-4 py-3 rounded-xl text-white">
                <option value="monthly">Mensal</option>
                <option value="biweekly">Quinzenal</option>
                <option value="weekly">Semanal</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Data de In√≠cio</label>
              <input type="date" id="edit-sal-start" class="input-dark w-full px-4 py-3 rounded-xl text-white">
            </div>
            <div class="flex gap-3 pt-4">
              <button onclick="closeModal()" class="flex-1 py-3 rounded-xl font-semibold text-slate-300 border border-slate-600 hover:border-slate-500">Cancelar</button>
              <button onclick="saveEditedTransaction()" class="flex-1 py-3 rounded-xl font-semibold text-white btn-primary">Salvar</button>
            </div>
          `
        }
      };
      
      if (modals[type]) {
        title.textContent = modals[type].title;
        content.innerHTML = modals[type].html;
        modal.classList.add('active');
        // Auto-focus first input
        setTimeout(() => {
          const firstInput = content.querySelector('input');
          if (firstInput) firstInput.focus();
        }, 100);
      }
    }
    
    async function saveSalaryModal() {
      if (!currentFamily || !currentUser) {
        showToast('‚ö†Ô∏è', 'Selecione uma fam√≠lia');
        return;
      }
      
      const description = document.getElementById('modal-salary-name').value.trim();
      const amount = Number(document.getElementById('modal-salary-amount').value) || 0;
      const frequency = document.getElementById('modal-salary-frequency').value;
      const startDate = document.getElementById('modal-salary-start').value || '';
      
      if (!description || amount <= 0) {
        showToast('‚ö†Ô∏è', 'Preencha nome e valor');
        return;
      }
      
      try {
        await db.collection('transactions').add({
          familyId: currentFamily,
          userId: currentUser.uid,
          userName: currentUser.displayName || currentUser.email,
          type: 'salary',
          description,
          amount,
          frequency,
          startDate,
          isActive: true,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        closeModal();
        showToast('‚úÖ', 'Sal√°rio adicionado');
        if (typeof loadSalariesList === 'function') await loadSalariesList();
        if (typeof updateCommitmentValues === 'function') await updateCommitmentValues();
      } catch (error) {
        console.error('Error saving salary:', error);
        showToast('‚ùå', 'Erro ao salvar sal√°rio');
      }
    }
    
    async function saveGoalModal() {
      if (!currentFamily || !currentUser) {
        showToast('‚ö†Ô∏è', 'Selecione uma fam√≠lia');
        return;
      }
      
      const name = document.getElementById('modal-goal-name').value.trim();
      const targetAmount = Number(document.getElementById('modal-goal-target').value) || 0;
      const deadline = document.getElementById('modal-goal-deadline').value;
      
      if (!name || targetAmount <= 0) {
        showToast('‚ö†Ô∏è', 'Preencha nome e valor');
        return;
      }
      
      try {
        await db.collection('goals').add({
          familyId: currentFamily,
          userId: currentUser.uid,
          userName: currentUser.displayName || currentUser.email,
          name,
          targetAmount,
          deadline: deadline || null,
          progress: 0,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        closeModal();
        showToast('‚úÖ', 'Meta adicionada');
        if (typeof loadGoalsList === 'function') await loadGoalsList();
      } catch (error) {
        console.error('Error saving goal:', error);
        showToast('‚ùå', 'Erro ao adicionar meta');
      }
    }
    
    async function saveLabelsModal() {
      if (!currentFamily) {
        showToast('‚ö†Ô∏è', 'Selecione uma fam√≠lia primeiro');
        return;
      }
      
      commitmentLabels.expenses = document.getElementById('modal-label-expenses').value.trim() || 'Despesas';
      commitmentLabels.invest = document.getElementById('modal-label-invest').value.trim() || 'Investimentos';
      commitmentLabels.tithe = document.getElementById('modal-label-tithe').value.trim() || 'D√≠zimo/Doa√ß√µes';
      commitmentLabels.emergency = document.getElementById('modal-label-emergency').value.trim() || 'Reserva de Emerg√™ncia';
      
      // Update all labels in the UI
      document.getElementById('label-expenses').textContent = commitmentLabels.expenses;
      document.getElementById('label-invest').textContent = commitmentLabels.invest;
      document.getElementById('label-tithe').textContent = commitmentLabels.tithe;
      document.getElementById('label-emergency').textContent = commitmentLabels.emergency;
      
      // Save to Firestore
      try {
        const settingsRef = db.collection('familySettings').doc(currentFamily);
        const settingsDoc = await settingsRef.get();
        
        if (settingsDoc.exists) {
          // Update existing settings
          await settingsRef.update({
            commitmentLabels: commitmentLabels
          });
        } else {
          // Create new settings document
          await settingsRef.set({
            commitmentLabels: commitmentLabels,
            customCategories: []
          });
        }
        
        closeModal();
        showToast('‚úÖ', 'Nomes atualizados e salvos');
      } catch (error) {
        console.error('Error saving labels:', error);
        showToast('‚ùå', 'Erro ao salvar nomes');
      }
    }
    
    async function saveMemberModal() {
      if (!currentFamily || !currentFamilyData || currentFamilyData.ownerId !== currentUser.uid) {
        showToast('‚ö†Ô∏è', 'Apenas o propriet√°rio pode adicionar membros');
        return;
      }
      
      const email = document.getElementById('modal-member-email').value.trim();
      if (!email) {
        showToast('‚ö†Ô∏è', 'Digite um email');
        return;
      }
      
      try {
        await db.collection('families').doc(currentFamily).update({
          members: firebase.firestore.FieldValue.arrayUnion(email)
        });
        closeModal();
        showToast('‚úÖ', 'Membro adicionado');
      } catch (error) {
        console.error('Error adding member:', error);
        showToast('‚ùå', 'Erro ao adicionar membro');
      }
    }
    
    // Variable to store editing transaction data
    let editingTransactionId = null;
    let editingTransactionType = null;
    let expensePhotoBase64 = null; // Store current photo in base64
    let editExpensePhotoBase64 = null; // Store edit modal photo in base64
    
    // Compress and convert image to base64
    async function compressImageToBase64(file, maxWidth = 800, maxHeight = 800, quality = 0.7) {
      return new Promise((resolve, reject) => {
        if (!file) {
          resolve(null);
          return;
        }
        
        // Check file size (max 5MB for compression)
        if (file.size > 5 * 1024 * 1024) {
          reject(new Error('Arquivo muito grande. M√°ximo 5MB'));
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            // Resize if needed
            if (width > maxWidth || height > maxHeight) {
              const ratio = Math.min(maxWidth / width, maxHeight / height);
              width = Math.round(width * ratio);
              height = Math.round(height * ratio);
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // Determine format based on file type
            const format = file.type === 'image/png' ? 'image/png' : 'image/jpeg';
            const base64 = canvas.toDataURL(format, quality);
            resolve(base64);
          };
          img.onerror = () => reject(new Error('Falha ao carregar imagem'));
          img.src = e.target.result;
        };
        reader.onerror = () => reject(new Error('Falha ao ler arquivo'));
        reader.readAsDataURL(file);
      });
    }
    
    // Handle photo selection in add expense
    document.addEventListener('change', async function(e) {
      if (e.target.id === 'expense-photo') {
        const preview = document.getElementById('expense-photo-preview');
        const file = e.target.files[0];
        
        if (!file) {
          expensePhotoBase64 = null;
          preview.textContent = '';
          return;
        }
        
        try {
          preview.textContent = '‚è≥ Comprimindo imagem...';
          expensePhotoBase64 = await compressImageToBase64(file);
          preview.textContent = `‚úÖ Foto carregada (${(expensePhotoBase64.length / 1024).toFixed(1)}KB)`;
        } catch (error) {
          preview.textContent = `‚ùå ${error.message}`;
          expensePhotoBase64 = null;
        }
      }
      
      if (e.target.id === 'edit-exp-photo') {
        const preview = document.getElementById('edit-exp-photo-preview');
        const file = e.target.files[0];
        
        if (!file) {
          editExpensePhotoBase64 = null;
          preview.textContent = '';
          return;
        }
        
        try {
          preview.textContent = '‚è≥ Comprimindo imagem...';
          editExpensePhotoBase64 = await compressImageToBase64(file);
          preview.textContent = `‚úÖ Foto carregada (${(editExpensePhotoBase64.length / 1024).toFixed(1)}KB)`;
        } catch (error) {
          preview.textContent = `‚ùå ${error.message}`;
          editExpensePhotoBase64 = null;
        }
      }
    }, true);
    
    async function editTransaction(docId, type) {
      editingTransactionId = docId;
      editingTransactionType = type;
      
      try {
        const doc = await db.collection('transactions').doc(docId).get();
        if (!doc.exists) {
          showToast('‚ùå', 'Documento n√£o encontrado');
          return;
        }
        
        const data = doc.data();
        
        if (type === 'income') {
          openModal('edit-income');
          document.getElementById('edit-inc-desc').value = data.description || '';
          document.getElementById('edit-inc-amount').value = data.amount || '';
          document.getElementById('edit-inc-date').value = data.date || '';
        } else if (type === 'expense') {
          openModal('edit-expense');
          document.getElementById('edit-exp-desc').value = data.description || '';
          document.getElementById('edit-exp-amount').value = data.amount || '';
          document.getElementById('edit-exp-category').value = data.category || '';
          document.getElementById('edit-exp-date').value = data.date || '';
        } else if (type === 'salary') {
          openModal('edit-salary');
          document.getElementById('edit-sal-desc').value = data.description || '';
          document.getElementById('edit-sal-amount').value = data.amount || '';
          document.getElementById('edit-sal-frequency').value = data.frequency || 'monthly';
          document.getElementById('edit-sal-start').value = data.startDate || '';
        }
      } catch (error) {
        console.error('Error loading transaction:', error);
        showToast('‚ùå', 'Erro ao carregar dados');
      }
    }
    
    async function saveEditedTransaction() {
      if (!editingTransactionId || !editingTransactionType) {
        showToast('‚ùå', 'Erro: dados de edi√ß√£o n√£o inicializados');
        return;
      }
      
      try {
        const updateData = {};
        
        if (editingTransactionType === 'income') {
          updateData.description = document.getElementById('edit-inc-desc').value.trim();
          updateData.amount = Number(document.getElementById('edit-inc-amount').value) || 0;
          updateData.date = document.getElementById('edit-inc-date').value;
        } else if (editingTransactionType === 'expense') {
          updateData.description = document.getElementById('edit-exp-desc').value.trim();
          updateData.amount = Number(document.getElementById('edit-exp-amount').value) || 0;
          updateData.category = document.getElementById('edit-exp-category').value;
          updateData.date = document.getElementById('edit-exp-date').value;
          
          // Update photo if new one was selected
          if (editExpensePhotoBase64) {
            updateData.photoBase64 = editExpensePhotoBase64;
          }
        } else if (editingTransactionType === 'salary') {
          updateData.description = document.getElementById('edit-sal-desc').value.trim();
          updateData.amount = Number(document.getElementById('edit-sal-amount').value) || 0;
          updateData.frequency = document.getElementById('edit-sal-frequency').value;
          updateData.startDate = document.getElementById('edit-sal-start').value;
        }
        
        await db.collection('transactions').doc(editingTransactionId).update(updateData);
        
        closeModal();
        showToast('‚úÖ', 'Atualizado com sucesso');
        
        // Reload appropriate list
        if (editingTransactionType === 'income' && typeof loadIncomeHistory === 'function') {
          await loadIncomeHistory();
        } else if (editingTransactionType === 'expense' && typeof loadExpenseHistory === 'function') {
          await loadExpenseHistory();
        } else if (editingTransactionType === 'salary' && typeof loadSalariesList === 'function') {
          await loadSalariesList();
        }
        
        if (typeof updateCommitmentValues === 'function') await updateCommitmentValues();
        if (typeof updateDashboard === 'function') await updateDashboard();
        
        editingTransactionId = null;
        editingTransactionType = null;
      } catch (error) {
        console.error('Error saving transaction:', error);
        showToast('‚ùå', 'Erro ao salvar');
      }
    }
    
    async function deleteSalaryItem(docId) {
      if (!confirm('Deseja remover este sal√°rio?')) return;
      
      try {
        await db.collection('transactions').doc(docId).delete();
        showToast('‚úÖ', 'Sal√°rio removido');
        
        if (typeof loadSalariesList === 'function') await loadSalariesList();
        if (typeof updateCommitmentValues === 'function') await updateCommitmentValues();
        if (typeof updateDashboard === 'function') await updateDashboard();
      } catch (error) {
        console.error('Error deleting salary:', error);
        showToast('‚ùå', 'Erro ao remover');
      }
    }
    
    async function saveNewCategory() {
      if (!currentFamily) {
        showToast('‚ö†Ô∏è', 'Selecione uma fam√≠lia primeiro');
        return;
      }
      
      const emoji = document.getElementById('modal-category-emoji').value.trim();
      const name = document.getElementById('modal-category-name').value.trim();
      
      if (!emoji || !name) {
        showToast('‚ö†Ô∏è', 'Preencha emoji e nome');
        return;
      }
      
      const value = name.toLowerCase().replace(/\s+/g, '_');
      
      try {
        // Get current settings
        const settingsRef = db.collection('familySettings').doc(currentFamily);
        const settingsDoc = await settingsRef.get();
        
        let customCategories = [];
        if (settingsDoc.exists) {
          customCategories = settingsDoc.data().customCategories || [];
        }
        
        // Add new category
        const newCategory = { value, emoji, name };
        const categoryExists = customCategories.some(cat => cat.value === value);
        
        if (!categoryExists) {
          customCategories.push(newCategory);
          
          // Save to Firestore
          if (settingsDoc.exists) {
            await settingsRef.update({
              customCategories: customCategories
            });
          } else {
            await settingsRef.set({
              commitmentLabels: commitmentLabels,
              customCategories: customCategories
            });
          }
          
          // Add to select elements
          const select = document.getElementById('expense-category');
          const editSelect = document.getElementById('edit-exp-category');
          
          const option = document.createElement('option');
          option.value = value;
          option.textContent = `${emoji} ${name}`;
          select.appendChild(option);
          select.value = value;
          
          const editOption = document.createElement('option');
          editOption.value = value;
          editOption.textContent = `${emoji} ${name}`;
          editSelect.appendChild(editOption);
          
          closeModal();
          showToast('‚úÖ', `Categoria "${name}" criada e salva`);
        } else {
          showToast('‚ö†Ô∏è', 'Esta categoria j√° existe');
        }
      } catch (error) {
        console.error('Error saving category:', error);
        showToast('‚ùå', 'Erro ao salvar categoria');
      }
    }
    
    // Element SDK Integration
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (newConfig) => {
          config = { ...defaultConfig, ...newConfig };
          document.getElementById('app-title').textContent = config.app_title;
        },
        mapToCapabilities: (cfg) => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (cfg) => new Map([
          ['app_title', cfg.app_title || defaultConfig.app_title]
        ])
      });
    }
    
    // Auth State Observer
    auth.onAuthStateChanged((user) => {
      if (user) {
        currentUser = user;
        showFamilySelection();
      } else {
        currentUser = null;
        showLogin();
      }
    });
    
    // UI Navigation Functions
    function showLogin() {
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('family-screen').classList.add('hidden');
      document.getElementById('main-screen').classList.add('hidden');
      document.getElementById('login-form').classList.remove('hidden');
      document.getElementById('register-form').classList.add('hidden');
      hideBackToTop();
    }
    
    function showRegister() {
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('register-form').classList.remove('hidden');
      hideBackToTop();
    }
    
    function showFamilySelection() {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('family-screen').classList.remove('hidden');
      document.getElementById('main-screen').classList.add('hidden');
      loadUserFamilies();
      hideBackToTop();
    }
    
    function showMainApp() {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('family-screen').classList.add('hidden');
      document.getElementById('main-screen').classList.remove('hidden');
      loadFamilyData();
      initBackToTop();
      initTabsScrollIndicator();
    }
    
    function goToFamilySelection() {
      currentFamily = null;
      currentFamilyData = null;
      showFamilySelection();
    }
    
    // Auth Functions
    async function handleLogin() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const errorEl = document.getElementById('login-error');
      
      try {
        errorEl.classList.add('hidden');
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        
        // Validate user credentials and access rights
        const isValidUser = await validateUserCredentials(userCredential.user);
        
        if (isValidUser) {
          showToast('‚úÖ', 'Login realizado com sucesso!');
        } else {
          console.warn('User logged in but credentials validation failed');
          showToast('‚ö†Ô∏è', 'Login bem-sucedido. Aguarde valida√ß√£o das credenciais.');
        }
      } catch (error) {
        errorEl.textContent = getErrorMessage(error.code);
        errorEl.classList.remove('hidden');
      }
    }
    
    // Validate user credentials after login
    async function validateUserCredentials(user) {
      try {
        // Check if user document exists
        const userDoc = await db.collection('users').doc(user.uid).get();
        
        if (!userDoc.exists) {
          console.warn(`User document not found for ${user.email}`);
          return false;
        }
        
        const userData = userDoc.data();
        
        // Verify email matches
        if (userData.email !== user.email) {
          console.warn('Email mismatch for user:', user.uid);
          return false;
        }
        
        // Log successful validation
        console.log(`User ${user.email} credentials validated successfully`);
        return true;
      } catch (error) {
        console.error('Error validating user credentials:', error);
        return false;
      }
    }
    
    // Validate member login - helper function for family owners
    async function validateMemberLogin() {
      if (!currentFamily || !currentFamilyData) {
        showToast('‚ö†Ô∏è', 'Selecione uma fam√≠lia primeiro');
        return;
      }
      
      if (currentFamilyData.ownerId !== currentUser.uid) {
        showToast('‚ö†Ô∏è', 'Apenas o chefe pode validar membros');
        return;
      }
      
      const memberEmail = document.getElementById('validate-member-email').value.trim();
      if (!memberEmail) {
        showToast('‚ö†Ô∏è', 'Digite o email do membro');
        return;
      }
      
      try {
        // Check if member exists in the family
        const familyDoc = await db.collection('families').doc(currentFamily).get();
        if (!familyDoc.exists) {
          showToast('‚ùå', 'Fam√≠lia n√£o encontrada');
          return;
        }
        
        const familyData = familyDoc.data();
        const members = familyData.members || [];
        
        if (!members.includes(memberEmail)) {
          showToast('‚ùå', `${memberEmail} n√£o √© membro da fam√≠lia`);
          return;
        }
        
        // Check if user exists
        const userQuery = await db.collection('users').where('email', '==', memberEmail).get();
        if (userQuery.empty) {
          showToast('‚ùå', `Usu√°rio com email ${memberEmail} n√£o encontrado`);
          return;
        }
        
        const userData = userQuery.docs[0].data();
        
        // Verify access
        const hasValidAccess = await validateMemberAccess(currentFamily, userQuery.docs[0].id, memberEmail);
        
        if (hasValidAccess) {
          showToast('‚úÖ', `${userData.name || memberEmail} tem acesso √† fam√≠lia!`);
        } else {
          showToast('‚ö†Ô∏è', `${userData.name || memberEmail} foi adicionado mas pode precisar fazer login novamente`);
        }
        
        document.getElementById('validate-member-email').value = '';
      } catch (error) {
        console.error('Error validating member:', error);
        showToast('‚ùå', 'Erro ao validar membro');
      }
    }
    
    async function handleRegister() {
      const name = document.getElementById('register-name').value;
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;
      const errorEl = document.getElementById('register-error');
      
      if (!name || !email || !password) {
        errorEl.textContent = 'Preencha todos os campos';
        errorEl.classList.remove('hidden');
        return;
      }
      
      try {
        errorEl.classList.add('hidden');
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        await userCredential.user.updateProfile({ displayName: name });
        
        // Create user document
        await db.collection('users').doc(userCredential.user.uid).set({
          name: name,
          email: email,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showToast('‚úÖ', 'Conta criada com sucesso!');
      } catch (error) {
        errorEl.textContent = getErrorMessage(error.code);
        errorEl.classList.remove('hidden');
      }
    }
    
    function handleLogout() {
      auth.signOut();
      showToast('üëã', 'At√© logo!');
    }

    // UI Navigation: Dashboard View
    function setDashboardView(view) {
      window.dashboardView = view;
      document.querySelectorAll('.dashboard-view-btn').forEach(b => b.classList.remove('bg-emerald-600', 'text-white'));
      const btn = document.querySelector(`.dashboard-view-btn[data-view="${view}"]`);
      if (btn) btn.classList.add('bg-emerald-600', 'text-white');
      if (typeof updateDashboard === 'function') updateDashboard();
    }

    // UI Navigation: Finance View
    function setFinanceView(view) {
      document.querySelectorAll('.finance-content').forEach(el => el.classList.add('hidden'));
      const target = document.getElementById(`finance-${view}`);
      if (target) target.classList.remove('hidden');
      
      document.querySelectorAll('.finance-view-btn').forEach(b => b.classList.remove('bg-emerald-600', 'text-white'));
      const btn = document.querySelector(`.finance-view-btn[data-view="${view}"]`);
      if (btn) btn.classList.add('bg-emerald-600', 'text-white');

      if (view === 'income' && typeof loadSalariesList === 'function') loadSalariesList();
      else if (view === 'expenses') {
        // load expenses if needed
      }
    }

    // Commitment Edit Toggle
    // Commitment Edit Toggle removed

    // Income/Expense/Commitment loaders
    async function loadIncomeHistory() {
      if (!currentFamily || !currentUser) return;
      try {
        const query = db.collection('transactions')
          .where('familyId', '==', currentFamily)
          .where('type', '==', 'income')
          .where('userId', '==', currentUser.uid)
          .orderBy('date', 'desc')
          .limit(50);
        const snap = await query.get();
        const container = document.getElementById('income-history');
        if (!container) return;
        
        if (snap.empty) {
          container.innerHTML = '<p class="text-slate-500 text-center py-4">Nenhum ganho extra registrado</p>';
          return;
        }
        
        container.innerHTML = snap.docs.map(doc => {
          const inc = doc.data();
          const expensesPercent = parseFloat(document.getElementById('commit-expenses').value) || 70;
          const investPercent = parseFloat(document.getElementById('commit-invest').value) || 20;
          const tithePercent = parseFloat(document.getElementById('commit-tithe').value) || 0;
          const emergencyPercent = parseFloat(document.getElementById('commit-emergency').value) || 0;
          
          const expensesAmount = inc.amount * (expensesPercent / 100);
          const investAmount = inc.amount * (investPercent / 100);
          const titheAmount = inc.amount * (tithePercent / 100);
          const emergencyAmount = inc.amount * (emergencyPercent / 100);
          
          return `
            <div class="flex justify-between items-center p-3 bg-slate-800/30 rounded-lg" data-income-id="${doc.id}">
              <div class="min-w-0 flex-1 mr-2">
                <p class="text-white font-medium truncate">${inc.description}</p>
                <p class="text-slate-400 text-xs">${inc.date || ''}</p>
              </div>
              <div class="flex items-center gap-2 flex-shrink-0">
                <p class="font-semibold text-green-400 whitespace-nowrap">+ ${(typeof formatCurrency === 'function') ? formatCurrency(inc.amount) : 'R$ '+inc.amount.toFixed(2)}</p>
                <button onclick="editTransaction('${doc.id}', 'income')" class="text-emerald-400 hover:text-emerald-300 font-semibold text-sm" title="Editar">‚úèÔ∏è</button>
                <button onclick="deleteTransaction('${doc.id}')" class="text-red-400 hover:text-red-300 font-semibold text-sm" title="Excluir">üóëÔ∏è</button>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading income history:', error);
      }
    }

    async function loadExpenseHistory() {
      if (!currentFamily || !currentUser) return;
      try {
        const query = db.collection('transactions')
          .where('familyId', '==', currentFamily)
          .where('type', '==', 'expense')
          .where('userId', '==', currentUser.uid)
          .orderBy('date', 'desc')
          .limit(50);
        const snap = await query.get();
        const container = document.getElementById('expense-history');
        if (!container) return;
        
        if (snap.empty) {
          container.innerHTML = '<p class="text-slate-500 text-center py-4">Nenhuma despesa registrada</p>';
          return;
        }
        
        container.innerHTML = snap.docs.map(doc => {
          const exp = doc.data();
          const expensesPercent = parseFloat(document.getElementById('commit-expenses').value) || 70;
          const investPercent = parseFloat(document.getElementById('commit-invest').value) || 20;
          const tithePercent = parseFloat(document.getElementById('commit-tithe').value) || 0;
          const emergencyPercent = parseFloat(document.getElementById('commit-emergency').value) || 0;
          
          const expensesAmount = exp.amount * (expensesPercent / 100);
          const investAmount = exp.amount * (investPercent / 100);
          const titheAmount = exp.amount * (tithePercent / 100);
          const emergencyAmount = exp.amount * (emergencyPercent / 100);
          
          return `
            <div class="flex justify-between items-center p-3 bg-slate-800/30 rounded-lg" data-category="${exp.category || 'outros'}">
              <div class="min-w-0 flex-1 mr-2">
                <p class="text-white font-medium truncate">${exp.description}</p>
                <p class="text-slate-400 text-xs">${exp.date || ''}</p>
              </div>
              <div class="flex items-center gap-2 flex-shrink-0">
                <p class="font-semibold text-red-400 whitespace-nowrap">- ${(typeof formatCurrency === 'function') ? formatCurrency(exp.amount) : 'R$ '+exp.amount.toFixed(2)}</p>
                ${exp.photoBase64 ? `<button onclick="currentViewingPhotoDocId='${doc.id}'; viewExpensePhoto('${exp.photoBase64}')" class="text-blue-400 hover:text-blue-300 font-semibold text-sm" title="Ver Foto">üì∏</button>` : ''}
                <button onclick="editTransaction('${doc.id}', 'expense')" class="text-emerald-400 hover:text-emerald-300 font-semibold text-sm" title="Editar">‚úèÔ∏è</button>
                <button onclick="deleteTransaction('${doc.id}')" class="text-red-400 hover:text-red-300 font-semibold text-sm" title="Excluir">üóëÔ∏è</button>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading expense history:', error);
      }
    }

    // Delete transaction (income or expense)
    async function deleteTransaction(docId) {
      if (!confirm('Deseja remover esta transa√ß√£o?')) return;
      try {
        await db.collection('transactions').doc(docId).delete();
        if (typeof showToast === 'function') showToast('‚úÖ', 'Transa√ß√£o removida');
        if (typeof loadIncomeHistory === 'function') await loadIncomeHistory();
        if (typeof loadExpenseHistory === 'function') await loadExpenseHistory();
        if (typeof updateDashboard === 'function') updateDashboard();
      } catch (error) {
        console.error('Error deleting transaction:', error);
        if (typeof showToast === 'function') showToast('‚ùå', 'Erro ao remover');
      }
    }

    // Filter expenses by category
    function filterExpenses() {
      const filter = document.getElementById('expense-filter').value;
      const container = document.getElementById('expense-history');
      if (!container) return;
      
      const items = container.querySelectorAll('[data-category]');
      items.forEach(item => {
        if (filter === 'all' || item.getAttribute('data-category') === filter) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    }

    // loadCommitmentNames removed - function no longer needed

    async function loadGoalsList() {
      if (!currentFamily || !currentUser) return;
      try {
        const query = db.collection('goals')
          .where('familyId', '==', currentFamily)
          .where('userId', '==', currentUser.uid);
        const snap = await query.get();
        const goalsContainer = document.getElementById('goals-list');
        // cache goals for client calculations
        window._goalsCache = window._goalsCache || {};

        if (goalsContainer) {
          if (snap.empty) {
            goalsContainer.innerHTML = '<p class="text-slate-500 text-center py-4">Nenhuma meta cadastrada</p>';
          } else {
            const html = [];
            snap.forEach(doc => {
              const g = doc.data();
              // skip goals already concluded (filter on client side to avoid index creation)
              if (g.completed) return;
              const id = doc.id;
              window._goalsCache[id] = { progress: Number(g.progress || 0), target: Number(g.targetAmount || 0) };
              const progress = ((g.progress || 0) / (g.targetAmount || 1)) * 100;

              html.push(`
                <div class="p-4 bg-slate-800/40 rounded-lg" id="goal-${id}">
                  <div class="flex items-center justify-between mb-2">
                    <strong class="text-white truncate">${g.name}</strong>
                    <span class="text-xs text-slate-400 whitespace-nowrap">${Math.min(progress, 100).toFixed(0)}%</span>
                  </div>
                  <div class="w-full bg-slate-700 rounded-full h-2 mb-2">
                    <div class="bg-emerald-500 h-2 rounded-full" style="width: ${Math.min(progress, 100)}%"></div>
                  </div>
                  <p class="text-sm text-slate-300">${(typeof formatCurrency === 'function') ? formatCurrency(g.progress || 0) : 'R$ '+(g.progress || 0).toFixed(2)} / ${(typeof formatCurrency === 'function') ? formatCurrency(g.targetAmount) : 'R$ '+(g.targetAmount || 0).toFixed(2)}</p>
                  ${g.deadline ? `<p class="text-xs text-slate-500 mt-1">At√© ${g.deadline}</p>` : ''}

                  <div class="mt-3 p-3 bg-slate-800/30 rounded-lg">
                    <h5 class="text-sm font-semibold text-slate-200 mb-2">Estimativa com Aportes Mensais</h5>
                    <div class="flex flex-col sm:flex-row gap-2 mb-2 items-start sm:items-center">
                      <input type="number" min="0" step="0.01" id="goal-monthly-${id}" class="bg-slate-700 border border-slate-600 px-3 py-2 rounded-lg text-white text-sm w-full sm:w-44 goal-monthly" placeholder="Aporte mensal (R$)">
                      <button onclick="computeEstimatesForGoal('${id}')" class="px-3 py-2 rounded-lg text-sm bg-emerald-600 text-white w-full sm:w-auto">Calcular</button>
                      <button onclick="useAllInvestmentForGoal('${id}')" class="px-3 py-2 rounded-lg text-sm bg-slate-600 text-white w-full sm:w-auto">Usar todo investimento</button>
                    </div>
                    <div id="goal-estimates-${id}" class="space-y-2 text-sm text-slate-300">
                      <!-- estimates will render here -->
                      <p class="text-slate-500">Insira um aporte mensal e clique em Calcular</p>
                    </div>
                  </div>

                  <div class="mt-3 flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                    <input type="number" min="0" step="0.01" id="goal-add-${id}" class="bg-slate-700 border border-slate-600 px-3 py-2 rounded-lg text-white text-sm w-full sm:w-44" placeholder="Adicionar valor"/>
                    <button onclick="addToGoalProgress('${id}')" class="px-3 py-2 rounded-lg text-sm bg-emerald-600 text-white w-full sm:w-auto">Adicionar</button>
                  </div>

                  <div class="mt-3 flex gap-2 flex-col sm:flex-row">
                    <button onclick="completeGoal('${id}')" class="px-3 py-2 rounded-lg text-sm bg-blue-600 text-white w-full sm:w-auto">Concluir</button>
                    <button onclick="deleteGoal('${id}')" class="px-3 py-2 rounded-lg text-sm bg-red-600 text-white w-full sm:w-auto">Excluir</button>
                  </div>
                </div>
              `);
            });

            goalsContainer.innerHTML = html.join('');

            // attach listeners to monthly inputs (enter key also triggers)
            document.querySelectorAll('.goal-monthly').forEach(input => {
              input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                  const id = input.id.replace('goal-monthly-', '');
                  computeEstimatesForGoal(id);
                }
              });
              // mark user-edited so automatic distribution won't overwrite
              input.addEventListener('input', () => {
                input.dataset.userEdited = '1';
                const id = input.id.replace('goal-monthly-', '');
                // live update estimates while typing
                computeEstimatesForGoal(id);
              });
            });

            // load concluded goals history (if any)
            if (typeof loadCompletedGoals === 'function') loadCompletedGoals();
          }
        }
      } catch (error) {
        console.error('Error loading goals:', error);
      }
    }

    // Income Functions
    async function saveSatisfaction() {
      if (!currentFamily || !currentUser) {
        if (typeof showToast === 'function') showToast('‚ö†Ô∏è', 'Selecione uma fam√≠lia');
        return;
      }
      const satisfaction = document.getElementById('salary-satisfaction').value || 50;
      try {
        await db.collection('finances').doc(`${currentFamily}_satisfaction_${currentUser.uid}`).set({
          familyId: currentFamily,
          userId: currentUser.uid,
          satisfaction: Number(satisfaction),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        if (typeof showToast === 'function') showToast('‚úÖ', 'Satisfa√ß√£o salva!');
      } catch (error) {
        console.error('Error saving satisfaction:', error);
        if (typeof showToast === 'function') showToast('‚ùå', 'Erro ao salvar');
      }
    }

    async function addExtraIncome() {
      if (!currentFamily || !currentUser) {
        if (typeof showToast === 'function') showToast('‚ö†Ô∏è', 'Selecione uma fam√≠lia');
        return;
      }
      const desc = document.getElementById('extra-income-desc').value.trim();
      const amount = Number(document.getElementById('extra-income-amount').value) || 0;
      const date = document.getElementById('extra-income-date').value;

      if (!desc || amount <= 0 || !date) {
        if (typeof showToast === 'function') showToast('‚ö†Ô∏è', 'Preencha todos os campos');
        return;
      }

      try {
        await db.collection('transactions').add({
          familyId: currentFamily,
          userId: currentUser.uid,
          userName: currentUser.displayName || currentUser.email,
          type: 'income',
          description: desc,
          amount: amount,
          date: date,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('extra-income-desc').value = '';
        document.getElementById('extra-income-amount').value = '';
        document.getElementById('extra-income-date').value = '';
        if (typeof showToast === 'function') showToast('‚úÖ', 'Ganho extra adicionado!');
        if (typeof loadIncomeHistory === 'function') await loadIncomeHistory();
        if (typeof updateDashboard === 'function') updateDashboard();
      } catch (error) {
        console.error('Error adding extra income:', error);
        if (typeof showToast === 'function') showToast('‚ùå', 'Erro ao adicionar');
      }
    }

    // Expense Functions
    async function addExpense() {
      if (!currentFamily || !currentUser) {
        if (typeof showToast === 'function') showToast('‚ö†Ô∏è', 'Selecione uma fam√≠lia');
        return;
      }
      const desc = document.getElementById('expense-desc').value.trim();
      const category = document.getElementById('expense-category').value;
      const amount = Number(document.getElementById('expense-amount').value) || 0;
      const date = document.getElementById('expense-date').value;

      if (!desc || !category || amount <= 0 || !date) {
        if (typeof showToast === 'function') showToast('‚ö†Ô∏è', 'Preencha todos os campos');
        return;
      }

      try {
        const payload = {
          familyId: currentFamily,
          userId: currentUser.uid,
          userName: currentUser.displayName || currentUser.email,
          type: 'expense',
          description: desc,
          category: category,
          amount: amount,
          date: date,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Add photo if exists
        if (expensePhotoBase64) {
          payload.photoBase64 = expensePhotoBase64;
        }
        
        await db.collection('transactions').add(payload);
        document.getElementById('expense-desc').value = '';
        document.getElementById('expense-category').value = '';
        document.getElementById('expense-amount').value = '';
        document.getElementById('expense-date').value = '';
        document.getElementById('expense-photo').value = '';
        document.getElementById('expense-photo-preview').textContent = '';
        expensePhotoBase64 = null;
        if (typeof showToast === 'function') showToast('‚úÖ', 'Despesa adicionada!');
        if (typeof loadExpenseHistory === 'function') await loadExpenseHistory();
        if (typeof updateDashboard === 'function') updateDashboard();
      } catch (error) {
        console.error('Error adding expense:', error);
        if (typeof showToast === 'function') showToast('‚ùå', 'Erro ao adicionar');
      }
    }

    // Commitment Names Edit
    // saveCommitmentNames removed - function no longer needed

    // Goal Modal & Functions


    // Settings & Family Management

    
    async function loadFamilyMembersList(memberEmails) {
      const membersContainer = document.getElementById('family-members');
      if (!membersContainer) return;
      
      try {
        membersContainer.innerHTML = '<p class="text-slate-500 text-center py-4">Carregando membros...</p>';
        
        if (memberEmails.length === 0) {
          membersContainer.innerHTML = '<p class="text-slate-500 text-center py-4">Nenhum membro adicional</p>';
          return;
        }
        
        const membersList = [];
        for (const memberEmail of memberEmails) {
          try {
            // Query user by email
            const userQuery = await db.collection('users').where('email', '==', memberEmail).get();
            if (!userQuery.empty) {
              const userDoc = userQuery.docs[0];
              membersList.push({
                id: userDoc.id,
                email: memberEmail,
                ...userDoc.data()
              });
            }
          } catch (e) {
            console.error('Error loading member:', e);
          }
        }
        
        if (membersList.length === 0) {
          membersContainer.innerHTML = '<p class="text-slate-500 text-center py-4">Nenhum membro adicional</p>';
          return;
        }
        
        membersContainer.innerHTML = membersList.map(member => `
          <div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg">
            <div>
              <p class="text-white font-medium">${member.name || 'Usu√°rio'}</p>
              <p class="text-slate-400 text-sm">${member.email}</p>
            </div>
            <button onclick="removeFamilyMember('${member.email}')" class="text-red-400 hover:text-red-300 transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </button>
          </div>
        `).join('');
      } catch (error) {
        membersContainer.innerHTML = '<p class="text-red-400 text-center py-4">Erro ao carregar membros</p>';
        console.error('Error loading members list:', error);
      }
    }
    
    async function removeFamilyMember(memberEmail) {
      if (!currentFamily || currentFamilyData.ownerId !== currentUser.uid) {
        showToast('‚ö†Ô∏è', 'Apenas o chefe pode remover membros');
        return;
      }
      
      if (!confirm('Deseja remover este membro da fam√≠lia?')) return;
      
      try {
        await db.collection('families').doc(currentFamily).update({
          members: firebase.firestore.FieldValue.arrayRemove(memberEmail)
        });
        showToast('‚úÖ', 'Membro removido com sucesso');
      } catch (error) {
        showToast('‚ùå', 'Erro ao remover membro');
        console.error('Error removing member:', error);
      }
    }

    async function addFamilyMember() {
      if (!currentFamily || !currentFamilyData) {
        if (typeof showToast === 'function') showToast('‚ö†Ô∏è', 'Selecione uma fam√≠lia');
        return;
      }
      if (currentFamilyData.ownerId !== currentUser.uid) {
        if (typeof showToast === 'function') showToast('‚ö†Ô∏è', 'Apenas o chefe pode adicionar membros');
        return;
      }
      const email = document.getElementById('add-member-email').value.trim();
      if (!email) {
        if (typeof showToast === 'function') showToast('‚ö†Ô∏è', 'Digite um email');
        return;
      }
      try {
        const usersQuery = await db.collection('users').where('email', '==', email).get();
        if (usersQuery.empty) {
          if (typeof showToast === 'function') showToast('‚ö†Ô∏è', 'Usu√°rio n√£o encontrado');
          return;
        }
        const userId = usersQuery.docs[0].id;
        const userData = usersQuery.docs[0].data();
        const userEmail = userData.email;
        
        const familyRef = db.collection('families').doc(currentFamily);
        
        // Validate and add member with both userId and email for access verification
        await validateAndAddMember(familyRef, userId, userEmail, currentFamily);
        
        document.getElementById('add-member-email').value = '';
        if (typeof showToast === 'function') showToast('‚úÖ', 'Membro adicionado com sucesso!');
      } catch (error) {
        console.error('Error adding member:', error);
        if (typeof showToast === 'function') showToast('‚ùå', 'Erro ao adicionar membro');
      }
    }

    // Validate and add member with credentials verification
    async function validateAndAddMember(familyRef, userId, userEmail, familyId) {
      try {
        // Verify that user exists and has valid credentials
        const userDoc = await db.collection('users').doc(userId).get();
        if (!userDoc.exists) {
          throw new Error('Usu√°rio n√£o encontrado na base de dados');
        }
        
        const userData = userDoc.data();
        
        // Add member using email for compatibility with existing queries
        await familyRef.update({
          members: firebase.firestore.FieldValue.arrayUnion(userEmail)
        });
        
        // Also store member info for validation purposes
        const memberData = {
          familyId: familyId,
          userId: userId,
          userEmail: userEmail,
          userName: userData.name || 'Usu√°rio',
          addedAt: firebase.firestore.FieldValue.serverTimestamp(),
          status: 'active',
          validated: true
        };
        
        // Create a member access log for audit purposes
        await db.collection('family_members').add(memberData);
        
        console.log(`Member ${userEmail} validated and added to family ${familyId}`);
      } catch (error) {
        console.error('Error validating member:', error);
        throw error;
      }
    }

    function confirmDeleteFamily() {
      if (currentFamilyData && currentFamilyData.ownerId !== currentUser.uid) {
        if (typeof showToast === 'function') showToast('‚ö†Ô∏è', 'Apenas o chefe pode excluir');
        return;
      }
      closeAllModals();
      const modal = document.getElementById('delete-modal');
      if (modal) modal.classList.add('active');
    }

    function leaveFamily() {
      if (!currentFamily) return;
      if (confirm('Tem certeza que deseja sair desta fam√≠lia?')) {
        db.collection('families').doc(currentFamily).update({
          members: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
        }).then(() => {
          if (typeof showToast === 'function') showToast('‚úÖ', 'Voc√™ saiu da fam√≠lia');
          goToFamilySelection();
        }).catch(error => {
          console.error('Error leaving family:', error);
          if (typeof showToast === 'function') showToast('‚ùå', 'Erro ao sair');
        });
      }
    }

    function closeDeleteModal() {
      closeAllModals();
    }

    async function confirmDelete() {
      if (!currentFamily || !currentFamilyData) {
        if (typeof showToast === 'function') showToast('‚ö†Ô∏è', 'Nenhuma fam√≠lia selecionada');
        return;
      }
      if (currentFamilyData.ownerId !== currentUser.uid) {
        if (typeof showToast === 'function') showToast('‚ö†Ô∏è', 'Apenas o chefe pode excluir');
        return;
      }
      try {
        await db.collection('families').doc(currentFamily).delete();
        closeDeleteModal();
        if (typeof showToast === 'function') showToast('‚úÖ', 'Fam√≠lia exclu√≠da!');
        goToFamilySelection();
      } catch (error) {
        console.error('Error deleting family:', error);
        if (typeof showToast === 'function') showToast('‚ùå', 'Erro ao excluir');
      }
    }

    // Report export (supports CSV for now)
async function generateReport() {
  if (!currentFamily || !currentFamilyData) return;

  const startDate = document.getElementById('report-start').value;
  const endDate = document.getElementById('report-end').value;

  if (!startDate || !endDate) {
    showToast('‚ö†Ô∏è', 'Selecione as datas');
    return;
  }

  const reportEl = document.getElementById('report-content');

  try {
    reportEl.innerHTML = '<p class="text-slate-500 text-center py-8">Gerando relat√≥rio...</p>';

    // queries de entradas e despesas com base no escopo selecionado (individual ou familiar)
    let incomeQuery, expenseQuery;
    const scope = document.querySelector('input[name="report-scope"]:checked')?.value || 'individual';

    if (scope === 'individual') {
      incomeQuery = db.collection('transactions')
        .where('familyId', '==', currentFamily)
        .where('type', '==', 'income')
        .where('userId', '==', currentUser.uid);

      expenseQuery = db.collection('transactions')
        .where('familyId', '==', currentFamily)
        .where('type', '==', 'expense')
        .where('userId', '==', currentUser.uid);
    } else {
      // family scope requested
      if (!currentFamilyData || currentFamilyData.ownerId !== currentUser.uid) {
        if (typeof showToast === 'function') showToast('‚ö†Ô∏è', 'Apenas o chefe pode gerar relat√≥rio familiar');
        reportEl.innerHTML = '<p class="text-red-400 text-center py-8">Apenas o chefe da fam√≠lia pode gerar relat√≥rio familiar</p>';
        return;
      }
      incomeQuery = db.collection('transactions')
        .where('familyId', '==', currentFamily)
        .where('type', '==', 'income');
      expenseQuery = db.collection('transactions')
        .where('familyId', '==', currentFamily)
        .where('type', '==', 'expense');
    }

    const [incomeSnap, expenseSnap, salarySnap] = await Promise.all([
      incomeQuery.get(),
      expenseQuery.get(),
      db.collection('transactions').where('familyId', '==', currentFamily).where('type', '==', 'salary').get()
    ]);

    let totalIncome = 0;
    let totalExpenses = 0;
    const incomeItems = [];
    const expenseItems = [];
    const categoryTotals = {};

    // incluir sal√°rios como entradas proporcionais ao per√≠odo
    const months = monthsBetweenInclusive(startDate, endDate);

    salarySnap.forEach(doc => {
      const s = doc.data();
      // verificar se o sal√°rio est√° ativo dentro do per√≠odo
      const startOk = s.startDate <= endDate;
      const endOk = !s.endDate || s.endDate >= startDate;
      if (startOk && endOk) {
        const monthly = calculateMonthlySalary(s.amount, s.frequency);
        const totalForPeriod = monthly * months;
        totalIncome += totalForPeriod;
        incomeItems.push({
          date: `${startDate} ‚Üí ${endDate}`,
          description: `Sal√°rio: ${s.description} (${months} m√™s${months>1?'es':''})`,
          amount: totalForPeriod,
          userName: s.userName || s.userId
        });
      }
    });

    incomeSnap.forEach(doc => {
      const data = doc.data();
      if (data.date >= startDate && data.date <= endDate) {
        totalIncome += Number(data.amount);
        incomeItems.push(data);
      }
    });

    expenseSnap.forEach(doc => {
      const data = doc.data();
      if (data.date >= startDate && data.date <= endDate) {
        totalExpenses += Number(data.amount);
        expenseItems.push(data);
        categoryTotals[data.category] = (categoryTotals[data.category] || 0) + Number(data.amount);
      }
    });

    const balance = totalIncome - totalExpenses;

    // Monta HTML do relat√≥rio (manter exporta√ß√£o separada)
    reportEl.innerHTML = `
      <h3 class="text-lg font-semibold text-white mb-4">Relat√≥rio: ${formatDate(startDate)} a ${formatDate(endDate)}</h3>
      <button onclick="downloadReport('${startDate}', '${endDate}')" class="btn-primary px-4 py-2 rounded-lg text-sm font-medium mb-4 w-full sm:w-auto">üì• Exportar CSV</button>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="p-4 bg-emerald-500/10 border border-emerald-500/30 rounded-xl">
          <p class="text-slate-400 text-sm">Total de Entradas</p>
          <p class="text-2xl font-bold text-emerald-400">${formatCurrency(totalIncome)}</p>
          <p class="text-xs text-slate-500">${incomeItems.length} transa√ß√µes</p>
        </div>
        <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-xl">
          <p class="text-slate-400 text-sm">Total de Despesas</p>
          <p class="text-2xl font-bold text-red-400">${formatCurrency(totalExpenses)}</p>
          <p class="text-xs text-slate-500">${expenseItems.length} transa√ß√µes</p>
        </div>
        <div class="p-4 ${balance >= 0 ? 'bg-blue-500/10 border-blue-500/30' : 'bg-red-500/10 border-red-500/30'} border rounded-xl">
          <p class="text-slate-400 text-sm">Saldo do Per√≠odo</p>
          <p class="text-2xl font-bold ${balance >= 0 ? 'text-blue-400' : 'text-red-400'}">${formatCurrency(balance)}</p>
          <p class="text-xs text-slate-500">${balance >= 0 ? 'Positivo' : 'Negativo'}</p>
        </div>
      </div>

      <h4 class="font-semibold text-white mb-3">Despesas por Categoria</h4>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
        ${Object.entries(categoryTotals).sort((a,b)=>b[1]-a[1]).map(([cat, amount]) => `
          <div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg">
            <span class="text-slate-300">${getCategoryLabel(cat)}</span>
            <span class="font-semibold text-white">${formatCurrency(amount)}</span>
          </div>
        `).join('')}
      </div>

      ${incomeItems.length > 0 ? `
        <h4 class="font-semibold text-white mb-3">Detalhamento de Entradas</h4>
        <div class="space-y-2 mb-6 max-h-48 overflow-y-auto scrollbar-thin">
          ${incomeItems.sort((a,b)=> (new Date(b.date)-new Date(a.date))).map(item => `
            <div class="flex justify-between p-2 bg-slate-800/30 rounded-lg text-sm flex-col sm:flex-row">
              <span class="text-slate-300">${item.description} <span class="text-slate-500">(${item.date})</span></span>
              <span class="text-emerald-400 font-medium">+ ${formatCurrency(item.amount)}</span>
            </div>
          `).join('')}
        </div>
      ` : ''}

      ${expenseItems.length > 0 ? `
        <h4 class="font-semibold text-white mb-3">Detalhamento de Despesas</h4>
        <div class="space-y-2 max-h-48 overflow-y-auto scrollbar-thin">
          ${expenseItems.sort((a,b)=> (new Date(b.date)-new Date(a.date))).map(item => `
            <div class="flex justify-between p-2 bg-slate-800/30 rounded-lg text-sm flex-col sm:flex-row">
              <span class="text-slate-300">${item.description} <span class="text-slate-500">(${item.date})</span></span>
              <span class="text-red-400 font-medium">- ${formatCurrency(item.amount)}</span>
            </div>
          `).join('')}
        </div>
      ` : ''}
    `;

  } catch (error) {
    reportEl.innerHTML = '<p class="text-red-400 text-center py-8">Erro ao gerar relat√≥rio</p>';
    console.error('Error generating report:', error);
  }
}


    function getErrorMessage(code) {
      const messages = {
        'auth/invalid-email': 'Email inv√°lido',
        'auth/user-disabled': 'Usu√°rio desativado',
        'auth/user-not-found': 'Usu√°rio n√£o encontrado',
        'auth/wrong-password': 'Senha incorreta',
        'auth/email-already-in-use': 'Email j√° est√° em uso',
        'auth/weak-password': 'Senha muito fraca (m√≠nimo 6 caracteres)',
        'auth/invalid-credential': 'Credenciais inv√°lidas'
      };
      return messages[code] || 'Erro ao processar. Tente novamente.';
    }
    
    // Family Functions
    async function loadUserFamilies() {
      if (!currentUser) return;
      
      const familyList = document.getElementById('family-list');
      familyList.innerHTML = '<p class="text-slate-500 text-center py-4">Carregando...</p>';
      
      try {
        const ownedFamilies = await db.collection('families')
          .where('ownerId', '==', currentUser.uid)
          .get();
        
        const memberFamilies = await db.collection('families')
          .where('members', 'array-contains', currentUser.email)
          .get();
        
        const validatedFamilies = [];
        
        for (const doc of ownedFamilies.docs) {
          validatedFamilies.push({ id: doc.id, ...doc.data(), isOwner: true, validated: true });
        }
        
        for (const doc of memberFamilies.docs) {
          if (!validatedFamilies.find(f => f.id === doc.id)) {
            const isValidMember = await validateMemberAccess(doc.id, currentUser.uid, currentUser.email);
            if (isValidMember) {
              validatedFamilies.push({ id: doc.id, ...doc.data(), isOwner: false, validated: true });
            }
          }
        }
        
        const families = validatedFamilies;
        
        if (families.length === 0) {
          familyList.innerHTML = '<p class="text-slate-500 text-center py-4">Voc√™ ainda n√£o tem fam√≠lias. Crie uma abaixo!</p>';
          return;
        }
        
        familyList.innerHTML = families.map(family => `
          <button onclick="selectFamily('${family.id}')" class="w-full p-4 bg-slate-800/50 hover:bg-slate-700/50 rounded-xl flex items-center justify-between transition-all group">
            <div class="flex items-center gap-3">
              <span class="text-2xl">${family.isOwner ? 'üëë' : 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶'}</span>
              <div class="text-left min-w-0">
                <p class="font-medium text-white group-hover:text-emerald-400 transition-colors truncate">${family.name}</p>
                <p class="text-xs text-slate-500">${family.isOwner ? 'Voc√™ √© o chefe' : 'Membro'}</p>
              </div>
            </div>
            <svg class="w-5 h-5 text-slate-500 group-hover:text-emerald-400 transition-colors flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </button>
        `).join('');
      } catch (error) {
        familyList.innerHTML = '<p class="text-red-400 text-center py-4">Erro ao carregar fam√≠lias</p>';
        console.error('Error loading families:', error);
      }
    }
    
    async function validateMemberAccess(familyId, userId, userEmail) {
      try {
        const familyDoc = await db.collection('families').doc(familyId).get();
        if (!familyDoc.exists) {
          console.warn(`Family ${familyId} not found`);
          return false;
        }
        
        const members = familyDoc.data().members || [];
        
        if (members.includes(userEmail)) {
          const memberRecords = await db.collection('family_members')
            .where('familyId', '==', familyId)
            .where('userEmail', '==', userEmail)
            .where('status', '==', 'active')
            .get();
          
          if (!memberRecords.empty) {
            return true;
          }
          
          console.log(`Member ${userEmail} in family ${familyId} without validation record (legacy)`);
          return true;
        }
        
        return false;
      } catch (error) {
        console.error('Error validating member access:', error);
        return false;
      }
    }
    
    async function createFamily() {
      const nameInput = document.getElementById('new-family-name');
      const name = nameInput.value.trim();
      
      if (!name) {
        showToast('‚ö†Ô∏è', 'Digite o nome da fam√≠lia');
        return;
      }
      
      const collectionName = `Cash Control_${name.toLowerCase().replace(/\s+/g, '_')}`;
      
      try {
        await db.collection('families').add({
          name: name,
          collectionName: collectionName,
          ownerId: currentUser.uid,
          ownerEmail: currentUser.email,
          ownerName: currentUser.displayName || 'Usu√°rio',
          members: [],
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        nameInput.value = '';
        showToast('‚úÖ', `Fam√≠lia "${name}" criada!`);
        loadUserFamilies();
      } catch (error) {
        showToast('‚ùå', 'Erro ao criar fam√≠lia');
        console.error('Error creating family:', error);
      }
    }
    
    async function selectFamily(familyId) {
      currentFamily = familyId;
      
      try {
        const doc = await db.collection('families').doc(familyId).get();
        if (doc.exists) {
          currentFamilyData = { id: doc.id, ...doc.data() };
          document.getElementById('current-family-name').textContent = currentFamilyData.name;
          document.getElementById('current-user-name').textContent = currentUser.displayName || currentUser.email;
          
          await loadFamilySettings(familyId);
          
          showMainApp();
        }
      } catch (error) {
        showToast('‚ùå', 'Erro ao selecionar fam√≠lia');
        console.error('Error selecting family:', error);
      }
    }
    
    async function loadFamilySettings(familyId) {
      try {
        const settingsDoc = await db.collection('familySettings').doc(familyId).get();
        if (settingsDoc.exists) {
          const settings = settingsDoc.data();
          
          if (settings.commitmentLabels) {
            commitmentLabels = { ...commitmentLabels, ...settings.commitmentLabels };
          }
          
          document.getElementById('label-expenses').textContent = commitmentLabels.expenses;
          document.getElementById('label-invest').textContent = commitmentLabels.invest;
          document.getElementById('label-tithe').textContent = commitmentLabels.tithe;
          document.getElementById('label-emergency').textContent = commitmentLabels.emergency;
          
          if (settings.customCategories && Array.isArray(settings.customCategories)) {
            const categorySelect = document.getElementById('expense-category');
            const editCategorySelect = document.getElementById('edit-exp-category');
            
            if (categorySelect && editCategorySelect) {
              const defaultCategories = ['moradia', 'alimentacao', 'transporte', 'saude', 'educacao', 'lazer', 'vestuario', 'servicos', 'outros'];
              const optionsToRemove = Array.from(categorySelect.options).filter(opt => !defaultCategories.includes(opt.value));
              optionsToRemove.forEach(opt => opt.remove());
              
              settings.customCategories.forEach(category => {
                const option1 = document.createElement('option');
                option1.value = category.value;
                option1.textContent = `${category.emoji} ${category.name}`;
                categorySelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = category.value;
                option2.textContent = `${category.emoji} ${category.name}`;
                editCategorySelect.appendChild(option2);
              });
            }
          }
        }
      } catch (error) {
        console.error('Error loading family settings:', error);
      }
    }

    function viewExpensePhoto(photoBase64) {
      const photoModal = document.getElementById('photo-modal');
      const photoImage = document.getElementById('photo-image');
      
      if (!photoModal || !photoImage) return;
      
      photoImage.src = photoBase64;
      photoModal.classList.add('active');
    }

    function closePhotoModal() {
      const photoModal = document.getElementById('photo-modal');
      if (photoModal) {
        photoModal.classList.remove('active');
      }
    }

    async function deleteExpensePhoto() {
      if (!currentViewingPhotoDocId) {
        showToast('‚ùå', 'Erro ao remover foto');
        return;
      }

      try {
        const docRef = db.collection('transactions').doc(currentViewingPhotoDocId);
        await docRef.update({
          photoBase64: firebase.firestore.FieldValue.delete()
        });
        showToast('‚úÖ', 'Foto removida com sucesso');
        closePhotoModal();
        loadExpenseHistory();
      } catch (error) {
        console.error('Error deleting photo:', error);
        showToast('‚ùå', 'Erro ao remover foto');
      }
    }
    
    function showToast(icon, message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = `${icon} ${message}`;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'fadeOut 0.3s ease-out forwards';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    async function updateDashboard() {
      if (!currentFamily || !currentUser) return;
      try {
        const isFamily = (window.dashboardView === 'family');
        let incomeQuery, expenseQuery;
        
        if (isFamily) {
          incomeQuery = db.collection('transactions')
            .where('familyId', '==', currentFamily)
            .where('type', 'in', ['income', 'salary']);
          expenseQuery = db.collection('transactions')
            .where('familyId', '==', currentFamily)
            .where('type', '==', 'expense');
        } else {
          incomeQuery = db.collection('transactions')
            .where('familyId', '==', currentFamily)
            .where('type', 'in', ['income', 'salary'])
            .where('userId', '==', currentUser.uid);
          expenseQuery = db.collection('transactions')
            .where('familyId', '==', currentFamily)
            .where('type', '==', 'expense')
            .where('userId', '==', currentUser.uid);
        }

        const incomeSnap = await incomeQuery.get();
        const expenseSnap = await expenseQuery.get();
        
        let satisfaction = 50;
        if (!isFamily) {
          const satSnap = await db.collection('finances')
            .doc(`${currentFamily}_satisfaction_${currentUser.uid}`).get();
          if (satSnap.exists && satSnap.data().satisfaction !== undefined) {
            satisfaction = satSnap.data().satisfaction;
          }
        }
        
        let totalIncome = 0, totalExpenses = 0;
        const txList = [];

        incomeSnap.forEach(doc => {
          const data = doc.data();
          totalIncome += Number(data.amount || 0);
          txList.push({ ...data, id: doc.id });
        });

        expenseSnap.forEach(doc => {
          const data = doc.data();
          totalExpenses += Number(data.amount || 0);
          txList.push({ ...data, id: doc.id });
        });

        const balance = totalIncome - totalExpenses;

        const incomeEl = document.getElementById('dash-total-income');
        const expenseEl = document.getElementById('dash-total-expenses');
        const balanceEl = document.getElementById('dash-balance');

        if (incomeEl) incomeEl.textContent = (typeof formatCurrency === 'function') ? formatCurrency(totalIncome) : 'R$ '+totalIncome.toFixed(2);
        if (expenseEl) expenseEl.textContent = (typeof formatCurrency === 'function') ? formatCurrency(totalExpenses) : 'R$ '+totalExpenses.toFixed(2);
        if (balanceEl) {
          balanceEl.textContent = (typeof formatCurrency === 'function') ? formatCurrency(balance) : 'R$ '+balance.toFixed(2);
          balanceEl.className = 'text-2xl font-bold ' + (balance >= 0 ? 'text-blue-400' : 'text-red-400');
        }

        const txContainer = document.getElementById('recent-transactions');
        if (txContainer) {
          if (txList.length === 0) {
            txContainer.innerHTML = '<p class="text-slate-500 text-center py-4">Nenhuma transa√ß√£o</p>';
          } else {
            txContainer.innerHTML = txList.sort((a, b) => (b.date || '').localeCompare(a.date || '')).slice(0, 5).map(tx => `
              <div class="list-item">
                <div class="list-item-content">
                  <p class="list-item-title">${tx.description || tx.type}</p>
                  <p class="list-item-subtitle">${tx.date || ''}</p>
                </div>
                <p class="list-item-value ${tx.type === 'expense' ? 'text-red-400' : 'text-emerald-400'}">
                  ${tx.type === 'expense' ? '- ' : '+ '}${(typeof formatCurrency === 'function') ? formatCurrency(tx.amount) : 'R$ '+tx.amount.toFixed(2)}
                </p>
              </div>
            `).join('');
          }
        }
        
        const satisfactionEl = document.getElementById('satisfaction-value');
        const satisfactionRing = document.getElementById('satisfaction-ring');
        if (satisfactionEl) satisfactionEl.textContent = satisfaction + '%';
        if (satisfactionRing) {
          const circumference = 2 * Math.PI * 56;
          const offset = circumference - (satisfaction / 100) * circumference;
          satisfactionRing.style.strokeDashoffset = offset;
        }
        
        const slider = document.getElementById('salary-satisfaction');
        if (slider) slider.value = satisfaction;
        const display = document.getElementById('satisfaction-display');
        if (display) display.textContent = satisfaction + '%';
      } catch (error) {
        console.error('Error updating dashboard:', error);
      }
    }
    
    async function loadFamilyData() {
      if (!currentFamily || !currentFamilyData) return;
      
      try {
        const commitDoc = await db.collection('finances')
          .doc(`${currentFamily}_commitments_${currentUser.uid}`).get();
        if (commitDoc.exists) {
          const data = commitDoc.data();
          document.getElementById('commit-expenses').value = data.expenses || 70;
          document.getElementById('commit-invest').value = data.invest || 20;
          document.getElementById('commit-tithe').value = data.tithe || 10;
          document.getElementById('commit-emergency').value = data.emergency || 0;
        }
        
        await loadCommitmentLabels();
        
        await loadSalariesList();
        await loadIncomeHistory();
        await loadExpenseHistory();
        await loadGoalsList();
        
        const familyScopeOption = document.getElementById('family-scope-option');
        if (familyScopeOption) {
          if (currentFamilyData && currentFamilyData.ownerId === currentUser.uid) {
            familyScopeOption.style.display = '';
          } else {
            familyScopeOption.style.display = 'none';
            const ind = document.querySelector('input[name="report-scope"][value="individual"]');
            if (ind) ind.checked = true;
          }
        }
        await updateDashboard();
        await updateCommitmentValues();
      } catch (error) {
        console.error('Error loading family data:', error);
      }
    }
    
    document.getElementById('salary-satisfaction').addEventListener('input', function() {
      document.getElementById('satisfaction-display').textContent = this.value + '%';
    });
    
    ['commit-expenses', 'commit-invest', 'commit-tithe', 'commit-emergency'].forEach(id => {
      document.getElementById(id).addEventListener('input', updateCommitmentTotal);
      document.getElementById(id).addEventListener('input', updateCommitmentValues);
      document.getElementById(id).addEventListener('input', () => {
        if (typeof loadIncomeHistory === 'function') loadIncomeHistory();
        if (typeof loadExpenseHistory === 'function') loadExpenseHistory();
      });
    });

    function sanitizeKey(name) {
      return name.replace(/\s+/g, '-').replace(/[^a-z0-9\-]/gi, '').toLowerCase();
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      const target = document.getElementById(`tab-${tabName}`);
      if (target) target.classList.remove('hidden');

      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      const btn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
      if (btn) btn.classList.add('active');

      if (tabName === 'finances') {
        if (typeof loadSalariesList === 'function') loadSalariesList();
        if (typeof loadIncomeHistory === 'function') loadIncomeHistory();
        if (typeof loadExpenseHistory === 'function') loadExpenseHistory();
      } else if (tabName === 'dashboard') {
        if (typeof updateDashboard === 'function') updateDashboard();
      }
    }

    async function loadSalariesList() {
      const el = document.getElementById('salaries-list');
      if (!el) return;
      if (!currentFamily) {
        el.innerHTML = '<p class="text-slate-500 text-center py-4">Selecione uma fam√≠lia</p>';
        return;
      }

      el.innerHTML = '<p class="text-slate-500 text-center py-4">Carregando sal√°rios...</p>';

      try {
        if (!currentUser) {
          el.innerHTML = '<p class="text-slate-500 text-center py-4">Fa√ßa login para ver seus sal√°rios</p>';
          return;
        }

        const query = db.collection('transactions')
          .where('familyId', '==', currentFamily)
          .where('type', '==', 'salary')
          .where('userId', '==', currentUser.uid);

        const snap = await query.get();
        if (snap.empty) {
          el.innerHTML = '<p class="text-slate-500 text-center py-4">Nenhum sal√°rio individual cadastrado</p>';
          return;
        }

        const html = [];
        snap.forEach(doc => {
          const s = doc.data();
          const monthly = (typeof calculateMonthlySalary === 'function') ? calculateMonthlySalary(s.amount, s.frequency) : (Number(s.amount) || 0);
          
          const expensesPercent = parseFloat(document.getElementById('commit-expenses').value) || 70;
          const investPercent = parseFloat(document.getElementById('commit-invest').value) || 20;
          const tithePercent = parseFloat(document.getElementById('commit-tithe').value) || 0;
          const emergencyPercent = parseFloat(document.getElementById('commit-emergency').value) || 0;
          
          const expensesAmount = monthly * (expensesPercent / 100);
          const investAmount = monthly * (investPercent / 100);
          const titheAmount = monthly * (tithePercent / 100);
          const emergencyAmount = monthly * (emergencyPercent / 100);
          
          html.push(`
            <div class="list-item">
              <div class="list-item-content">
                <p class="list-item-title">${s.description || 'Sal√°rio'} <span class="text-xs text-slate-400">(${s.frequency || 'mensal'})</span></p>
                <p class="list-item-subtitle">${s.startDate || ''}${s.endDate ? ' ‚Üí '+s.endDate : ''}</p>
              </div>
              <div class="list-item-actions">
                <button onclick="editTransaction('${doc.id}', 'salary')" class="list-item-btn" title="Editar">‚úèÔ∏è</button>
                <button onclick="deleteSalaryItem('${doc.id}')" class="list-item-btn" title="Excluir">üóëÔ∏è</button>
              </div>
            </div>
                   `);
        });

        el.innerHTML = html.join('');
      } catch (error) {
        console.error('Error loading salaries list:', error);
        el.innerHTML = '<p class="text-red-400 text-center py-4">Erro ao carregar sal√°rios</p>';
      }
    }

    if (typeof calculateMonthlySalary !== 'function') {
      function calculateMonthlySalary(amount, frequency) {
        const a = Number(amount) || 0;
        switch ((frequency || '').toLowerCase()) {
          case 'weekly': return a * 52 / 12;
          case 'biweekly': return a * 26 / 12;
          case 'monthly':
          default: return a;
        }
      }
    }

    if (typeof formatCurrency !== 'function') {
      function formatCurrency(value) {
        const n = Number(value) || 0;
        return n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      }
    }

    if (typeof formatDate !== 'function') {
      function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr + 'T00:00:00');
        return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
      }
    }

    function updateCommitmentTotal() {
      const expenses = parseFloat(document.getElementById('commit-expenses').value) || 0;
      const invest = parseFloat(document.getElementById('commit-invest').value) || 0;
      const tithe = parseFloat(document.getElementById('commit-tithe').value) || 0;
      const emergency = parseFloat(document.getElementById('commit-emergency').value) || 0;

      let customSum = 0;
      document.querySelectorAll('.commit-custom-percent').forEach(el => {
        customSum += parseFloat(el.value) || 0;
      });

      const total = expenses + invest + tithe + emergency + customSum;

      const totalEl = document.getElementById('commit-total');
      totalEl.textContent = total + '%';
      totalEl.className = total === 100 ? 'text-2xl font-bold text-emerald-400' : 'text-2xl font-bold text-red-400';
    }

    const investmentOptions = [
      { key: 'selic', label: 'SELIC', rate: 0.1075 },
      { key: 'cdi', label: 'CDI', rate: 0.10 },
      { key: 'ipca', label: 'Tesouro IPCA+', rate: 0.055 },
      { key: 'prefixado', label: 'Tesouro Prefixado', rate: 0.125 },
      { key: 'cdb', label: 'CDB', rate: 0.118 },
      { key: 'lci', label: 'LCI/LCA', rate: 0.102 },
      { key: 'fundos', label: 'Fundos Multimercado', rate: 0.1375 }
    ];

    function estimateMonthsToTarget(current, monthly, annualRate, target, maxMonths = 1200) {
      current = Number(current) || 0;
      monthly = Number(monthly) || 0;
      target = Number(target) || 0;
      if (current >= target) return 0;
      if (monthly <= 0 && (!annualRate || annualRate === 0)) return null;

      const r = Math.pow(1 + annualRate, 1 / 12) - 1;

      if (r === 0) {
        const months = Math.ceil((target - current) / monthly);
        return months > maxMonths ? null : months;
      }

      let balance = current;
      for (let m = 1; m <= maxMonths; m++) {
        balance = balance * (1 + r);
        balance += monthly;
        if (balance >= target) return m;
      }
      return null;
    }

    function formatMonths(m) {
      if (m === 0) return 'J√° alcan√ßado';
      if (m === null) return 'N/A';
      const years = Math.floor(m / 12);
      const months = m % 12;
      let parts = [];
      if (years > 0) parts.push(years + (years === 1 ? ' ano' : ' anos'));
      if (months > 0) parts.push(months + (months === 1 ? ' m√™s' : ' meses'));
      return parts.join(' e ');
    }

    function computeEstimatesForGoal(id) {
      const monthlyEl = document.getElementById(`goal-monthly-${id}`);
      const container = document.getElementById(`goal-estimates-${id}`);
      if (!container || !window._goalsCache || !window._goalsCache[id]) return;
      const monthly = Number(monthlyEl?.value) || 0;
      const { progress, target } = window._goalsCache[id];

      const rows = investmentOptions.map(opt => {
        const months = estimateMonthsToTarget(progress, monthly, opt.rate, target);
        return `
          <div class="flex items-center justify-between text-sm">
            <div>${opt.label}</div>
            <div class="text-right"><div class="font-semibold">${formatMonths(months)}</div></div>
          </div>
        `;
      }).join('');

      container.innerHTML = rows;
    }

    async function addToGoalProgress(id) {
      if (!currentFamily || !currentUser) return;
      const input = document.getElementById(`goal-add-${id}`);
      if (!input) return;
      const amount = Number(input.value) || 0;
      if (amount <= 0) {
        if (typeof showToast === 'function') showToast('‚ö†Ô∏è', 'Digite um valor v√°lido');
        return;
      }

      try {
        await db.collection('goals').doc(id).update({
          progress: firebase.firestore.FieldValue.increment(amount)
        });
        input.value = '';
        if (typeof showToast === 'function') showToast('‚úÖ', 'Valor adicionado √† meta');
        await loadGoalsList();
      } catch (error) {
        console.error('Error adding to goal progress:', error);
        if (typeof showToast === 'function') showToast('‚ùå', 'Erro ao atualizar meta');
      }
    }

    async function deleteGoal(id) {
      if (!id || !currentFamily || !currentUser) return;
      if (!confirm('Deseja realmente excluir essa meta? Esta a√ß√£o n√£o pode ser desfeita.')) return;
      try {
        await db.collection('goals').doc(id).delete();
        if (typeof showToast === 'function') showToast('‚úÖ', 'Meta exclu√≠da');
        await loadGoalsList();
        if (typeof loadCompletedGoals === 'function') loadCompletedGoals();
      } catch (error) {
        console.error('Error deleting goal:', error);
        if (typeof showToast === 'function') showToast('‚ùå', 'Erro ao excluir meta');
      }
    }

    async function completeGoal(id) {
      if (!id || !currentFamily || !currentUser) return;
      if (!confirm('Marcar meta como conclu√≠da?')) return;
      try {
        const doc = await db.collection('goals').doc(id).get();
        if (!doc.exists) {
          if (typeof showToast === 'function') showToast('‚ö†Ô∏è', 'Meta n√£o encontrada');
          return;
        }
        const data = doc.data();
        const completedAt = new Date().toISOString();
        await db.collection('goals_history').add({
          goalId: id,
          familyId: data.familyId || currentFamily,
          userId: data.userId || currentUser.uid,
          name: data.name || '',
          startDate: data.startDate || null,
          progress: Number(data.progress || 0),
          targetAmount: Number(data.targetAmount || 0),
          completedAt
        });
        await db.collection('goals').doc(id).update({ completed: true, completedAt });

        if (typeof showToast === 'function') showToast('‚úÖ', 'Meta marcada como conclu√≠da');
        await loadGoalsList();
        if (typeof loadCompletedGoals === 'function') loadCompletedGoals();
      } catch (error) {
        console.error('Error completing goal:', error);
        if (typeof showToast === 'function') showToast('‚ùå', 'Erro ao concluir meta');
      }
    }

    async function loadCompletedGoals() {
      if (!currentFamily || !currentUser) return;
      try {
        const histQuery = db.collection('goals_history')
          .where('familyId', '==', currentFamily)
          .where('userId', '==', currentUser.uid)
          .orderBy('completedAt', 'desc')
          .limit(50);
        const histSnap = await histQuery.get();
        const container = document.getElementById('completed-goals-list');
        const items = [];

        histSnap.forEach(doc => {
          const d = doc.data();
          const startText = d.startDate ? formatDate((d.startDate || '').split('T')[0]) : '‚Äî';
          const endText = d.completedAt ? formatDate((d.completedAt || '').split('T')[0]) : '‚Äî';
          items.push(`<div class="list-item"><div class="list-item-content"><p class="list-item-title">${d.name}</p><p class="list-item-subtitle">In√≠cio: ${startText} ‚Äî Conclus√£o: ${endText}</p></div><p class="list-item-value">${typeof formatCurrency === 'function' ? formatCurrency(d.progress) : d.progress}</p></div>`);
        });

        if (items.length === 0) {
          if (container) container.innerHTML = '<p class="text-slate-500">Nenhum objetivo conclu√≠do</p>';
        } else {
          if (container) container.innerHTML = items.join('');
        }
      } catch (error) {
        console.error('Error loading completed goals:', error);
      }
    }

    function useAllInvestmentForGoal(id) {
      const investAmount = Number(window._lastInvestAmount || 0);
      if (investAmount <= 0) {
        if (typeof showToast === 'function') showToast('‚ö†Ô∏è', 'Nenhum valor alocado para investimentos');
        return;
      }
      const goalsContainer = document.getElementById('goals-list');
      if (!goalsContainer) return;
      const goalItems = goalsContainer.querySelectorAll('[id^="goal-"]');
      goalItems.forEach(item => {
        const gid = item.id.replace('goal-', '');
        const monthlyInput = document.getElementById(`goal-monthly-${gid}`);
        if (!monthlyInput) return;
        if (gid === id) {
          monthlyInput.value = investAmount.toFixed(2);
          monthlyInput.dataset.userEdited = '';
        } else {
          monthlyInput.value = (0).toFixed(2);
          monthlyInput.dataset.userEdited = '1';
        }
        try { computeEstimatesForGoal(gid); } catch (e) {}
      });
    }

    async function updateCommitmentValues() {
      if (!currentFamily || !currentFamilyData) return;

      try {
        const salariesQuery = db.collection('transactions')
          .where('familyId', '==', currentFamily)
          .where('type', '==', 'salary')
          .where('userId', '==', currentUser.uid)
          .where('isActive', '==', true);

        const salariesSnap = await salariesQuery.get();
        let totalMonthlySalary = 0;

        const today = new Date().toISOString().split('T')[0];

        salariesSnap.forEach(doc => {
          const data = doc.data();
          const startOk = data.startDate <= today;
          const endOk = !data.endDate || data.endDate >= today;

          if (startOk && endOk) {
            totalMonthlySalary += calculateMonthlySalary(data.amount, data.frequency);
          }
        });

        const currentMonth = today.substring(0, 7);
        const incomeQuery = db.collection('transactions')
          .where('familyId', '==', currentFamily)
          .where('type', '==', 'income')
          .where('userId', '==', currentUser.uid);

        const incomeSnap = await incomeQuery.get();
        let totalMonthlyIncome = 0;

        incomeSnap.forEach(doc => {
          const data = doc.data();
          if (data.date && data.date.substring(0, 7) === currentMonth) {
            totalMonthlyIncome += Number(data.amount) || 0;
          }
        });

        const totalIncome = totalMonthlySalary + totalMonthlyIncome;

        const expenses = parseFloat(document.getElementById('commit-expenses').value) || 0;
        const invest = parseFloat(document.getElementById('commit-invest').value) || 0;
        const tithe = parseFloat(document.getElementById('commit-tithe').value) || 0;
        const emergency = parseFloat(document.getElementById('commit-emergency').value) || 0;

        document.getElementById('val-expenses').textContent = formatCurrency(totalIncome * expenses / 100);
        const investAmount = totalIncome * invest / 100;
        window._lastInvestAmount = investAmount;
        document.getElementById('val-invest').textContent = formatCurrency(investAmount);
        document.getElementById('val-tithe').textContent = formatCurrency(totalIncome * tithe / 100);
        document.getElementById('val-emergency').textContent = formatCurrency(totalIncome * emergency / 100);

        const goalsContainer = document.getElementById('goals-list');
        if (goalsContainer) {
          const goalItems = goalsContainer.querySelectorAll('[id^="goal-"]');
          const count = goalItems.length;
          if (count > 0) {
            const perGoal = investAmount / count;
            goalItems.forEach(item => {
              const id = item.id.replace('goal-', '');
              const monthlyInput = document.getElementById(`goal-monthly-${id}`);
              if (monthlyInput) {
                if (count === 1) {
                  monthlyInput.value = investAmount.toFixed(2);
                  monthlyInput.dataset.userEdited = '';
                } else {
                  if (!monthlyInput.dataset.userEdited) {
                    monthlyInput.value = perGoal.toFixed(2);
                  }
                }
                try { computeEstimatesForGoal(id); } catch (e) {}
              }
            });
          }
        }

        if (typeof updateDashboard === 'function') updateDashboard();
      } catch (error) {
        console.error('Error updating commitment values:', error);
      }
    }

    async function loadCommitmentLabels() {
      if (!currentFamily) return;
      try {
        const doc = await db.collection('finances').doc(`${currentFamily}_labels`).get();
        if (doc.exists) {
          commitmentLabels = { ...commitmentLabels, ...doc.data() };
        }
      } catch (error) {
        console.error('Error loading commitment labels:', error);
      }
    }

    async function saveCommitments() {
      if (!currentFamily || !currentFamilyData) return;

      const expenses = parseFloat(document.getElementById('commit-expenses').value) || 0;
      const invest = parseFloat(document.getElementById('commit-invest').value) || 0;
      const tithe = parseFloat(document.getElementById('commit-tithe').value) || 0;
      const emergency = parseFloat(document.getElementById('commit-emergency').value) || 0;

      const total = expenses + invest + tithe + emergency;
      if (Math.round(total) !== 100) {
        showToast('‚ö†Ô∏è', 'O total deve ser 100%');
        return;
      }

      try {
        await db.collection('finances').doc(`${currentFamily}_commitments_${currentUser.uid}`).set({
          familyId: currentFamily,
          expenses,
          invest,
          tithe,
          emergency,
          userId: currentUser.uid,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast('‚úÖ', 'Divis√£o salva!');
        await updateCommitmentValues();
        if (typeof loadIncomeHistory === 'function') await loadIncomeHistory();
        if (typeof loadExpenseHistory === 'function') await loadExpenseHistory();
      } catch (error) {
        showToast('‚ùå', 'Erro ao salvar');
        console.error('Error saving commitments:', error);
      }
    }

    function initTabsScrollIndicator() {
      // Tabs scroll functionality
    }

    function initBackToTop() {
      const backToTop = document.getElementById('back-to-top');
      if (!backToTop) return;
      
      function toggleBackToTop() {
        if (window.scrollY > 300) {
          backToTop.classList.add('visible');
        } else {
          backToTop.classList.remove('visible');
        }
      }
      
      function scrollToTop() {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      }
      
      backToTop.addEventListener('click', scrollToTop);
      window.addEventListener('scroll', toggleBackToTop);
      toggleBackToTop();
    }

    function hideBackToTop() {
      const backToTop = document.getElementById('back-to-top');
      if (backToTop) {
        backToTop.classList.remove('visible');
      }
    }

    function monthsBetweenInclusive(start, end) {
      const s = new Date(start + 'T00:00:00');
      const e = new Date(end + 'T00:00:00');
      let months = (e.getFullYear() - s.getFullYear()) * 12 + (e.getMonth() - s.getMonth()) + 1;
      return months > 0 ? months : 0;
    }

    function getCategoryLabel(cat) {
      const labels = {
        'moradia': 'üè† Moradia',
        'alimentacao': 'üçΩÔ∏è Alimenta√ß√£o',
        'transporte': 'üöó Transporte',
        'saude': 'üè• Sa√∫de',
        'educacao': 'üìö Educa√ß√£o',
        'lazer': 'üéÆ Lazer',
        'vestuario': 'üëï Vestu√°rio',
        'servicos': 'üì± Servi√ßos',
        'outros': 'üì¶ Outros'
      };
      return labels[cat] || cat;
    }

    async function downloadReport(startDate, endDate) {
      if (!currentFamily || !currentUser) {
        showToast('‚ö†Ô∏è', 'Selecione uma fam√≠lia primeiro');
        return;
      }

      try {
        showToast('‚è≥', 'Gerando relat√≥rio...');

        const scope = document.querySelector('input[name="report-scope"]:checked')?.value || 'individual';
        
        let queries = {
          salaries: db.collection('transactions').where('familyId', '==', currentFamily).where('type', '==', 'salary'),
          incomes: db.collection('transactions').where('familyId', '==', currentFamily).where('type', '==', 'income'),
          expenses: db.collection('transactions').where('familyId', '==', currentFamily).where('type', '==', 'expense')
        };

        if (scope === 'individual') {
          queries.salaries = queries.salaries.where('userId', '==', currentUser.uid);
          queries.incomes = queries.incomes.where('userId', '==', currentUser.uid);
          queries.expenses = queries.expenses.where('userId', '==', currentUser.uid);
        }

        const [salariesSnap, incomesSnap, expensesSnap] = await Promise.all([
          queries.salaries.get(),
          queries.incomes.get(),
          queries.expenses.get()
        ]);

        let csv = 'Tipo,Data,Descri√ß√£o,Categoria,Valor,Usu√°rio\n';

        const monthCount = monthsBetweenInclusive(startDate, endDate);
        salariesSnap.forEach(doc => {
          const s = doc.data();
          const startOk = s.startDate <= endDate;
          const endOk = !s.endDate || s.endDate >= startDate;
          if (startOk && endOk) {
            const monthly = calculateMonthlySalary(s.amount, s.frequency);
            const total = monthly * monthCount;
            csv += `"Sal√°rio","${startDate} a ${endDate}","${s.description}","${s.frequency}","${total.toFixed(2)}","${s.userName || s.userId}"\n`;
          }
        });

        incomesSnap.forEach(doc => {
          const d = doc.data();
          if (d.date >= startDate && d.date <= endDate) {
            csv += `"Entrada Extra","${d.date}","${d.description}","","${d.amount}","${d.userName || d.userId}"\n`;
          }
        });

        expensesSnap.forEach(doc => {
          const d = doc.data();
          if (d.date >= startDate && d.date <= endDate) {
            csv += `"Despesa","${d.date}","${d.description}","${d.category || 'Outros'}","${d.amount}","${d.userName || d.userId}"\n`;
          }
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `relatorio_${scope}_${startDate}_${endDate}.csv`;
        link.click();

        showToast('‚úÖ', 'Relat√≥rio baixado com sucesso!');
      } catch (error) {
        console.error('Download error:', error);
        showToast('‚ùå', 'Erro ao baixar relat√≥rio');
      }
    }

    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeAllModals();
      }
    });

    document.addEventListener('click', function(event) {
      const modals = ['generic-modal', 'delete-modal', 'photo-modal'];
      
      for (const modalId of modals) {
        const modal = document.getElementById(modalId);
        if (modal && !modal.classList.contains('hidden')) {
          if (event.target === modal) {
            closeAllModals();
            closeModal();
            break;
          }
        }
      }
    });

  </script>
 </body>
</html>